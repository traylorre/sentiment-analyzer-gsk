# Research: Workspace Bootstrap with Local Secrets Cache

**Feature**: 1194-workspace-bootstrap
**Date**: 2026-01-11

## Research Questions

### 1. Local Secret Encryption Tool Selection

**Decision**: Use `age` for local secret encryption

**Rationale**:
- Simple, modern encryption tool with no configuration complexity
- No key management required - generates identity file automatically
- Single binary, easy to install (`apt install age` or download from GitHub)
- Widely adopted in DevOps/security community
- File-based encryption, perfect for caching JSON secrets

**Alternatives Considered**:

| Tool | Pros | Cons | Rejected Because |
|------|------|------|------------------|
| GPG | Industry standard, widely installed | Complex key management, expiry issues | Too much setup friction for dev workflow |
| SOPS | Mozilla standard, multi-backend | Requires cloud KMS or GPG | Adds dependency on cloud service (defeats offline goal) |
| Ansible Vault | Built into Ansible | Requires Ansible installed | Unnecessary dependency |
| openssl enc | Always available | Manual key management, less secure defaults | age is purpose-built for this |

**Implementation**:
```bash
# Generate identity (one-time)
age-keygen -o ~/.config/sentiment-analyzer/age-identity.txt

# Encrypt secrets
age -e -i ~/.config/sentiment-analyzer/age-identity.txt \
    -o ~/.config/sentiment-analyzer/secrets.cache.age \
    secrets.json

# Decrypt secrets
age -d -i ~/.config/sentiment-analyzer/age-identity.txt \
    ~/.config/sentiment-analyzer/secrets.cache.age
```

### 2. Cache Storage Location

**Decision**: `~/.config/sentiment-analyzer/` directory

**Rationale**:
- Follows XDG Base Directory Specification for user config
- Outside repository, no risk of accidental commit
- User-scoped (not system-wide)
- Standard location for CLI tools

**Alternatives Considered**:
- `~/.sentiment-analyzer/` - Non-standard hidden dir
- `/tmp/` - Lost on reboot (not persistent)
- `~/.cache/` - XDG cache dir (semantically correct but cache implies deletable)

**Files in this directory**:
```
~/.config/sentiment-analyzer/
├── age-identity.txt      # age private key (600 permissions)
├── secrets.cache.age     # Encrypted secrets JSON (600 permissions)
└── cache-metadata.json   # TTL, fetch timestamp (readable)
```

### 3. Cache TTL and Expiry Mechanism

**Decision**: 30-day default TTL with metadata file

**Rationale**:
- 30 days matches AWS Secrets Manager rotation schedule (90 days / 3)
- Simple JSON metadata file tracks fetch timestamp
- Verification script checks expiry and warns user
- Force-refresh available via `--refresh` flag

**Implementation**:
```json
// cache-metadata.json
{
  "fetched_at": "2026-01-11T20:30:00Z",
  "ttl_days": 30,
  "expires_at": "2026-02-10T20:30:00Z",
  "secrets_version": "1.0",
  "environment": "dev"
}
```

### 4. .env.local Format and Content

**Decision**: Standard dotenv format with all secrets as environment variables

**Rationale**:
- Compatible with direnv, python-dotenv, source command
- Simple key=value format
- Can be loaded via `source .env.local` in bash or automatically by pytest

**Content**:
```bash
# .env.local - Generated by bootstrap-workspace.sh
# DO NOT COMMIT - This file is gitignored

# AWS Configuration
AWS_REGION=us-east-1

# Secrets from AWS Secrets Manager (dev environment)
DASHBOARD_API_KEY=xxx
TIINGO_API_KEY=xxx
FINNHUB_API_KEY=xxx
SENDGRID_API_KEY=xxx
HCAPTCHA_SECRET_KEY=xxx
HCAPTCHA_SITE_KEY=xxx

# Test Configuration
MAGIC_LINK_SECRET=local-dev-secret-at-least-32-characters-long

# Cache metadata
SECRETS_CACHE_PATH=~/.config/sentiment-analyzer/secrets.cache.age
SECRETS_FETCHED_AT=2026-01-11T20:30:00Z
```

### 5. Prerequisites Verification

**Decision**: Version-aware prerequisite checks with semantic versioning comparison

**Required Tools**:

| Tool | Minimum Version | Check Command | Install Instructions |
|------|-----------------|---------------|---------------------|
| Python | 3.12.0 | `python --version` | pyenv install 3.13.0 |
| AWS CLI | 2.0.0 | `aws --version` | curl + unzip installer |
| Terraform | 1.5.0 | `terraform --version` | HashiCorp apt repo |
| Node.js | 20.0.0 | `node --version` | nodesource setup script |
| Git | 2.30.0 | `git --version` | apt install git |
| jq | 1.6 | `jq --version` | apt install jq |
| age | 1.0.0 | `age --version` | apt install age |

**Optional Tools** (warn if missing, don't fail):
- Docker
- gitleaks
- pre-commit

### 6. Offline Development Support

**Decision**: Full offline capability after bootstrap

**How it works**:
1. Bootstrap fetches secrets once from AWS Secrets Manager
2. Secrets are encrypted locally with age
3. `.env.local` is generated with all values
4. Tests read from `.env.local` or environment variables
5. No AWS calls during normal development/testing

**Verification**:
```bash
# Test offline mode
unset AWS_ACCESS_KEY_ID AWS_SECRET_ACCESS_KEY
source .env.local
pytest  # Should pass without AWS access
```

### 7. Error Handling and User Experience

**Decision**: Clear, actionable error messages with remediation steps

**Error Categories**:

| Error | Message | Remediation |
|-------|---------|-------------|
| No AWS credentials | "AWS credentials not configured" | "Run: aws configure" |
| Expired credentials | "AWS credentials expired" | "Run: aws sso login" |
| Secret not found | "Secret 'tiingo' not found in Secrets Manager" | "Contact admin to provision secret" |
| age not installed | "age encryption tool not found" | "Run: sudo apt install age" |
| Cache expired | "Secrets cache expired (last fetched: X days ago)" | "Run: ./scripts/refresh-secrets-cache.sh" |

## Security Considerations

1. **Identity file protection**: `chmod 600` on age-identity.txt
2. **Cache file protection**: `chmod 600` on secrets.cache.age
3. **No secrets in logs**: Scripts use `set +x` when handling secrets
4. **No secrets in error messages**: Only reference secret names, not values
5. **Gitignore verification**: Script verifies `.env.local` is in gitignore before writing

## Integration with Existing Infrastructure

- **AWS Secrets Manager**: Uses existing `dev/sentiment-analyzer/*` secret paths
- **Terraform**: No changes to infrastructure
- **CI/CD**: No impact - CI uses GitHub environment secrets
- **Tests**: Tests already support environment variables via conftest.py

## Next Steps

Phase 1 artifacts ready to generate:
- quickstart.md (developer quick start guide)
- No data-model.md needed (no entities stored in database)
- No contracts/ needed (no APIs exposed)
