# Implementation Plan: 095-iam-user-resource-pattern

**Branch**: `095-iam-user-resource-pattern` | **Date**: 2025-12-12 | **Spec**: [spec.md](./spec.md)
**Input**: Feature specification from `/specs/095-iam-user-resource-pattern/spec.md`

## Summary

Fix IAM policy resource constraint pattern mismatch that blocks Deploy Pipeline. The pattern `*-sentiment-deployer` doesn't match actual user names `sentiment-analyzer-*-deployer`.

## Technical Context

**Language/Version**: Terraform (HCL) with AWS Provider ~> 5.0
**Primary Dependencies**: AWS IAM
**Storage**: N/A (IAM configuration only)
**Testing**: terraform plan, terraform apply, Deploy Pipeline verification
**Target Platform**: AWS IAM
**Project Type**: Infrastructure-as-code fix
**Performance Goals**: N/A
**Constraints**: Resource pattern must match existing AWS IAM user names
**Scale/Scope**: 1 string replacement in 1 file

## Constitution Check

*GATE: Must pass before Phase 0 research. Re-check after Phase 1 design.*

| Gate | Status | Notes |
|------|--------|-------|
| IAM least-privilege | PASS | No permission changes, only resource pattern fix |
| Infrastructure-as-code | PASS | Change via Terraform, not manual |
| GPG-signed commits | REQUIRED | Will sign commit |
| No pipeline bypass | REQUIRED | Will wait for CI to pass |
| TLS/Secrets | N/A | No secrets involved |

**All gates pass. No violations to justify.**

## Project Structure

### Documentation (this feature)

```text
specs/095-iam-user-resource-pattern/
├── plan.md              # This file
├── spec.md              # Feature specification
└── tasks.md             # Generated by /speckit.tasks
```

### Source Code (affected files)

```text
infrastructure/terraform/
└── ci-user-policy.tf    # Line 640: Resource pattern
                         # Line 630: Comment update
```

**Structure Decision**: Single file edit - 1 string replacement + comment update.

## Phase 0: Research

### Research Summary

No external research required. Root cause fully identified:

| Item | Finding |
|------|---------|
| Current pattern | `*-sentiment-deployer` (expects `preprod-sentiment-deployer`) |
| Actual users | `sentiment-analyzer-preprod-deployer`, `sentiment-analyzer-prod-deployer` |
| Required pattern | `sentiment-analyzer-*-deployer` |
| Verification | Error message explicitly shows user ARN and failed permission |

### Decision Record

**Decision**: Update resource pattern from `*-sentiment-deployer` to `sentiment-analyzer-*-deployer`.

**Rationale**: The pattern must match the actual AWS IAM user names exactly for the permission to be granted.

**Alternatives Considered**:
1. ~~Rename AWS IAM users~~ - Would require credential rotation, more disruptive
2. ~~Use wildcard `*deployer`~~ - Too permissive, violates least-privilege

## Phase 1: Implementation Design

### Changes Required

| Location | Current Value | New Value |
|----------|---------------|-----------|
| Line 640 | `"arn:aws:iam::*:user/*-sentiment-deployer"` | `"arn:aws:iam::*:user/sentiment-analyzer-*-deployer"` |
| Line 630 | `# Updated from sentiment-analyzer-*-deployer to *-sentiment-deployer per 090-security-first-burndown` | `# Pattern: sentiment-analyzer-*-deployer (preprod, prod)` |

### Verification Plan

1. `terraform fmt` - Format check
2. `terraform validate` - Syntax check
3. Re-trigger Deploy Pipeline after push
4. Terraform plan should succeed (no IAM errors)
5. Terraform apply should succeed

### Data Model

N/A - No data model changes required.

### Contracts

N/A - No API contracts involved.

### Quickstart

```bash
# Verify the fix addresses the specific error
grep -n "sentiment-deployer" infrastructure/terraform/ci-user-policy.tf

# After merge, verify pipeline passes
gh run watch --repo traylorre/sentiment-analyzer-gsk
```

## Complexity Tracking

No complexity violations. This is a minimal string pattern fix.

## Next Step

Run `/speckit.clarify` for second pass, then `/speckit.tasks` to generate implementation tasks.
