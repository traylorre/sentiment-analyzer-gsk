# Implementation Plan: OHLC Resolution Selector

**Branch**: `1035-ohlc-resolution-selector` | **Date**: 2025-12-23 | **Spec**: [spec.md](./spec.md)
**Input**: Feature specification from `/specs/1035-ohlc-resolution-selector/spec.md`

## Summary

Add intraday resolution selection to the OHLC candlestick chart, enabling users to view price data at 1-minute, 5-minute, 15-minute, 30-minute, 1-hour, or daily granularity. The implementation extends the existing OHLC endpoint to accept a resolution parameter, leverages Finnhub's intraday data support, and adds a resolution selector UI matching the existing time range button pattern.

## Technical Context

**Language/Version**: Python 3.13 (backend Lambda), TypeScript 5 / React 18 (frontend)
**Primary Dependencies**: FastAPI (backend routing), lightweight-charts 5.0.9 (charting), React Query (data fetching)
**Storage**: Session storage for resolution preference (browser-side only)
**Testing**: pytest (backend), Jest/React Testing Library (frontend)
**Target Platform**: AWS Lambda (backend), Next.js 14.2 (frontend)
**Project Type**: Web application (backend + frontend)
**Performance Goals**: Chart update within 3 seconds of resolution change (per spec SC-001)
**Constraints**: Finnhub rate limit 60 calls/min, auto-limit time range per resolution to prevent excessive data
**Scale/Scope**: Single feature affecting 4 backend files, 4 frontend files

## Constitution Check

*GATE: Must pass before Phase 0 research. Re-check after Phase 1 design.*

| Gate | Status | Notes |
|------|--------|-------|
| External API mocking (Section 7) | ✅ PASS | Finnhub API will be mocked in all tests except canary |
| Unit tests accompany code (Section 7) | ✅ PASS | Unit tests required for all changes |
| Deterministic time handling (Amendment 1.5) | ✅ PASS | Will use fixed dates in tests |
| GPG-signed commits (Section 8) | ✅ PASS | Standard workflow |
| No pipeline bypass (Section 8) | ✅ PASS | Standard workflow |
| SAST before push (Amendment 1.6) | ✅ PASS | `make validate` includes SAST |

**Post-Design Re-check**: All gates still pass. No violations.

## Project Structure

### Documentation (this feature)

```text
specs/1035-ohlc-resolution-selector/
├── spec.md              # Feature specification
├── plan.md              # This file
├── research.md          # Technical research findings
├── data-model.md        # Entity definitions
├── quickstart.md        # Usage guide
├── contracts/
│   └── ohlc-api.yaml    # OpenAPI contract
├── checklists/
│   └── requirements.md  # Spec quality checklist
└── tasks.md             # Implementation tasks (next phase)
```

### Source Code (repository root)

```text
# Backend (Lambda handlers)
src/lambdas/
├── dashboard/
│   └── ohlc.py                    # MODIFY: Add resolution parameter
├── shared/
│   ├── adapters/
│   │   └── finnhub.py             # MODIFY: Parameterize resolution
│   └── models/
│       └── ohlc.py                # MODIFY: Add OHLCResolution enum

# Frontend (Next.js/React)
frontend/src/
├── components/charts/
│   └── price-sentiment-chart.tsx  # MODIFY: Add resolution selector UI
├── hooks/
│   └── use-chart-data.ts          # MODIFY: Accept resolution parameter
├── lib/api/
│   └── ohlc.ts                    # MODIFY: Add resolution to API params
└── types/
    └── chart.ts                   # MODIFY: Add OHLCResolution type

# Tests
tests/unit/lambdas/dashboard/
└── test_ohlc.py                   # ADD: Resolution parameter tests
frontend/src/__tests__/
└── resolution-selector.test.tsx   # ADD: UI component tests
```

**Structure Decision**: Existing web application structure with backend (Lambda) and frontend (Next.js) separation. All changes extend existing files rather than creating new modules.

## Complexity Tracking

No violations to justify. Feature follows existing patterns and extends rather than replaces.

## Phase Artifacts

### Phase 0: Research
- [x] research.md - Technical decisions and findings

### Phase 1: Design & Contracts
- [x] data-model.md - OHLCResolution entity, extended OHLCResponse
- [x] contracts/ohlc-api.yaml - OpenAPI 3.0 contract with resolution parameter
- [x] quickstart.md - Usage guide and examples

### Phase 2: Tasks (Next Command)
- [ ] tasks.md - To be generated by `/speckit.tasks`

## Implementation Phases

### Backend Changes (Priority 1)

1. **Add OHLCResolution enum** (`src/lambdas/shared/models/ohlc.py`)
   - New enum with values: ONE_MINUTE, FIVE_MINUTES, etc.
   - Maps to Finnhub values: "1", "5", "15", "30", "60", "D"
   - Include max_days property for time range limits

2. **Update Finnhub adapter** (`src/lambdas/shared/adapters/finnhub.py`)
   - Add resolution parameter to `get_ohlc()` method
   - Replace hardcoded `"D"` with dynamic value
   - Update cache key to include resolution

3. **Update OHLC endpoint** (`src/lambdas/dashboard/ohlc.py`)
   - Add resolution query parameter
   - Validate resolution against enum
   - Apply time range limits based on resolution
   - Return resolution in response

### Frontend Changes (Priority 2)

1. **Add TypeScript types** (`frontend/src/types/chart.ts`)
   - Add OHLCResolution type
   - Update OHLCParams interface
   - Update OHLCResponse interface

2. **Update API client** (`frontend/src/lib/api/ohlc.ts`)
   - Add resolution to fetchOHLCData params
   - Include resolution in API request

3. **Update hook** (`frontend/src/hooks/use-chart-data.ts`)
   - Accept resolution parameter
   - Include resolution in query key
   - Pass resolution to fetchOHLCData

4. **Add resolution selector** (`frontend/src/components/charts/price-sentiment-chart.tsx`)
   - Add resolution state with sessionStorage persistence
   - Create resolution button group (matches time range pattern)
   - Wire resolution to useChartData

### Testing (Priority 3)

1. **Backend unit tests**
   - Resolution enum validation
   - Finnhub adapter with resolution
   - OHLC endpoint parameter handling
   - Time range limiting logic

2. **Frontend component tests**
   - Resolution selector rendering
   - Resolution change triggers refetch
   - Preference persistence

## Dependencies

- Feature 1009 (Multi-Resolution Sentiment): Reference for Resolution enum pattern
- Existing PriceSentimentChart: UI pattern for selector buttons
- Finnhub API: Data source with resolution support

## Risk Mitigation

| Risk | Mitigation |
|------|------------|
| Finnhub rate limiting | Cache with appropriate TTL, debounce rapid resolution changes |
| Intraday data unavailable | Graceful fallback to daily with user notification |
| Large data sets | Auto-limit time range based on resolution |

## Next Steps

1. Run `/speckit.tasks` to generate detailed task list
2. Implement backend changes first (enables frontend development)
3. Implement frontend changes
4. Add tests throughout implementation
5. Run `make validate` before committing
