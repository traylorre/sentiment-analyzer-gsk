# Feature Specification: Add JWT_SECRET to Lambda Terraform Configuration

**Feature Branch**: `1054-add-jwt-secret-terraform`
**Created**: 2025-12-24
**Status**: Draft
**Input**: Add JWT_SECRET environment variable to Dashboard and SSE Lambda functions in Terraform for preprod and prod environments.

## Problem Statement

Feature 1053 added JWT authentication infrastructure for E2E tests, but the Lambda functions don't have the JWT_SECRET environment variable configured. Without this, the auth middleware cannot validate JWT tokens, causing E2E tests to fail with authentication errors.

**Root Cause**: The Dashboard and SSE Lambda functions need JWT_SECRET to validate bearer tokens generated by E2E tests using `create_test_jwt()`.

## User Scenarios & Testing *(mandatory)*

### User Story 1 - E2E Tests Authenticate Successfully (Priority: P0)

As a developer, I want E2E tests to authenticate via JWT tokens against preprod, so that authenticated endpoint tests pass in CI.

**Why this priority**: Blocking all deployments - E2E tests fail without JWT validation.

**Independent Test**: Run `pytest tests/e2e/test_alerts.py -v` against preprod and verify tests pass with 201/200 responses instead of 403.

**Acceptance Scenarios**:

1. **Given** a preprod Lambda with JWT_SECRET configured, **When** an E2E test sends a valid JWT bearer token, **Then** the auth middleware validates it and returns AuthType.AUTHENTICATED
2. **Given** a preprod Lambda with JWT_SECRET configured, **When** an E2E test sends an invalid/expired JWT, **Then** the auth middleware rejects it with 401

---

### User Story 2 - Production JWT Support (Priority: P1)

As a platform operator, I want prod Lambdas to have JWT_SECRET configured, so that future production JWT authentication works.

**Why this priority**: Prepares production for authenticated users without separate deployment.

**Independent Test**: Verify prod Lambda has JWT_SECRET environment variable after terraform apply.

**Acceptance Scenarios**:

1. **Given** prod Lambda configuration, **When** terraform apply runs, **Then** JWT_SECRET is set in Lambda environment
2. **Given** prod Lambda with JWT_SECRET, **When** a valid JWT is sent, **Then** authentication succeeds

---

### Edge Cases

- What if JWT_SECRET differs between preprod and prod? Tokens are environment-specific; E2E tests use preprod secret only.
- What if JWT_SECRET is empty/missing? Auth middleware should reject tokens gracefully with 401.

## Requirements *(mandatory)*

### Functional Requirements

- **FR-001**: Dashboard Lambda MUST have JWT_SECRET environment variable in preprod
- **FR-002**: SSE Lambda MUST have JWT_SECRET environment variable in preprod
- **FR-003**: Dashboard Lambda MUST have JWT_SECRET environment variable in prod
- **FR-004**: SSE Lambda MUST have JWT_SECRET environment variable in prod
- **FR-005**: JWT_SECRET value for preprod MUST match PREPROD_TEST_JWT_SECRET used by E2E tests
- **FR-006**: JWT_SECRET SHOULD be managed via Terraform variables (not hardcoded)

### Non-Functional Requirements

- **NFR-001**: No secrets exposed in Terraform state or logs (use sensitive = true)
- **NFR-002**: Change requires terraform plan/apply cycle only (no code changes)

### Key Entities

- **JWT_SECRET**: Environment variable containing the secret key for JWT token validation
- **Terraform Variable**: `jwt_secret` variable with sensitive flag

## Success Criteria *(mandatory)*

### Measurable Outcomes

- **SC-001**: E2E tests in tests/e2e/test_alerts.py pass against preprod (0 failures from JWT auth)
- **SC-002**: Deploy pipeline reaches production (preprod integration tests pass)
- **SC-003**: `terraform plan` shows JWT_SECRET added to both Dashboard and SSE Lambda functions
- **SC-004**: No JWT_SECRET value appears in terraform plan output (marked sensitive)

## Technical Approach

Add JWT_SECRET to the Lambda environment variable blocks in `infrastructure/terraform/main.tf`:
- Lines ~403-423 (Dashboard Lambda)
- Lines ~731-745 (SSE Lambda)

Create a new Terraform variable `jwt_secret` with:
- Type: string
- Sensitive: true
- Default: Empty (must be provided)

Add to tfvars files:
- preprod.tfvars: Set to match E2E test default
- prod.tfvars: Set to production-specific value

## Assumptions

- The auth middleware already reads JWT_SECRET from environment variables
- E2E tests use default secret `test-jwt-secret-for-e2e-only-not-production`
- Production will use a different, stronger secret

## Dependencies

- Feature 1053 (already merged) - JWT authentication infrastructure in E2E tests

## Out of Scope

- Changes to auth middleware code
- AWS Secrets Manager integration for JWT_SECRET (future improvement)
- JWT key rotation
