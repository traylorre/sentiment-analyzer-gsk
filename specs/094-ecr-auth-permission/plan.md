# Implementation Plan: 094-ecr-auth-permission

**Branch**: `094-ecr-auth-permission` | **Date**: 2025-12-12 | **Spec**: [spec.md](./spec.md)
**Input**: Feature specification from `/specs/094-ecr-auth-permission/spec.md`

## Summary

Fix IAM user name mismatch in Terraform policy attachments that is blocking the Deploy Pipeline. The policy attachments reference `preprod-sentiment-deployer` and `prod-sentiment-deployer`, but the actual AWS IAM users are `sentiment-analyzer-preprod-deployer` and `sentiment-analyzer-prod-deployer`.

## Technical Context

**Language/Version**: Terraform (HCL) with AWS Provider ~> 5.0
**Primary Dependencies**: AWS IAM, aws_iam_user_policy_attachment resources
**Storage**: N/A (IAM configuration only)
**Testing**: terraform plan, terraform apply, Deploy Pipeline verification
**Target Platform**: AWS IAM
**Project Type**: Infrastructure-as-code fix
**Performance Goals**: N/A
**Constraints**: User names must match exactly between Terraform and AWS
**Scale/Scope**: 8 policy attachment resources (4 preprod + 4 prod)

## Constitution Check

*GATE: Must pass before Phase 0 research. Re-check after Phase 1 design.*

| Gate | Status | Notes |
|------|--------|-------|
| IAM least-privilege | PASS | No permission changes, only user name fix |
| Infrastructure-as-code | PASS | Change via Terraform, not manual |
| GPG-signed commits | REQUIRED | Will sign commit |
| No pipeline bypass | REQUIRED | Will wait for CI to pass |
| TLS/Secrets | N/A | No secrets involved |

**All gates pass. No violations to justify.**

## Project Structure

### Documentation (this feature)

```text
specs/094-ecr-auth-permission/
├── plan.md              # This file
├── spec.md              # Feature specification
└── tasks.md             # Generated by /speckit.tasks
```

### Source Code (affected files)

```text
infrastructure/terraform/
└── ci-user-policy.tf    # Lines 1142-1186: Policy attachments
```

**Structure Decision**: Single file edit - 8 string replacements in `ci-user-policy.tf`.

## Phase 0: Research

### Research Summary

No external research required. Root cause fully identified:

| Item | Finding |
|------|---------|
| User name pattern | AWS uses `sentiment-analyzer-{env}-deployer` |
| Terraform pattern | Uses `{env}-sentiment-deployer` (incorrect) |
| Verification | Confirmed via `aws iam list-users` |

### Decision Record

**Decision**: Update all 8 policy attachment user references to match AWS IAM user names.

**Rationale**: The Terraform user attribute must exactly match the AWS IAM user name for policy attachment to work.

**Alternatives Considered**:
1. ~~Rename AWS IAM users~~ - Requires credential rotation, more disruptive
2. ~~Create new users~~ - Unnecessary, users exist and are correct

## Phase 1: Implementation Design

### Changes Required

| Resource | Current Value | New Value |
|----------|---------------|-----------|
| `ci_deploy_core_preprod` | `preprod-sentiment-deployer` | `sentiment-analyzer-preprod-deployer` |
| `ci_deploy_monitoring_preprod` | `preprod-sentiment-deployer` | `sentiment-analyzer-preprod-deployer` |
| `ci_deploy_storage_preprod` | `preprod-sentiment-deployer` | `sentiment-analyzer-preprod-deployer` |
| `ci_deploy_iam_preprod` | `preprod-sentiment-deployer` | `sentiment-analyzer-preprod-deployer` |
| `ci_deploy_core_prod` | `prod-sentiment-deployer` | `sentiment-analyzer-prod-deployer` |
| `ci_deploy_monitoring_prod` | `prod-sentiment-deployer` | `sentiment-analyzer-prod-deployer` |
| `ci_deploy_storage_prod` | `prod-sentiment-deployer` | `sentiment-analyzer-prod-deployer` |
| `ci_deploy_iam_prod` | `prod-sentiment-deployer` | `sentiment-analyzer-prod-deployer` |

### Verification Plan

1. `terraform plan` - Should show 8 policy attachment changes
2. `terraform apply` - Apply via TFC (auto-triggered by merge)
3. Re-run Deploy Pipeline - Should pass ECR login step

### Data Model

N/A - No data model changes required.

### Contracts

N/A - No API contracts involved.

### Quickstart

```bash
# Verify current user names in AWS
aws iam list-users --query "Users[?contains(UserName, 'deployer')].UserName"

# After merge, verify in TFC
# 1. Check terraform plan shows 8 attachment updates
# 2. Verify apply succeeds
# 3. Re-trigger Deploy Pipeline
```

## Complexity Tracking

No complexity violations. This is a minimal string replacement fix.

## Next Step

Run `/speckit.clarify` for second pass, then `/speckit.tasks` to generate implementation tasks.
