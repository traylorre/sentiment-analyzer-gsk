# Implementation Plan: OHLC Intraday Resolution Support via Tiingo IEX

**Branch**: `1055-ohlc-resolution-selector` | **Date**: 2025-12-26 | **Spec**: [spec.md](./spec.md)
**Input**: Feature specification from `/specs/1055-ohlc-resolution-selector/spec.md`

## Summary

Enable intraday OHLC resolutions (1m, 5m, 15m, 30m, 1h) by adding Tiingo IEX endpoint support to the TiingoAdapter. Currently, intraday requests fall back to daily because Finnhub's free tier doesn't include stock candles. Tiingo IEX endpoint has been verified working with our existing API key.

## Technical Context

**Language/Version**: Python 3.13
**Primary Dependencies**: httpx (existing), boto3 (existing for secrets)
**Storage**: N/A (external API data, caching via existing mechanism)
**Testing**: pytest with moto mocks
**Target Platform**: AWS Lambda
**Project Type**: Single project (Lambda-based API)
**Performance Goals**: <2s response time, <100ms for cached responses
**Constraints**: 5-minute cache TTL for intraday data, time range limits per resolution

## Constitution Check

*GATE: Must pass before Phase 0 research. Re-check after Phase 1 design.*

- [X] No new external dependencies (using existing httpx)
- [X] No new infrastructure (using existing Tiingo API key)
- [X] Code change only (adapter + handler modification)
- [X] Tests required (unit tests for new adapter method)

## Project Structure

### Documentation (this feature)

```text
specs/1055-ohlc-resolution-selector/
├── spec.md              # Feature specification
├── plan.md              # This file
├── research.md          # N/A - no research needed (verified via testing)
├── data-model.md        # N/A - using existing models
├── quickstart.md        # N/A - no new integration scenarios
├── contracts/           # N/A - existing endpoint, adding parameter support
├── checklists/          # Specification quality checklist
│   └── requirements.md
└── tasks.md             # Generated by /speckit.tasks
```

### Source Code (repository root)

```text
src/lambdas/shared/adapters/
├── tiingo.py            # MODIFY: Add get_intraday_ohlc() method
└── finnhub.py           # No changes (kept for news sentiment)

src/lambdas/dashboard/
└── ohlc.py              # MODIFY: Route intraday to Tiingo instead of Finnhub

tests/unit/shared/adapters/
└── test_tiingo_adapter.py  # ADD: Tests for get_intraday_ohlc()
```

**Structure Decision**: Single project - modifying existing adapter and handler in Lambda codebase.

## Implementation Approach

### Phase 1: Add Tiingo IEX Intraday Method

1. Add `get_intraday_ohlc(ticker, start_date, end_date, resolution)` to TiingoAdapter
2. Map resolution enum to Tiingo resampleFreq format:
   - '1' → '1min', '5' → '5min', '15' → '15min', '30' → '30min', '60' → '1hour'
3. Parse IEX response format (date, open, high, low, close, volume)
4. Use existing PriceCandle model from OHLCCandle

### Phase 2: Update OHLC Handler

1. Modify `get_ohlc_data()` in ohlc.py to use TiingoAdapter for ALL resolutions
2. For intraday (1, 5, 15, 30, 60): Call `tiingo.get_intraday_ohlc()`
3. For daily (D): Keep existing `tiingo.get_ohlc()` call
4. Remove Finnhub dependency for OHLC (keep for news/sentiment if used)
5. Set source="tiingo" in response

### Phase 3: Add Unit Tests

1. Test `get_intraday_ohlc()` with mocked API responses
2. Test resolution mapping (1 → 1min, etc.)
3. Test empty data handling (fallback to daily)
4. Test error handling (API failures)

## Risk Assessment

| Risk | Mitigation |
|------|------------|
| Tiingo IEX rate limiting | Use existing 5-minute cache TTL |
| IEX doesn't cover all tickers | Fall back to daily with message |
| API response format changes | Validate response structure |

## Dependencies

- No new dependencies required
- Uses existing Tiingo API key (already in Secrets Manager)
- Uses existing httpx client in TiingoAdapter
