# Feature Specification: Next.js Frontend Migration via AWS Amplify SSR

**Feature ID**: 1105
**Feature Branch**: `1105-nextjs-migration`
**Created**: 2025-12-29
**Revised**: 2025-12-29 (Critical review v3: All 4 gaps resolved with decisions)
**Status**: Ready for Implementation
**Priority**: P0 - Critical (Blocking demo-ability)

---

## Revision History

| Date | Change | Reason |
|------|--------|--------|
| 2025-12-29 | Initial spec with `output: 'export'` | Original proposal |
| 2025-12-29 | **REVISED**: Switch to AWS Amplify SSR | Static export incompatible with middleware, auth, useSearchParams |
| 2025-12-29 | **CRITICAL REVIEW v2**: Identified 4 design gaps | Deep review found buildspec, routing, OAuth, auth flaws |
| 2025-12-29 | **CRITICAL REVIEW v3**: All 4 gaps resolved | Principal engineer review with decisions documented |

---

## Executive Summary

The dashboard has **two duplicate frontend implementations**:
1. **Vanilla JS** (`/src/dashboard/`) - Chart.js based, currently deployed, **broken pan/scroll**
2. **Next.js** (`/frontend/`) - lightweight-charts based, NOT deployed, **fully functional**

**Original Plan**: Static export to S3 (`output: 'export'`)
**Revised Plan**: AWS Amplify Hosting with SSR mode

**Why the change**: Next.js frontend uses middleware, `useSearchParams`, `useRouter`, and runtime authâ€”none of which work with static export.

---

## CRITICAL REVIEW v3: Design Gaps RESOLVED (2025-12-29)

Deep architectural review identified **4 design gaps**. All have been analyzed and resolved.

### Gap 1: Buildspec YAML Format Invalid âœ… RESOLVED

**Problem:** Two conflicting buildspec definitions exist:
- `frontend/amplify.yml` (wrong nested structure)
- Terraform `build_spec` inline (correct structure)

**Root Cause:** Configuration drift between file and Terraform. If someone removes Terraform's `build_spec` or runs Amplify CLI, the wrong file becomes active.

**Decision: Option A â€” Terraform Owns Build Configuration**
- DELETE `frontend/amplify.yml` entirely
- Terraform is the single source of truth (IaC-first project)
- Correct Terraform structure:

```hcl
build_spec = <<-EOT
  version: 1
  applications:
    - appRoot: frontend
      frontend:
        phases:
          preBuild:
            commands:
              - npm ci
          build:
            commands:
              - npm run build
        artifacts:
          baseDirectory: .next
          files:
            - '**/*'
        cache:
          paths:
            - node_modules/**/*
            - .next/cache/**/*
EOT
```

### Gap 2: SPA Fallback Rule Breaks Next.js SSR âœ… RESOLVED

**Problem:** The `404-200` rule intercepts requests at CloudFront BEFORE Lambda@Edge can process them, breaking:
- Next.js middleware (auth redirects never execute)
- Dynamic routes (`/dashboard/AAPL` â†’ `/index.html`)
- Magic link verification (tokens lost)
- Security headers (middleware never applies them)
- SEO (Googlebot sees empty shell)

**Root Cause:** This is a legacy SPA pattern (2015-2022) incompatible with SSR. Next.js SSR uses Lambda@Edge for server-side routing.

**Decision: Delete the 404-200 Rule**

```hcl
# DELETE this block entirely:
# custom_rule {
#   source = "/<*>"
#   status = "404-200"
#   target = "/index.html"
# }

# KEEP only the www redirect:
custom_rule {
  source = "https://www.<*>"
  status = "301"
  target = "https://<*>"
}
```

### Gap 3: OAuth Callback Hardcoded to Localhost âœ… RESOLVED

**Problem:** Circular Terraform dependency:
- Cognito needs Amplify URL for `callback_urls`
- Amplify needs Cognito credentials for env vars
- Neither can be created first

**Root Cause:** Classic IaC bootstrapping problem. Amplify URL is generated by AWS, unknown until after creation.

**Decision: `terraform_data` + `lifecycle { ignore_changes }` Pattern**

```hcl
# 1. Cognito client - NO reference to Amplify (breaks cycle)
resource "aws_cognito_user_pool_client" "dashboard" {
  name         = "${var.environment}-dashboard"
  user_pool_id = aws_cognito_user_pool.main.id

  # Start with localhost only
  callback_urls = ["http://localhost:3000/auth/callback"]
  logout_urls   = ["http://localhost:3000"]

  lifecycle {
    ignore_changes = [callback_urls, logout_urls]
  }
}

# 2. Amplify - references Cognito (one-way dependency)
module "amplify_frontend" {
  cognito_client_id = aws_cognito_user_pool_client.dashboard.id
  # ...
}

# 3. Patch Cognito with Amplify URL (runs AFTER both exist)
resource "terraform_data" "cognito_callback_patch" {
  count = var.enable_amplify ? 1 : 0

  triggers_replace = {
    amplify_url = module.amplify_frontend[0].production_url
  }

  provisioner "local-exec" {
    command = <<-EOT
      aws cognito-idp update-user-pool-client \
        --user-pool-id ${aws_cognito_user_pool.main.id} \
        --client-id ${aws_cognito_user_pool_client.dashboard.id} \
        --callback-urls \
          "http://localhost:3000/auth/callback" \
          "${module.amplify_frontend[0].production_url}/auth/callback" \
        --logout-urls \
          "http://localhost:3000" \
          "${module.amplify_frontend[0].production_url}"
    EOT
  }
}
```

**Production Endgame:** Custom domain (`app.sentimentanalyzer.com`) eliminates the cycle entirelyâ€”domain is known before any resource is created.

### Gap 4: SSE Auth via URL Query Param âœ… RESOLVED

**Problem:** Token in URL is logged everywhere:
- CloudFront access logs (`cs-uri-query`)
- API Gateway logs
- Lambda function logs
- Browser history (synced to cloud)
- DevTools Network tab
- Referer header leakage
- Corporate proxy logs

**Root Cause:** Misconception that "EventSource doesn't support headers."
- TRUE: EventSource doesn't support custom headers like `Authorization`
- FALSE: EventSource doesn't support auth. **Cookies are sent automatically.**

**Decision: Same-Origin Proxy (Option A)**

Route SSE through Next.js API route so cookies work natively (same origin):

```
Frontend â†’ /api/sse/stream (same origin, cookie sent) â†’ Lambda
```

**Implementation:**

```typescript
// frontend/src/app/api/sse/[...path]/route.ts
export async function GET(request: Request) {
  // Cookie sent automatically (same origin)
  const token = request.cookies.get('sentiment-access-token')?.value;

  if (!token) {
    return new Response('Unauthorized', { status: 401 });
  }

  // Server-to-server call (can use headers)
  const upstream = await fetch(`${process.env.SSE_LAMBDA_URL}/stream`, {
    headers: {
      'Authorization': `Bearer ${token}`,
      'Accept': 'text/event-stream'
    }
  });

  // Stream response back to client
  return new Response(upstream.body, {
    headers: {
      'Content-Type': 'text/event-stream',
      'Cache-Control': 'no-cache',
      'Connection': 'keep-alive'
    }
  });
}
```

**Frontend change:**
```typescript
// Before (token in URL - WRONG)
const url = `${SSE_URL}/stream?user_token=${token}`;

// After (same-origin proxy - CORRECT)
const url = '/api/sse/stream';  // Cookie sent automatically
```

**Security properties:**
- Token never in URL (not logged anywhere)
- HttpOnly cookie (XSS can't steal)
- Same-origin (no CORS complexity)
- Lambda can be private (not publicly accessible)

**Phased rollout:**
1. **Preprod**: Keep current implementation with short token expiry (5 min) as temporary mitigation
2. **Prod**: Implement same-origin proxy before launch

---

## First Principles: Architecture Clarifications

### Auth Is Solved (Not Complex)

```
Request â†’ Has valid JWT cookie? â†’ YES â†’ Serve data
                               â†’ NO  â†’ 401 Unauthorized
```

**Pattern:**
- JWT stored in HttpOnly cookie (not localStorage, not URL params)
- Cookie sent automatically with every request (including EventSource)
- Backend validates JWT signature against Cognito JWKS (cached)
- Refresh token rotates JWT before expiry
- OAuth: Cognito handles redirect dance, returns JWT, sets cookie

### Caching Is Solved (Two Decisions Only)

**Cache Key:**
```
{ticker}:{resolution}:{bucket_start_timestamp}
```
Example: `AAPL:1h:1703721600`

**TTL by Resolution:**
| Resolution | TTL |
|------------|-----|
| 1m/5m/15m/30m | 5 minutes |
| 1h | 30 minutes |
| 1D | 1 hour |

**Layers (already implemented):**
| Layer | Implementation | Status |
|-------|----------------|--------|
| Browser | React Query staleTime | âœ… Exists |
| Backend | In-memory LRU (256 entries) | âœ… Exists (ohlc.py) |

All users see same data for same ticker/resolution/time. Cache hit rate >95%.

### Sentiment Overlay Is Trivial

```typescript
const chart = createChart(container);
const priceSeries = chart.addCandlestickSeries({ priceScaleId: 'price' });
const sentimentSeries = chart.addLineSeries({ priceScaleId: 'sentiment' });

priceSeries.setData(ohlcData);      // [{time, open, high, low, close}]
sentimentSeries.setData(sentimentData); // [{time, value}]
```

Same x-axis (time). Two y-axes. Already implemented in `price-sentiment-chart.tsx`.

**Verified:**
- `useChartData` hook fetches OHLC + sentiment in parallel âœ…
- `sentimentSeriesRef` populated with real API data âœ…
- Tooltip shows sentiment on hover âœ…

---

## Problem Statement

### The Broken Feature

OHLC chart pan/scroll is broken in the vanilla JS dashboard because:
- Chart.js with category scale cannot pan (documented library limitation)
- chartjs-plugin-zoom requires numeric X-axis values
- This is unfixable without switching chart libraries

### The Unused Solution

The Next.js frontend (`/frontend/`) already has:
- lightweight-charts (pan works)
- Gap visualization (red shading for weekends/holidays)
- Market calendar detection
- All the fixes from specs 1103, 1104, 1102

**But it was never deployed.**

### Current Deployment (Wrong)

```
GitHub Actions â†’ S3 sync /src/dashboard/ â†’ CloudFront â†’ User sees broken Chart.js
```

### Target Deployment (Correct)

```
GitHub Actions â†’ Amplify builds /frontend/ â†’ Amplify SSR â†’ User sees working lightweight-charts
```

---

## Architecture

### Current State (Broken)

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                         CURRENT ARCHITECTURE                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

User Browser
     â”‚
     â”œâ”€â”€â–º CloudFront (d2z9uvoj5xlbd2.cloudfront.net)
     â”‚         â”‚
     â”‚         â”œâ”€â”€â–º S3 Bucket (/src/dashboard/ vanilla JS)
     â”‚         â”‚         ðŸ”¶ Chart.js - PAN BROKEN
     â”‚         â”‚         ðŸ”¶ No gap visualization
     â”‚         â”‚
     â”‚         â”œâ”€â”€â–º API Gateway (/api/*)
     â”‚         â”‚         â””â”€â”€â–º Dashboard Lambda
     â”‚         â”‚
     â”‚         â””â”€â”€â–º SSE Lambda (/api/v2/stream*)
     â”‚
     â””â”€â”€â–º Lambda Function URL (ONE URL - same broken vanilla JS)
```

### Target State (AWS Amplify SSR)

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                      TARGET ARCHITECTURE (AMPLIFY)                   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

User Browser
     â”‚
     â”œâ”€â”€â–º Amplify Hosting (*.amplifyapp.com or custom domain)
     â”‚         â”‚
     â”‚         â”œâ”€â”€â–º Amplify CloudFront (built-in)
     â”‚         â”‚         â”‚
     â”‚         â”‚         â”œâ”€â”€â–º Lambda@Edge (SSR pages, middleware)
     â”‚         â”‚         â”‚         ðŸ”· Next.js 14 App Router
     â”‚         â”‚         â”‚         ðŸ”· Middleware for auth redirects
     â”‚         â”‚         â”‚         ðŸ”· useSearchParams works
     â”‚         â”‚         â”‚
     â”‚         â”‚         â””â”€â”€â–º S3 (static assets: _next/static/*)
     â”‚         â”‚
     â”‚         â””â”€â”€â–º API calls to existing infrastructure:
     â”‚                   â”‚
     â”‚                   â”œâ”€â”€â–º API Gateway (/api/*) â”€â”€â–º Dashboard Lambda
     â”‚                   â”‚
     â”‚                   â””â”€â”€â–º SSE Lambda (/api/v2/stream*)
     â”‚
     â””â”€â”€â–º Legacy CloudFront (deprecate after migration)
               â””â”€â”€â–º API Gateway only (no frontend)
```

### Key Integration Points

| Component | Status | Changes Required |
|-----------|--------|------------------|
| API Gateway | âœ… Keep | None - already CORS-enabled |
| Dashboard Lambda | âœ… Keep | Remove static file routes (optional) |
| SSE Lambda | âœ… Keep | None - already RESPONSE_STREAM |
| Cognito | âœ… Keep | None - already configured |
| S3 Dashboard Bucket | âš ï¸ Deprecate | Stop syncing vanilla JS |
| CloudFront | âš ï¸ Modify | Remove S3 origin, keep API origins |
| Amplify | ðŸ†• New | Add Terraform module |

---

## Why AWS Amplify SSR

### Canonical Source

From [AWS Amplify Next.js SSR Documentation](https://docs.aws.amazon.com/amplify/latest/userguide/server-side-rendering-amplify.html):

> AWS Amplify Hosting now supports server-side rendering (SSR) for Next.js applications. Amplify automatically detects Next.js applications and deploys them with full SSR support, including middleware, API routes, and dynamic rendering.

### Supported Features

| Feature | Amplify SSR Support | Our Usage |
|---------|---------------------|-----------|
| Next.js 14 App Router | âœ… Full | Yes |
| Middleware | âœ… Runs on CloudFront Edge | Auth redirects |
| `useSearchParams` | âœ… Works | Magic link verification |
| `useRouter` | âœ… Works | Programmatic navigation |
| Server Components | âœ… Full | Not used (all client) |
| ISR | âœ… Full | Not used |
| Image Optimization | âœ… Optional add-on | Not used |

### Why Not Alternatives

| Option | Reason Rejected |
|--------|-----------------|
| Static Export (S3) | Middleware, useSearchParams incompatible |
| Vercel | Leaves AWS ecosystem, data sovereignty |
| Lambda@Edge Manual | Reimplementing Next.js middleware manually |
| EC2/ECS Node.js | Over-engineered, operational burden |

---

## Implementation

### Phase 1: Create Amplify Terraform Module

**New directory**: `infrastructure/terraform/modules/amplify/`

**Files**:
```
modules/amplify/
â”œâ”€â”€ main.tf          # Amplify app, branch, domain
â”œâ”€â”€ variables.tf     # Input variables
â”œâ”€â”€ outputs.tf       # App ID, domain outputs
â””â”€â”€ iam.tf           # Service role for Amplify
```

**main.tf**:
```hcl
resource "aws_amplify_app" "frontend" {
  name       = "${var.environment}-sentiment-frontend"
  repository = var.github_repository
  platform   = "WEB_COMPUTE"  # SSR mode

  # GitHub access token for repo connection
  access_token = var.github_access_token

  # Build specification (Terraform is single source of truth - Gap 1 decision)
  build_spec = <<-EOT
    version: 1
    applications:
      - appRoot: frontend
        frontend:
          phases:
            preBuild:
              commands:
                - npm ci
            build:
              commands:
                - npm run build
          artifacts:
            baseDirectory: .next
            files:
              - '**/*'
          cache:
            paths:
              - node_modules/**/*
              - .next/cache/**/*
  EOT

  # Environment variables for Next.js
  environment_variables = {
    NEXT_PUBLIC_API_URL              = var.api_gateway_url
    NEXT_PUBLIC_SSE_URL              = var.sse_lambda_url
    NEXT_PUBLIC_COGNITO_USER_POOL_ID = var.cognito_user_pool_id
    NEXT_PUBLIC_COGNITO_CLIENT_ID    = var.cognito_client_id
    NEXT_PUBLIC_COGNITO_DOMAIN       = var.cognito_domain
    NEXT_PUBLIC_ENABLE_HAPTICS       = "true"
    AMPLIFY_MONOREPO_APP_ROOT        = "frontend"
  }

  # Enable branch auto-detection
  enable_branch_auto_build = true

  # Custom rules - NO SPA fallback for SSR (Gap 2 decision)
  # Only www redirect:
  custom_rule {
    source = "https://www.<*>"
    status = "301"
    target = "https://<*>"
  }

  iam_service_role_arn = aws_iam_role.amplify_service.arn
}

resource "aws_amplify_branch" "main" {
  app_id            = aws_amplify_app.frontend.id
  branch_name       = "main"
  stage             = var.environment == "prod" ? "PRODUCTION" : "DEVELOPMENT"
  enable_auto_build = true

  # Framework detection
  framework = "Next.js - SSR"
}
```

### Phase 2: Update Root Terraform

**File**: `infrastructure/terraform/main.tf`

**Add module instantiation**:
```hcl
module "amplify_frontend" {
  source = "./modules/amplify"

  environment         = var.environment
  github_repository   = "https://github.com/traylorre/sentiment-analyzer-gsk"
  github_access_token = var.github_token

  # Existing infrastructure outputs
  api_gateway_url       = module.api_gateway.api_endpoint
  sse_lambda_url        = module.sse_streaming_lambda.function_url
  cognito_user_pool_id  = module.cognito.user_pool_id
  cognito_client_id     = module.cognito.client_id
  cognito_domain        = module.cognito.domain

  depends_on = [
    module.api_gateway,
    module.sse_streaming_lambda,
    module.cognito
  ]
}
```

**Add outputs**:
```hcl
output "amplify_app_id" {
  description = "Amplify App ID for CI/CD"
  value       = module.amplify_frontend.app_id
}

output "amplify_default_domain" {
  description = "Amplify default domain"
  value       = module.amplify_frontend.default_domain
}

output "amplify_production_url" {
  description = "Production URL for Next.js frontend"
  value       = "https://${module.amplify_frontend.branch_domain}"
}
```

### Phase 3: Update GitHub Actions

**File**: `.github/workflows/deploy.yml`

**Remove**: S3 sync of `/src/dashboard/`

**Add**: Amplify build trigger (optional - Amplify auto-builds on push)

```yaml
  # Amplify builds automatically on push to main
  # This job just validates the frontend builds successfully
  validate-frontend:
    name: Validate Next.js Build
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: frontend/package-lock.json

      - name: Install dependencies
        working-directory: frontend
        run: npm ci

      - name: Build Next.js
        working-directory: frontend
        env:
          NEXT_PUBLIC_API_URL: ${{ needs.terraform.outputs.dashboard_api_url }}
          NEXT_PUBLIC_SSE_URL: ${{ needs.terraform.outputs.sse_lambda_url }}
        run: npm run build

      - name: Notify Amplify deployment started
        run: echo "Amplify will auto-deploy from main branch"
```

### Phase 4: Add GitHub Token Secret

**Required**: GitHub Personal Access Token with `repo` scope

**Add to GitHub Secrets**:
- `AMPLIFY_GITHUB_TOKEN` - For Amplify to access repository

**Add to Terraform variables**:
```hcl
variable "github_token" {
  description = "GitHub PAT for Amplify repository access"
  type        = string
  sensitive   = true
}
```

### Phase 5: Clean Up Legacy Code (Optional)

**After Amplify is stable**:

1. Remove S3 sync from deploy.yml
2. Remove `/src/dashboard/` directory
3. Remove static file routes from Dashboard Lambda handler.py
4. Update CloudFront to remove S3 origin (keep API Gateway and SSE origins)

---

## Environment Variables

### Required for Next.js Frontend

| Variable | Source | Description |
|----------|--------|-------------|
| `NEXT_PUBLIC_API_URL` | `module.api_gateway.api_endpoint` | REST API base URL |
| `NEXT_PUBLIC_SSE_URL` | `module.sse_streaming_lambda.function_url` | SSE streaming URL |
| `NEXT_PUBLIC_COGNITO_USER_POOL_ID` | `module.cognito.user_pool_id` | Cognito pool ID |
| `NEXT_PUBLIC_COGNITO_CLIENT_ID` | `module.cognito.client_id` | Cognito app client |
| `NEXT_PUBLIC_COGNITO_DOMAIN` | `module.cognito.domain` | Cognito hosted UI |
| `NEXT_PUBLIC_ENABLE_HAPTICS` | `"true"` | Enable haptic feedback |

### Amplify-Specific

| Variable | Value | Description |
|----------|-------|-------------|
| `AMPLIFY_MONOREPO_APP_ROOT` | `frontend` | Monorepo frontend path |

---

## Cost Analysis

### Current Stack (Monthly)

| Component | Cost |
|-----------|------|
| CloudFront | ~$1-2 |
| S3 | ~$0.50 |
| Lambda (Dashboard) | ~$5 |
| Lambda (SSE) | ~$3 |
| API Gateway | ~$2 |
| **Total** | **~$12** |

### With Amplify SSR (Monthly)

| Component | Cost |
|-----------|------|
| Amplify Hosting | ~$0 (free tier: 1000 build min, 15GB storage) |
| Amplify SSR Compute | ~$0.30-1 (10K requests) |
| Lambda (Dashboard - API only) | ~$3 (reduced, no static) |
| Lambda (SSE) | ~$3 |
| API Gateway | ~$2 |
| **Total** | **~$9-10** |

**Cost impact**: Neutral to slightly lower

---

## Success Criteria

| ID | Criterion | Verification |
|----|-----------|--------------|
| SC-001 | Amplify serves Next.js at production URL | `curl https://main.{app-id}.amplifyapp.com/` returns Next.js HTML |
| SC-002 | OHLC chart pan works on all resolutions | Manual test: pan left/right on D, 1h, 5m, 1m |
| SC-003 | Gap visualization appears on daily chart | Manual test: view weekend in daily data |
| SC-004 | Auth redirects work (middleware) | Navigate to protected route without auth â†’ redirected to signin |
| SC-005 | Magic link verification works | Click magic link â†’ token extracted â†’ verified |
| SC-006 | SSE streaming works | Connect to stream â†’ receive heartbeat events |
| SC-007 | All API endpoints accessible | E2E test suite passes |
| SC-008 | Amplify auto-builds on push to main | Push to main â†’ Amplify build triggered |

---

## Rollback Plan

If Amplify deployment fails:

1. **Immediate**: CloudFront still serves S3 (vanilla JS) - users unaffected
2. **Disable Amplify**: Set `enable_auto_build = false` in Terraform
3. **Investigate**: Check Amplify build logs in AWS Console
4. **Fix forward**: Do not revert to vanilla JS long-term

---

## Risks and Mitigations

| Risk | Likelihood | Impact | Mitigation |
|------|------------|--------|------------|
| Amplify build fails | Medium | High | Validate build in CI before merge |
| Cold start latency | Medium | Medium | Use ISR for static pages |
| GitHub token expires | Low | High | Use long-lived token, monitor |
| Cost overrun | Low | Low | Monitor Amplify usage, set alerts |
| Middleware incompatibility | Low | High | Test auth flows in preprod |

---

## Timeline

| Phase | Description | Dependencies |
|-------|-------------|--------------|
| 1 | Create Amplify Terraform module | None |
| 2 | Add GitHub token secret | Admin access |
| 3 | Apply Terraform (creates Amplify app) | Phase 1, 2 |
| 4 | Verify Amplify builds from main | Phase 3 |
| 5 | Test all features on Amplify URL | Phase 4 |
| 6 | Update DNS/domain (optional) | Phase 5 |
| 7 | Remove legacy S3 sync | Phase 5 verified |
| 8 | Delete /src/dashboard/ | Phase 7 |

---

## Files Changed Summary

| Action | Path | Description |
|--------|------|-------------|
| CREATE | `infrastructure/terraform/modules/amplify/main.tf` | Amplify app resource |
| CREATE | `infrastructure/terraform/modules/amplify/variables.tf` | Input variables |
| CREATE | `infrastructure/terraform/modules/amplify/outputs.tf` | App ID, domain outputs |
| CREATE | `infrastructure/terraform/modules/amplify/iam.tf` | Service role |
| CREATE | `frontend/src/app/api/sse/[...path]/route.ts` | SSE proxy (Gap 4) |
| MODIFY | `infrastructure/terraform/main.tf` | Add module, outputs, cognito patch (Gap 3) |
| MODIFY | `infrastructure/terraform/variables.tf` | Add github_token |
| MODIFY | `infrastructure/terraform/modules/cognito/main.tf` | Add lifecycle ignore_changes (Gap 3) |
| MODIFY | `frontend/src/hooks/use-sse.ts` | Use same-origin proxy URL (Gap 4) |
| MODIFY | `.github/workflows/deploy.yml` | Remove S3 sync, add validation |
| DELETE | `frontend/amplify.yml` | Terraform owns buildspec (Gap 1) |
| DELETE | `src/dashboard/` | After migration verified |
| MODIFY | `src/lambdas/dashboard/handler.py` | Remove static routes (optional) |

---

## Appendix A: Why Static Export Failed

See `CRITICAL_REVIEW.md` for full analysis.

**Summary**: Next.js frontend uses 8 features incompatible with `output: 'export'`:
1. Middleware (auth redirects)
2. useSearchParams (magic link token)
3. useRouter (programmatic navigation)
4. SessionProvider (runtime auth)
5. RuntimeInitializer (API fetch at startup)
6. 'use client' pages (browser runtime)
7. Zustand stores (state persistence)
8. Browser APIs (localStorage, cookies)

---

## Appendix B: Conflicting Specs

12 specs depend on vanilla JS and will be superseded by this migration:

| Spec | Title | Status After Migration |
|------|-------|------------------------|
| 1057 | OHLC Chart Vanilla JS | Superseded |
| 1035 | Resolution Selector | Superseded |
| 1084 | Hide Hybrid Resolutions | Superseded |
| 1050 | Metrics Session Race | Not needed |
| 1011 | Dashboard Auth Header | Architecture mismatch |
| 1018 | Resolution Switch Perf | Re-instrument |
| 1019 | SSE Latency Testing | Re-validate |
| 1021a | Skeleton Loading UI | Already in Next.js |
| 1021b | Resolution Config | Already in Next.js |
| 113 | Dashboard S3 Deploy | Superseded |
| 1036 | Container Deploy | Reorder |
| 104 | Interview URL | Compatible |
