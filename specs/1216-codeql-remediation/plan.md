# Implementation Plan: CodeQL Security Vulnerability Remediation

**Branch**: `1216-codeql-remediation` | **Date**: 2026-01-20 | **Spec**: [spec.md](./spec.md)
**Input**: Feature specification from `/specs/1216-codeql-remediation/spec.md`

## Summary

Remediate 28 CodeQL security findings blocking CI pipeline:
- 26 py/log-injection findings in auth.py, ohlc.py, oauth_state.py
- 1 py/clear-text-logging-sensitive-data finding in oauth_state.py
- 1 py/bad-tag-filter finding in regenerate-mermaid-url.py

**Technical approach**: Add inline sanitization patterns that CodeQL recognizes as taint barriers. The existing `sanitize_for_log()` utility is not recognized by CodeQL's taint analysis, so we must use explicit string replacement patterns inline or create a CodeQL-model-aware wrapper.

## Technical Context

**Language/Version**: Python 3.13
**Primary Dependencies**: Python logging (stdlib), existing logging_utils.py
**Storage**: N/A (no storage changes)
**Testing**: pytest, CodeQL scan via GitHub Actions
**Target Platform**: AWS Lambda (Linux)
**Project Type**: Serverless Lambda functions
**Performance Goals**: No regression - sanitization overhead < 1ms per log call
**Constraints**: Must pass CodeQL security scanner, preserve log semantic meaning
**Scale/Scope**: 28 findings across 4 files, ~30 code locations to modify

## Constitution Check

*GATE: Must pass before Phase 0 research. Re-check after Phase 1 design.*

| Principle | Status | Evidence |
|-----------|--------|----------|
| Log injection prevention | ✅ ALIGNED | Constitution 3.6: "Protect logs and dashboard displays: do not write raw user-provided text into logs or dashboard fields without redaction or encoding to avoid log injection and leakage" |
| Security scanning in CI | ✅ ALIGNED | Constitution 3.6: "Scanning and testing: include SAST/secret scanning and dependency checks in CI" |
| Minimal change scope | ✅ ALIGNED | Changes limited to sanitization at log call sites, no architectural changes |

**Gate Status**: PASS - Feature directly implements constitution requirements

## Project Structure

### Documentation (this feature)

```text
specs/1216-codeql-remediation/
├── spec.md              # Feature specification
├── plan.md              # This file
├── research.md          # Research findings (complete)
├── checklists/
│   └── requirements.md  # Spec quality checklist
└── tasks.md             # Task breakdown (generated by /speckit.tasks)
```

### Source Code (files to modify)

```text
src/lambdas/
├── dashboard/
│   ├── auth.py          # 21 log injection findings
│   └── ohlc.py          # 2 log injection findings
└── shared/
    ├── auth/
    │   └── oauth_state.py  # 3 log injection + 1 clear-text logging
    └── logging_utils.py    # Existing utility (may add CodeQL-aware wrapper)

scripts/
└── regenerate-mermaid-url.py  # 1 bad-tag-filter finding
```

**Structure Decision**: No new directories. Modify existing files in-place to add sanitization at flagged locations.

## Implementation Phases

### Phase 1: Enhance Sanitization Utility (Optional)

Add a CodeQL-recognized wrapper to logging_utils.py if inline patterns prove too repetitive:

```python
def safe_log_value(value: Any, max_length: int = 200) -> str:
    """Sanitize for logging with CodeQL-recognized pattern."""
    if value is None:
        return ""
    s = str(value)
    # Inline pattern CodeQL recognizes as taint barrier
    s = s.replace("\r\n", " ").replace("\n", " ").replace("\r", " ")
    return s[:max_length]
```

### Phase 2: Remediate Log Injection (26 findings)

Apply sanitization at each flagged location:
- auth.py: 21 locations (provider values, user ID prefixes, error info)
- ohlc.py: 2 locations (cache_key with user-derived ticker/resolution)
- oauth_state.py: 3 locations (redirect_uri, provider values)

### Phase 3: Remediate Clear-Text Logging (1 finding)

oauth_state.py:95 - Remove or redact sensitive credential from log extra fields.

### Phase 4: Remediate Bad Tag Filter (1 finding)

regenerate-mermaid-url.py:81 - Remove unnecessary HTML comment regex check that triggers py/bad-tag-filter. The mermaid validator doesn't need HTML filtering.

## Complexity Tracking

No violations - this feature reduces complexity by:
- Using existing sanitization infrastructure
- Making minimal targeted changes at specific code locations
- Not introducing new dependencies or patterns

## Testing Strategy

1. **Unit Tests**: Verify sanitization functions strip control characters
2. **Integration Tests**: Verify logging still works correctly after changes
3. **CodeQL Scan**: Primary success metric - zero findings on PR
4. **Regression Tests**: Existing test suite must continue to pass

## Risks and Mitigations

| Risk | Impact | Mitigation |
|------|--------|------------|
| CodeQL doesn't recognize our sanitization | HIGH - PR blocked | Use exact inline pattern from CodeQL docs |
| Log messages lose semantic meaning | MEDIUM - Debug difficulty | Preserve all information, only strip control chars |
| Performance regression from sanitization | LOW - Logging is not hot path | Sanitization is O(n) string ops, negligible |

## Dependencies

- Existing logging_utils.py infrastructure
- CodeQL GitHub Action for validation
- No external dependencies to add

## Success Criteria

- [ ] CodeQL scan reports 0 py/log-injection findings
- [ ] CodeQL scan reports 0 py/clear-text-logging-sensitive-data findings
- [ ] CodeQL scan reports 0 py/bad-tag-filter findings
- [ ] All existing unit tests pass
- [ ] All existing integration tests pass
- [ ] PR merges without blocking on security checks
