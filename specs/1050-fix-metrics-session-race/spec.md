# Feature Specification: Fix Legacy Dashboard 401 on /api/v2/metrics

**Feature Branch**: `1050-fix-metrics-session-race`
**Created**: 2024-12-24
**Status**: Draft
**Input**: User description: "Fix 401 Unauthorized on /api/v2/metrics due to session initialization race condition"

## Problem Statement

The legacy dashboard (`src/dashboard/app.js`) returns 401 Unauthorized when calling `/api/v2/metrics`. This is because:

1. Feature 1039 unified session authentication, removing API key auth
2. The backend now requires either `Authorization: Bearer {uuid}` or `X-User-ID: {uuid}` header
3. The legacy dashboard still uses the old `CONFIG.API_KEY` approach which is no longer injected
4. The dashboard has no anonymous session creation logic - it never calls `/api/v2/auth/anonymous`

## User Scenarios & Testing _(mandatory)_

### User Story 1 - Dashboard Loads Without 401 Error (Priority: P1)

A user navigates to the CloudFront dashboard URL and the dashboard loads successfully, displaying metrics without any authentication errors.

**Why this priority**: This is the core fix - the dashboard is completely broken without this. Users cannot view any metrics.

**Independent Test**: Load the dashboard at `https://d2z9uvoj5xlbd2.cloudfront.net/` and verify no 401 errors appear in the browser console. Metrics should display within 5 seconds.

**Acceptance Scenarios**:

1. **Given** a user visits the dashboard URL for the first time, **When** the page loads, **Then** an anonymous session is created automatically and metrics load without 401 errors
2. **Given** a user has a cached session from a previous visit, **When** the page loads, **Then** the cached session UUID is used and no new session is created
3. **Given** a cached session has expired, **When** the page loads, **Then** a new anonymous session is created automatically

---

### User Story 2 - Session Persistence Across Page Reloads (Priority: P2)

A user's anonymous session persists across page reloads, avoiding unnecessary session creation calls.

**Why this priority**: Reduces API calls and improves performance, but not critical for basic functionality.

**Independent Test**: Load the dashboard, note the session ID in localStorage, reload the page, and verify the same session ID is used.

**Acceptance Scenarios**:

1. **Given** a user has an active session, **When** they reload the page, **Then** the existing session UUID is reused from localStorage
2. **Given** a user clears browser data, **When** they reload the page, **Then** a new anonymous session is created

---

### Edge Cases

- What happens if `/api/v2/auth/anonymous` fails? Show an error message and allow retry.
- What happens if the stored UUID is malformed? Clear storage and create new session.
- What happens during concurrent page loads (multiple tabs)? Each tab should use its own session or share via storage.

## Requirements _(mandatory)_

### Functional Requirements

- **FR-001**: Dashboard MUST call `/api/v2/auth/anonymous` to obtain a session UUID on initial load
- **FR-002**: Dashboard MUST store the session UUID in localStorage for persistence
- **FR-003**: Dashboard MUST include `X-User-ID: {uuid}` header in all API requests (anonymous auth pattern)
- **FR-004**: Dashboard MUST check for existing valid session before creating new one
- **FR-005**: Dashboard MUST display a connection error if session creation fails
- **FR-006**: Dashboard MUST NOT make any API calls until session is established

### Key Entities

- **Anonymous Session**: A UUID4 identifier generated by the backend at `/api/v2/auth/anonymous`, stored in localStorage, and sent with all API requests as `X-User-ID: {uuid}` header

## Success Criteria _(mandatory)_

### Measurable Outcomes

- **SC-001**: Dashboard loads without 401 errors in browser console (100% success rate)
- **SC-002**: Metrics display within 5 seconds of page load
- **SC-003**: Session UUID persists across page reloads (localStorage contains valid UUID)
- **SC-004**: No regression in existing functionality (SSE, polling, charts all work)

## Technical Context (For Implementation)

### Files to Modify

1. `src/dashboard/app.js` - Add session initialization before `fetchMetrics()`
2. `src/dashboard/config.js` - Add localStorage key constant, remove deprecated API_KEY reference

### Backend Endpoints (Already Exist)

- `POST /api/v2/auth/anonymous` - Returns `{ userId: "uuid4" }`
- Auth middleware accepts `X-User-ID: {uuid}` header for anonymous sessions

### Auth Header Patterns

| Auth Type | Header Pattern | Use Case |
|-----------|---------------|----------|
| Anonymous | `X-User-ID: {uuid}` | Legacy dashboard, anonymous users |
| Authenticated | `Authorization: Bearer {jwt}` | Logged-in users with JWT |

### Implementation Pattern (Reference: Next.js Frontend)

The Next.js frontend (`frontend/src/lib/api/client.ts`) implements this pattern:
1. Check localStorage for existing session
2. Validate session is not expired
3. If no valid session, call `POST /api/v2/auth/anonymous`
4. Store UUID in state and localStorage
5. Include UUID in all API requests via `X-User-ID: {uuid}` header

The legacy dashboard should follow the same pattern in vanilla JS.
