# Feature Specification: Add Roles Claim to JWT Generation

**Feature Branch**: `1152-jwt-claims-roles`
**Created**: 2026-01-06
**Status**: Draft
**Phase**: 1.5.3 - RBAC Infrastructure
**Depends On**: Feature 1150 (get_roles_for_user), Feature 1151 (User RBAC fields)

## Context

The JWT validation middleware (`auth_middleware.py`) already supports extracting a `roles` claim from JWTs (JWTClaim.roles, AuthContext.roles). However, no JWT generation code currently includes this claim.

This feature adds the `roles` claim to JWT generation so that `@require_role()` decorators can function.

## Architecture

### Token Sources

1. **Test JWTs** - Generated by `create_test_jwt()` in test fixtures
2. **Production JWTs** - Generated by AWS Cognito (requires Pre Token Generation Lambda trigger)

### Current State

- `JWTClaim` dataclass has `roles: list[str] | None = None` (line 76)
- `AuthContext` dataclass has `roles: list[str] | None = None` (line 57)
- `validate_jwt()` extracts `roles` from payload: `roles=payload.get("roles")` (line 167)
- `get_roles_for_user()` returns roles based on User model RBAC fields

### Gap

No JWT generation code calls `get_roles_for_user()` or includes `roles` in the payload.

## User Scenarios & Testing *(mandatory)*

### User Story 1 - Test JWT with Roles (Priority: P1)

As a test author, I need `create_test_jwt()` to include a `roles` claim so I can test role-based access control.

**Why this priority**: E2E and integration tests need JWTs with roles to verify `@require_role()` decorators.

**Independent Test**: Call `create_test_jwt(roles=["free", "paid"])`, decode JWT, verify `roles` claim exists.

**Acceptance Scenarios**:

1. **Given** a call to `create_test_jwt(roles=["operator"])`, **When** the JWT is decoded, **Then** `payload["roles"]` equals `["operator"]`
2. **Given** a call to `create_test_jwt()` without roles parameter, **When** the JWT is decoded, **Then** `payload["roles"]` equals `["free"]` (default)
3. **Given** a call to `create_test_jwt(roles=[])`, **When** the JWT is decoded, **Then** `payload["roles"]` equals `[]`

---

### User Story 2 - Validation Extracts Roles (Priority: P1)

As the auth middleware, I need to extract `roles` from validated JWTs so `@require_role()` can check permissions.

**Why this priority**: This is already implemented but needs verification with actual roles in tokens.

**Independent Test**: Generate JWT with roles, call `validate_jwt()`, verify `JWTClaim.roles` is populated.

**Acceptance Scenarios**:

1. **Given** a valid JWT with `roles: ["free", "paid"]`, **When** `validate_jwt()` is called, **Then** returned `JWTClaim.roles` equals `["free", "paid"]`
2. **Given** a valid JWT without `roles` claim, **When** `validate_jwt()` is called, **Then** returned `JWTClaim.roles` is `None`

---

### User Story 3 - Production Cognito Integration (Priority: P2)

As the system architect, I need a plan for Cognito to include `roles` in production JWTs.

**Why this priority**: Test infrastructure comes first; production follows.

**Independent Test**: Documentation review - Cognito Lambda trigger spec exists.

**Acceptance Scenarios**:

1. **Given** this feature is complete, **When** reviewing documentation, **Then** a spec for Cognito Pre Token Generation Lambda trigger exists at `specs/1157-cognito-roles-trigger/`

---

### Edge Cases

- **Empty roles array**: `roles: []` is valid (user has no roles, all `@require_role()` checks fail)
- **Unknown roles**: Roles not in canonical enum are preserved (forward compatibility)
- **Missing roles claim**: Tokens without `roles` return `JWTClaim.roles = None` (backward compatibility for now)

## Requirements *(mandatory)*

### Functional Requirements

- **FR-001**: `create_test_jwt()` MUST accept optional `roles: list[str]` parameter
- **FR-002**: `create_test_jwt()` MUST include `roles` claim in JWT payload
- **FR-003**: Default roles MUST be `["free"]` when not specified (authenticated user default)
- **FR-004**: `validate_jwt()` MUST extract `roles` claim into `JWTClaim.roles` (already implemented)
- **FR-005**: Documentation MUST describe Cognito Pre Token Generation trigger for production

### Key Entities

- **JWT Payload**: Extended with `roles: list[str]` claim
- **JWTClaim**: Already has `roles: list[str] | None` field (Feature 1130)
- **AuthContext**: Already has `roles: list[str] | None` field (Feature 1130)

## Success Criteria *(mandatory)*

### Measurable Outcomes

- **SC-001**: `create_test_jwt(roles=["paid"])` generates JWT with `roles` claim
- **SC-002**: E2E tests using `create_test_jwt()` can test `@require_role("paid")` endpoints
- **SC-003**: All existing JWT validation tests pass
- **SC-004**: New tests verify roles claim roundtrip (generate → validate → extract)

## Technical Notes

### Test JWT Helper Location

**File**: `tests/e2e/conftest.py` (line 510-530)

```python
def create_test_jwt(
    user_id: str | None = None,
    secret: str | None = None,
    expires_in: timedelta = timedelta(minutes=15),
    issuer: str = "sentiment-analyzer",
    audience: str = "sentiment-analyzer-api",
    nbf_offset: timedelta = timedelta(seconds=0),
    roles: list[str] | None = None,  # NEW PARAMETER
) -> str:
```

### Production Path (Future Feature 1157)

AWS Cognito supports custom claims via Pre Token Generation Lambda trigger:
1. Create Lambda that calls `get_roles_for_user()`
2. Add `roles` to `claimsToAddOrOverride` in response
3. Configure Cognito User Pool to use the trigger

This is out of scope for Feature 1152 but documented for planning.
