# Implementation Plan: Sentiment Model S3 Loading Test Coverage

**Branch**: `088-sentiment-s3-coverage` | **Date**: 2025-12-10 | **Spec**: [spec.md](./spec.md)
**Input**: Feature specification from `/specs/088-sentiment-s3-coverage/spec.md`

## Summary

Increase test coverage for the sentiment model S3 loading logic (`src/lambdas/analysis/sentiment.py` lines 70-141) from 59% to 85% by adding comprehensive tests using moto's `mock_aws` for S3 operations. Tests will verify successful download, warm container skip, and error handling (NoSuchKey, Throttling, general ClientError) with explicit `assert_error_logged()` assertions.

## Technical Context

**Language/Version**: Python 3.13 (existing project standard)
**Primary Dependencies**: pytest, moto (mock_aws), boto3, botocore
**Storage**: S3 (model artifacts), /tmp (Lambda local storage)
**Testing**: pytest with pytest-cov for coverage reporting
**Target Platform**: AWS Lambda (Python 3.13 runtime)
**Project Type**: Single project (test-only changes)
**Performance Goals**: Test execution <30s for S3 test class
**Constraints**: No real AWS credentials required in CI
**Scale/Scope**: ~5 new test methods in existing test file

## Constitution Check

*GATE: Must pass before Phase 0 research. Re-check after Phase 1 design.*

| Constitution Requirement | Status | Notes |
|--------------------------|--------|-------|
| **7) Testing & Validation** | ✅ PASS | Unit tests with moto mocks (LOCAL/DEV rule) |
| Implementation Accompaniment | ✅ PASS | Tests for existing code, not new implementation |
| Functional Integrity | ✅ PASS | Tests verify S3 download logic correctness |
| Deterministic Time Handling | ✅ PASS | No time-dependent logic in S3 tests |
| **8) Git Workflow** | ✅ PASS | Feature branch workflow, GPG signing |
| Pre-Push Requirements | ✅ PASS | Will run make validate before push |
| **10) Local SAST** | ✅ PASS | No security-sensitive code changes (tests only) |

**Gate Result**: PASS - No violations. Test-only feature follows all constitution requirements.

## Project Structure

### Documentation (this feature)

```text
specs/088-sentiment-s3-coverage/
├── plan.md              # This file
├── research.md          # Phase 0 output
├── data-model.md        # Phase 1 output (N/A for test feature)
├── quickstart.md        # Phase 1 output
└── tasks.md             # Phase 2 output
```

### Source Code (repository root)

```text
tests/
└── unit/
    └── test_sentiment.py    # Existing file to extend with S3 tests

src/
└── lambdas/
    └── analysis/
        └── sentiment.py     # Target file for coverage (lines 70-141)
```

**Structure Decision**: Extend existing `tests/unit/test_sentiment.py` with new `TestS3ModelDownloadWithMoto` class using moto `mock_aws` decorator for full S3 simulation.

## Complexity Tracking

> **No violations requiring justification** - Simple test-only feature following existing patterns.

## Phase 0: Research

### Research Tasks

1. **Existing test patterns**: Review current `TestS3ModelDownload` class for patterns to extend
2. **moto S3 best practices**: Verify correct `mock_aws` usage for download_file operations
3. **Coverage gap analysis**: Identify exact uncovered lines to target

### Research Findings

**Decision**: Enhance existing S3 tests with moto `mock_aws` integration
**Rationale**: Existing tests use manual boto3 patches; moto provides more realistic S3 behavior
**Alternatives considered**:
- LocalStack (rejected: overkill for unit tests)
- Pure mocks (current approach: incomplete coverage)

See [research.md](./research.md) for detailed findings.

## Phase 1: Design

### Test Strategy

| Test Scenario | Lines Covered | Error Path | Log Assertion |
|---------------|---------------|------------|---------------|
| Successful S3 download + extraction | 95-130 | No | N/A |
| Warm container (model exists) | 88-93 | No | N/A |
| NoSuchKey error | 132-141 | Yes | "Failed to download model from S3" |
| Throttling error | 132-141 | Yes | "Failed to download model from S3" |
| General ClientError | 132-141 | Yes | "Failed to download model from S3" |

### Test Fixture: Model Artifact

Create minimal tar.gz fixture containing:
```
model/
└── config.json    # {"model_type": "test"}
```

This mimics the HuggingFace model structure that `_download_model_from_s3()` expects.

See [quickstart.md](./quickstart.md) for setup instructions.

## Phase 2: Tasks

Tasks will be generated by `/speckit.tasks` command.
