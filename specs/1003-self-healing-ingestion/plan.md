# Implementation Plan: Self-Healing Ingestion

**Branch**: `1003-self-healing-ingestion` | **Date**: 2025-12-20 | **Spec**: [spec.md](./spec.md)
**Input**: Feature specification from `/specs/1003-self-healing-ingestion/spec.md`

## Summary

Add self-healing capability to the ingestion Lambda that automatically detects and republishes stale pending items (older than 1 hour without sentiment) to the SNS topic for reprocessing. This fixes the root cause of dashboard showing empty data despite items existing in DynamoDB.

## Technical Context

**Language/Version**: Python 3.13 (existing project standard)
**Primary Dependencies**: boto3, aws-xray-sdk (existing)
**Storage**: DynamoDB with `by_status` GSI (hash: status, range: timestamp, projection: KEYS_ONLY)
**Testing**: pytest with moto mocks (unit), real AWS (e2e)
**Target Platform**: AWS Lambda (ARM64, 512MB memory)
**Project Type**: Serverless/Event-driven
**Performance Goals**: <5 second overhead per ingestion run
**Constraints**: Lambda timeout 30s, SNS batch limit 10 messages/call, by_status GSI is KEYS_ONLY
**Scale/Scope**: ~500 pending items initially, typically <100 stale items per check

## Constitution Check

*GATE: Must pass before Phase 0 research. Re-check after Phase 1 design.*

| Requirement | Status | Notes |
|-------------|--------|-------|
| Unit tests accompany all implementation | ✅ PASS | Tests planned in tasks |
| No hardcoded secrets | ✅ PASS | Uses existing SNS_TOPIC_ARN env var |
| Idempotent processing | ✅ PASS | Republishing already-analyzed items is no-op |
| Conditional writes for deduplication | ✅ PASS | Analysis Lambda handles dedup |
| Structured logging | ✅ PASS | Uses existing logging_utils |
| CloudWatch metrics | ✅ PASS | New SelfHealingItemsRepublished metric |
| No pipeline bypass | ✅ PASS | Feature uses full CI/CD workflow |
| GPG-signed commits | ✅ PASS | Standard practice |

## Project Structure

### Documentation (this feature)

```text
specs/1003-self-healing-ingestion/
├── spec.md              # Feature specification
├── plan.md              # This file
├── research.md          # Phase 0 research output
├── data-model.md        # Phase 1 data model
├── quickstart.md        # Phase 1 quickstart guide
├── contracts/           # Phase 1 API contracts (N/A - internal Lambda)
└── tasks.md             # Phase 2 task breakdown
```

### Source Code (repository root)

```text
src/lambdas/ingestion/
├── handler.py           # MODIFY: Add self_healing_check() call
├── self_healing.py      # NEW: Self-healing logic
└── config.py            # Existing config

src/lambdas/shared/
└── dynamodb.py          # Existing DynamoDB utilities

tests/unit/lambdas/ingestion/
├── test_handler.py      # MODIFY: Add self-healing tests
└── test_self_healing.py # NEW: Self-healing unit tests
```

**Structure Decision**: Extend existing ingestion Lambda with new module. No new Lambda needed since self-healing runs as part of scheduled ingestion.

## Complexity Tracking

No violations - implementation is straightforward extension of existing Lambda.

## Implementation Approach

### Phase 0: Research Complete

See [research.md](./research.md) for:
- DynamoDB GSI query patterns with KEYS_ONLY projection
- SNS batch publish patterns (already used in handler.py)
- Stale threshold determination (1 hour chosen based on normal pipeline latency)

### Phase 1: Design Complete

See [data-model.md](./data-model.md) for:
- SentimentItem entity with status/sentiment/timestamp fields
- Query patterns using by_status GSI
- Self-healing message format for SNS

### Implementation Tasks (Phase 2)

1. Create `self_healing.py` module with:
   - `get_stale_pending_items()` - Query by_status GSI for pending items
   - `filter_stale_items()` - Check timestamp > 1 hour ago
   - `republish_to_sns()` - Batch publish to analysis topic

2. Modify `handler.py`:
   - Add self-healing check after normal ingestion completes
   - Log republish counts
   - Emit CloudWatch metric

3. Add unit tests:
   - Test GSI query with moto
   - Test stale filtering logic
   - Test SNS batch publish
   - Test integration with handler

4. Add observability:
   - CloudWatch metric: SelfHealingItemsRepublished
   - Structured log: "Self-healing: republished N stale items"

## Artifacts Generated

- [x] plan.md (this file)
- [x] research.md
- [x] data-model.md
- [x] quickstart.md
- [ ] tasks.md (generated by /speckit.tasks)
