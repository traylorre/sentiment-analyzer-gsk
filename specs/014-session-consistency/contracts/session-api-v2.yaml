openapi: 3.1.0
info:
  title: Session Consistency API
  description: |
    API contracts for Feature 014 - Multi-User Session Consistency.
    These endpoints handle authentication, session management, and account operations
    with race condition protection and atomic guarantees.
  version: 2.0.0
  contact:
    name: Sentiment Analyzer Team

servers:
  - url: /api/v2
    description: API v2 base path

tags:
  - name: Authentication
    description: Session creation and authentication flows
  - name: Session Management
    description: Session lifecycle operations
  - name: Account Operations
    description: Account merge and user management

paths:
  /auth/anonymous:
    post:
      tags:
        - Authentication
      summary: Create anonymous session
      description: |
        Creates a new anonymous session. This endpoint is idempotent - if the client
        already has a valid session token, it returns the existing session.

        **FR-003**: Frontend MUST call this on app load, before any user interaction.
      operationId: createAnonymousSession
      security: []  # No auth required for anonymous session creation
      requestBody:
        content:
          application/json:
            schema:
              type: object
              properties:
                existing_session_id:
                  type: string
                  format: uuid
                  description: Optional existing session ID for validation
            example:
              existing_session_id: null
      responses:
        '200':
          description: Session created successfully
          headers:
            X-User-ID:
              schema:
                type: string
                format: uuid
              description: User ID for subsequent requests
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/SessionResponse'
        '500':
          $ref: '#/components/responses/InternalError'

  /auth/magic-link/request:
    post:
      tags:
        - Authentication
      summary: Request magic link email
      description: |
        Sends a magic link to the specified email address for passwordless authentication.
        Rate limited to prevent abuse.
      operationId: requestMagicLink
      security: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/MagicLinkRequest'
      responses:
        '202':
          description: Magic link email queued for delivery
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/MagicLinkRequestResponse'
        '400':
          $ref: '#/components/responses/ValidationError'
        '429':
          $ref: '#/components/responses/RateLimitError'

  /auth/magic-link/verify:
    post:
      tags:
        - Authentication
      summary: Verify magic link token
      description: |
        Verifies a magic link token and creates an authenticated session.

        **FR-004, FR-005**: This operation is atomic. Concurrent verification attempts
        for the same token will result in exactly one success and all others receiving
        a 409 Conflict response.
      operationId: verifyMagicLink
      security: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/MagicLinkVerifyRequest'
      responses:
        '200':
          description: Token verified, session created
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/AuthenticatedSessionResponse'
        '400':
          $ref: '#/components/responses/ValidationError'
        '409':
          description: Token already used (race condition protection)
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
              example:
                error: token_already_used
                message: This magic link has already been verified
                code: TOKEN_ALREADY_USED
        '410':
          description: Token expired
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
              example:
                error: token_expired
                message: This magic link has expired. Please request a new one.
                code: TOKEN_EXPIRED

  /auth/session:
    get:
      tags:
        - Session Management
      summary: Get current session status
      description: |
        Returns the current session status including expiry time.
        Used by frontend to sync session state with backend.

        **FR-011**: Frontend MUST call this periodically to sync state.
      operationId: getSessionStatus
      security:
        - BearerAuth: []
        - UserIdHeader: []
      responses:
        '200':
          description: Session is valid
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/SessionStatusResponse'
        '401':
          $ref: '#/components/responses/UnauthorizedError'
        '403':
          description: Session has been revoked
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
              example:
                error: session_revoked
                message: Your session has been revoked. Please sign in again.
                code: SESSION_REVOKED
                details:
                  reason: Security incident response

    delete:
      tags:
        - Session Management
      summary: Sign out (invalidate session)
      description: |
        Invalidates the current session server-side.
        Client should clear local storage after this call.
      operationId: signOut
      security:
        - BearerAuth: []
        - UserIdHeader: []
      responses:
        '204':
          description: Session invalidated successfully
        '401':
          $ref: '#/components/responses/UnauthorizedError'

  /auth/session/refresh:
    post:
      tags:
        - Session Management
      summary: Refresh session expiry
      description: |
        Extends the session expiry time (sliding window).

        **FR-010**: Session expiry MUST be extended on user activity.
      operationId: refreshSession
      security:
        - BearerAuth: []
        - UserIdHeader: []
      requestBody:
        content:
          application/json:
            schema:
              type: object
              properties:
                refresh_token:
                  type: string
                  description: Refresh token (if using token rotation)
      responses:
        '200':
          description: Session refreshed
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/SessionRefreshResponse'
        '401':
          $ref: '#/components/responses/UnauthorizedError'
        '403':
          description: Session revoked or refresh token invalid
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

  /auth/merge:
    post:
      tags:
        - Account Operations
      summary: Merge anonymous account into authenticated account
      description: |
        Merges data from an anonymous account into the authenticated account.

        **FR-013, FR-014, FR-015**: This operation uses tombstone markers for
        idempotency. Partial failures can be retried safely without creating duplicates.
      operationId: mergeAccount
      security:
        - BearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/MergeRequest'
      responses:
        '200':
          description: Merge completed successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/MergeResponse'
        '400':
          $ref: '#/components/responses/ValidationError'
        '401':
          $ref: '#/components/responses/UnauthorizedError'
        '409':
          description: Merge conflict (source already merged)
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
              example:
                error: merge_conflict
                message: Source account has already been merged
                code: MERGE_CONFLICT
                details:
                  merged_to: existing-target-user-id
                  merged_at: "2025-12-01T00:00:00Z"

  /users/lookup:
    get:
      tags:
        - Account Operations
      summary: Look up user by email
      description: |
        Checks if a user exists with the given email address.
        Uses GSI for O(1) lookup performance.

        **FR-009**: Email lookup MUST use GSI query (not table scan).
      operationId: lookupUserByEmail
      security:
        - BearerAuth: []
        - UserIdHeader: []
      parameters:
        - name: email
          in: query
          required: true
          schema:
            type: string
            format: email
          description: Email address to look up
      responses:
        '200':
          description: User found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/UserLookupResponse'
        '404':
          description: No user with this email
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
              example:
                error: user_not_found
                message: No user found with this email address
                code: USER_NOT_FOUND
        '401':
          $ref: '#/components/responses/UnauthorizedError'

  /admin/sessions/revoke:
    post:
      tags:
        - Account Operations
      summary: Revoke sessions (admin/andon cord)
      description: |
        Bulk revokes sessions for incident response.
        Integrates with andon cord system.

        **FR-016, FR-017**: Supports server-side revocation for all session types.
      operationId: revokeSessions
      security:
        - BearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/RevokeSessionsRequest'
      responses:
        '200':
          description: Sessions revoked
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/RevokeSessionsResponse'
        '401':
          $ref: '#/components/responses/UnauthorizedError'
        '403':
          description: Insufficient permissions for bulk revocation
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

components:
  securitySchemes:
    BearerAuth:
      type: http
      scheme: bearer
      description: JWT access token in Authorization header
    UserIdHeader:
      type: apiKey
      in: header
      name: X-User-ID
      description: User ID header (legacy, accepted for backward compatibility)

  schemas:
    SessionResponse:
      type: object
      required:
        - user_id
        - auth_type
        - session_expires_at
        - access_token
      properties:
        user_id:
          type: string
          format: uuid
          description: Unique user identifier
        auth_type:
          type: string
          enum: [anonymous, email, google, github]
          description: Authentication method
        session_expires_at:
          type: string
          format: date-time
          description: Session expiry timestamp (ISO 8601)
        access_token:
          type: string
          description: JWT access token for API requests
        is_new_session:
          type: boolean
          description: Whether this is a newly created session
      example:
        user_id: "550e8400-e29b-41d4-a716-446655440000"
        auth_type: anonymous
        session_expires_at: "2026-01-01T00:00:00Z"
        access_token: "eyJhbGciOiJIUzI1NiIs..."
        is_new_session: true

    AuthenticatedSessionResponse:
      allOf:
        - $ref: '#/components/schemas/SessionResponse'
        - type: object
          required:
            - email
          properties:
            email:
              type: string
              format: email
              description: User's email address
            merged_items_count:
              type: integer
              description: Number of items merged from anonymous account
      example:
        user_id: "550e8400-e29b-41d4-a716-446655440000"
        auth_type: email
        email: "alice@example.com"
        session_expires_at: "2026-03-01T00:00:00Z"
        access_token: "eyJhbGciOiJIUzI1NiIs..."
        is_new_session: false
        merged_items_count: 3

    SessionStatusResponse:
      type: object
      required:
        - user_id
        - auth_type
        - session_expires_at
        - is_valid
      properties:
        user_id:
          type: string
          format: uuid
        auth_type:
          type: string
          enum: [anonymous, email, google, github]
        email:
          type: string
          format: email
          nullable: true
        session_expires_at:
          type: string
          format: date-time
        is_valid:
          type: boolean
          description: Whether session is currently valid
        remaining_seconds:
          type: integer
          description: Seconds until session expires
        revoked:
          type: boolean
          description: Whether session has been revoked
      example:
        user_id: "550e8400-e29b-41d4-a716-446655440000"
        auth_type: anonymous
        email: null
        session_expires_at: "2026-01-01T00:00:00Z"
        is_valid: true
        remaining_seconds: 2592000
        revoked: false

    SessionRefreshResponse:
      type: object
      required:
        - session_expires_at
        - access_token
      properties:
        session_expires_at:
          type: string
          format: date-time
          description: New session expiry timestamp
        access_token:
          type: string
          description: New access token (if rotated)
        refresh_token:
          type: string
          description: New refresh token (if rotated)
      example:
        session_expires_at: "2026-01-15T00:00:00Z"
        access_token: "eyJhbGciOiJIUzI1NiIs..."

    MagicLinkRequest:
      type: object
      required:
        - email
      properties:
        email:
          type: string
          format: email
          description: Email address to send magic link
        captcha_token:
          type: string
          description: hCaptcha verification token
        anonymous_user_id:
          type: string
          format: uuid
          description: Current anonymous user ID for account merge
      example:
        email: "alice@example.com"
        captcha_token: "P0_eyJhbGciOiJIUzI1..."
        anonymous_user_id: "550e8400-e29b-41d4-a716-446655440000"

    MagicLinkRequestResponse:
      type: object
      required:
        - message
        - expires_in_seconds
      properties:
        message:
          type: string
          description: User-friendly status message
        expires_in_seconds:
          type: integer
          description: Magic link validity period
        email_masked:
          type: string
          description: Masked email for confirmation
      example:
        message: "Magic link sent to your email"
        expires_in_seconds: 3600
        email_masked: "a***@example.com"

    MagicLinkVerifyRequest:
      type: object
      required:
        - token
        - signature
      properties:
        token:
          type: string
          format: uuid
          description: Magic link token ID from email
        signature:
          type: string
          pattern: "^[a-f0-9]{64}$"
          description: HMAC-SHA256 signature from email
      example:
        token: "550e8400-e29b-41d4-a716-446655440001"
        signature: "a1b2c3d4e5f6789012345678901234567890abcdef1234567890abcdef123456"

    MergeRequest:
      type: object
      required:
        - source_user_id
      properties:
        source_user_id:
          type: string
          format: uuid
          description: Anonymous user ID to merge from
        idempotency_key:
          type: string
          format: uuid
          description: Client-generated key for retry safety
      example:
        source_user_id: "550e8400-e29b-41d4-a716-446655440000"
        idempotency_key: "550e8400-e29b-41d4-a716-446655440002"

    MergeResponse:
      type: object
      required:
        - source_user_id
        - target_user_id
        - items_merged
        - status
      properties:
        source_user_id:
          type: string
          format: uuid
        target_user_id:
          type: string
          format: uuid
        items_merged:
          type: integer
          description: Number of items transferred
        items_skipped:
          type: integer
          description: Items already merged (idempotency)
        status:
          type: string
          enum: [completed, partial, already_merged]
      example:
        source_user_id: "550e8400-e29b-41d4-a716-446655440000"
        target_user_id: "550e8400-e29b-41d4-a716-446655440003"
        items_merged: 5
        items_skipped: 0
        status: completed

    UserLookupResponse:
      type: object
      required:
        - exists
      properties:
        exists:
          type: boolean
          description: Whether user exists
        user_id:
          type: string
          format: uuid
          description: User ID (only if exists=true)
        auth_type:
          type: string
          enum: [anonymous, email, google, github]
          description: How user authenticated
      example:
        exists: true
        user_id: "550e8400-e29b-41d4-a716-446655440000"
        auth_type: email

    RevokeSessionsRequest:
      type: object
      required:
        - reason
      properties:
        user_ids:
          type: array
          items:
            type: string
            format: uuid
          description: Specific user IDs to revoke (null = all)
        scope:
          type: string
          enum: [specific, all_anonymous, all_authenticated, all]
          default: specific
          description: Revocation scope
        reason:
          type: string
          maxLength: 500
          description: Reason for revocation (audit trail)
        incident_id:
          type: string
          description: Related incident tracking ID
      example:
        user_ids: null
        scope: all
        reason: "Security incident SI-2025-001 - credential exposure"
        incident_id: "SI-2025-001"

    RevokeSessionsResponse:
      type: object
      required:
        - revoked_count
        - status
      properties:
        revoked_count:
          type: integer
          description: Number of sessions revoked
        status:
          type: string
          enum: [completed, in_progress]
        estimated_completion_seconds:
          type: integer
          description: For large-scale revocations
      example:
        revoked_count: 1500
        status: completed

    ErrorResponse:
      type: object
      required:
        - error
        - message
        - code
      properties:
        error:
          type: string
          description: Machine-readable error type
        message:
          type: string
          description: Human-readable error message
        code:
          type: string
          description: Error code for client handling
        details:
          type: object
          additionalProperties: true
          description: Additional error context
      example:
        error: validation_error
        message: Invalid email format
        code: INVALID_EMAIL
        details:
          field: email
          provided: "not-an-email"

  responses:
    ValidationError:
      description: Request validation failed
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/ErrorResponse'
          example:
            error: validation_error
            message: Request validation failed
            code: VALIDATION_ERROR
            details:
              errors:
                - field: email
                  message: Invalid email format

    UnauthorizedError:
      description: Authentication required
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/ErrorResponse'
          example:
            error: unauthorized
            message: Authentication required
            code: UNAUTHORIZED

    RateLimitError:
      description: Rate limit exceeded
      headers:
        Retry-After:
          schema:
            type: integer
          description: Seconds until rate limit resets
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/ErrorResponse'
          example:
            error: rate_limit_exceeded
            message: Too many requests. Please try again later.
            code: RATE_LIMIT_EXCEEDED
            details:
              retry_after_seconds: 60

    InternalError:
      description: Internal server error
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/ErrorResponse'
          example:
            error: internal_error
            message: An unexpected error occurred
            code: INTERNAL_ERROR
