# Implementation Plan: Fix Lambda ZIP Packaging Structure

**Branch**: `427-fix-lambda-zip-packaging` | **Date**: 2025-12-18 | **Spec**: [spec.md](./spec.md)
**Input**: Feature specification from `/specs/427-fix-lambda-zip-packaging/spec.md`

## Summary

Fix the Lambda ZIP packaging in deploy.yml to preserve directory structure (`src/lambdas/<name>/`) instead of flat copying. The ingestion Lambda (and potentially others) fail with `Runtime.ImportModuleError` because handlers use absolute imports (`from src.lambdas.ingestion.alerting`) but files are copied flat to package root. Apply the dashboard Lambda's correct packaging pattern to all affected Lambdas.

## Technical Context

**Language/Version**: YAML (GitHub Actions), HCL (Terraform)
**Primary Dependencies**: GitHub Actions, AWS Lambda, S3 artifact storage
**Storage**: N/A (CI/CD workflow configuration only)
**Testing**: E2E Lambda invocation tests, docker-import validator static analysis
**Target Platform**: GitHub Actions CI/CD, AWS Lambda (ZIP deployment)
**Project Type**: CI/CD workflow fix (single repository)
**Performance Goals**: No impact on deployment time or Lambda cold start latency
**Constraints**: Must not break existing Lambda deployments, must maintain backward compatibility
**Scale/Scope**: 4 ZIP-based Lambdas (ingestion, analysis, metrics, notification)

## Constitution Check

*GATE: Must pass before Phase 0 research. Re-check after Phase 1 design.*

| Gate | Status | Evidence |
|------|--------|----------|
| 5. Deployment Requirements | PASS | Uses GitHub Actions + Terraform (existing pattern) |
| 7. Testing & Validation | PASS | E2E tests will verify Lambda invocation works |
| 8. Git Workflow & CI/CD | PASS | Fix goes through normal PR process, no bypass |
| 8. Pipeline Check Bypass | PASS | No bypass - fix must pass all checks |

**Pre-Check Result**: PASS - No constitution violations. This is a configuration fix following existing patterns.

## Project Structure

### Documentation (this feature)

```text
specs/427-fix-lambda-zip-packaging/
├── spec.md              # Feature specification (complete)
├── plan.md              # This file
├── research.md          # Phase 0 output (minimal - simple fix)
├── quickstart.md        # Phase 1 output (implementation guide)
├── checklists/          # Quality checklists
└── tasks.md             # Phase 2 output (generated by /speckit.tasks)
```

### Source Code (repository root)

```text
# Files to modify
.github/workflows/deploy.yml     # Primary target - fix packaging steps

# Files for reference (correct pattern)
.github/workflows/deploy.yml     # Dashboard packaging (lines 219-228)
.github/workflows/deploy.yml     # SSE packaging (lines 537-580)

# Validation
src/validators/docker_import.py  # LPK-* patterns (in template repo)
```

**Structure Decision**: This is a workflow configuration fix, not a code change. Only `.github/workflows/deploy.yml` needs modification.

## Complexity Tracking

> No violations - this is a minimal configuration fix.

| Aspect | Complexity | Justification |
|--------|------------|---------------|
| Files Changed | 1 | Only deploy.yml |
| Lines Changed | ~40 | 4 Lambdas × ~10 lines each |
| Risk | Low | Applying known-working pattern |
| Testing | E2E | Lambda invocation tests cover the fix |

## Phase 0: Research Summary

**Research Needed**: Minimal - the fix pattern is already established in the same file.

### Reference Implementation (Dashboard Lambda - lines 219-228)

```yaml
# CORRECT PATTERN - preserves directory structure
mkdir -p packages/dashboard-build/src/lambdas/dashboard packages/dashboard-build/src/lib
cp -r packages/dashboard-deps/* packages/dashboard-build/
cp -r src/lambdas/dashboard/* packages/dashboard-build/src/lambdas/dashboard/
cp -r src/lambdas/shared packages/dashboard-build/src/lambdas/
cp -r src/lib/* packages/dashboard-build/src/lib/
```

### Broken Implementation (Ingestion Lambda - lines 154-159)

```yaml
# INCORRECT PATTERN - copies flat to root
mkdir -p packages/ingestion-build/src/lambdas packages/ingestion-build/src/lib
cp -r packages/ingestion-deps/* packages/ingestion-build/
cp -r src/lambdas/ingestion/* packages/ingestion-build/           # <-- WRONG
cp -r src/lambdas/shared packages/ingestion-build/src/lambdas/
cp -r src/lib/* packages/ingestion-build/src/lib/
```

### Root Cause

Line 157 copies ingestion files to `packages/ingestion-build/` (flat) instead of `packages/ingestion-build/src/lambdas/ingestion/` (structured).

### Affected Lambdas

| Lambda | Location | Status |
|--------|----------|--------|
| ingestion | lines 154-166 | BROKEN (flat copy) |
| dashboard | lines 219-228 | OK (structured copy) |
| analysis | lines 269-280 | NEEDS CHECK |
| metrics | lines 309-320 | NEEDS CHECK |
| notification | lines 359-370 | NEEDS CHECK |

## Phase 1: Implementation Approach

### Fix Pattern

For each affected Lambda, change:
```yaml
# FROM (broken)
cp -r src/lambdas/<name>/* packages/<name>-build/

# TO (fixed)
mkdir -p packages/<name>-build/src/lambdas/<name>
cp -r src/lambdas/<name>/* packages/<name>-build/src/lambdas/<name>/
```

### Validation Steps

1. **Static Analysis**: Run docker-import validator, expect 0 LPK-003 findings
2. **Build Test**: Deploy to preprod, verify Lambda packages contain correct structure
3. **Invocation Test**: Invoke each Lambda, verify no ImportModuleError
4. **E2E Test**: Run existing E2E test suite

### Terraform Handler Configuration

Verify handlers are already configured correctly:
```hcl
handler = "src.lambdas.ingestion.handler.lambda_handler"  # Should match ZIP structure
```

## Constitution Re-Check (Post-Design)

| Gate | Status | Notes |
|------|--------|-------|
| 5. Deployment Requirements | PASS | Uses existing GitHub Actions patterns |
| 7. Testing & Validation | PASS | E2E tests cover Lambda invocation |
| 8. Git Workflow & CI/CD | PASS | Normal PR process, all checks required |

**Post-Design Result**: PASS - Ready for task generation.

## Next Steps

1. `/speckit.tasks` - Generate implementation tasks
2. `/speckit.implement` - Execute tasks
3. Verify with docker-import validator
4. Deploy to preprod and test Lambda invocation
