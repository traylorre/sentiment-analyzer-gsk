%% High-Level System Overview - Terraform-Accurate
%% Last updated: 2026-01-18
%% Canonical source: infrastructure/terraform/
%% Feature 1208: CloudFront removed - Amplify serves frontend directly

graph LR
    %% External Sources
    Tiingo[Tiingo API<br/>Financial News<br/>500 req/day]
    Finnhub[Finnhub API<br/>Market Data<br/>60 req/min]
    SendGrid[SendGrid<br/>Email Delivery]
    Browser[Web Browser<br/>Dashboard + SSE]

    %% Entry Points
    EventBridge[EventBridge<br/>Schedulers]
    APIGateway[API Gateway<br/>REST /api/*]

    %% Lambda Functions (6 total per Terraform)
    Ingestion["ingestion-lambda<br/>512MB | 60s<br/>Parallel fetch"]
    Analysis["analysis-lambda<br/>2048MB | 60s<br/>DistilBERT container"]
    Dashboard["dashboard-lambda<br/>1024MB | 60s<br/>Powertools"]
    SSE["sse-streaming-lambda<br/>512MB | 900s<br/>RESPONSE_STREAM"]
    Notification["notification-lambda<br/>256MB | 30s<br/>Alerts + Digests"]
    Metrics["metrics-lambda<br/>128MB | 30s<br/>Stuck item monitor"]

    %% Authentication (v3.0)
    Cognito[Cognito User Pool<br/>OAuth: Google + GitHub<br/>Magic Link<br/>JWT jti claim generation<br/>Roles: anon→free→paid→operator]
    Secrets[Secrets Manager<br/>API Keys<br/>JWT_SECRET]

    %% Messaging
    SNS[SNS Topic<br/>analysis-requests]
    DLQ[SQS DLQ<br/>14-day retention]

    %% Storage (7 DynamoDB tables per Terraform)
    Items[(sentiment-items<br/>News + Scores<br/>TTL: 30d)]
    Users[(sentiment-users<br/>Configs · Alerts<br/>Identity links)]
    Timeseries[(sentiment-timeseries<br/>Multi-Resolution<br/>1m→24h)]
    OHLC[(ohlc-cache<br/>Price Data)]
    OAuthStates[(oauth-states<br/>PKCE: code_verifier<br/>TTL: 5min)]
    MagicTokens[(magic-link-tokens<br/>Random tokens<br/>TTL: 1h · Atomic)]
    Sessions[(sessions<br/>Refresh tokens<br/>TTL: 7d · Eviction)]
    S3Model[S3<br/>ML Models]

    %% Frontend (Feature 1208: Amplify serves frontend directly)
    Amplify[Amplify<br/>Next.js SSR<br/>Primary Frontend]

    %% Monitoring
    CloudWatch["CloudWatch<br/>Logs · Alarms · RUM"]

    %% User Request Flow (Feature 1208: Direct to Amplify/API) - thick lines for primary paths
    Browser ==>|HTTPS| Amplify
    Browser ==>|/api/*| APIGateway
    Browser ==>|/api/v2/stream*| SSE
    Browser -.->|OAuth redirect| Cognito

    %% Auth flows (v3.0 federation)
    Cognito -.->|JWT + jti| Dashboard
    Cognito -.->|JWT validate| SSE
    Secrets -.->|API keys| Ingestion
    Secrets -.->|JWT_SECRET| Dashboard
    Dashboard -->|PKCE state| OAuthStates
    Dashboard -->|Magic tokens| MagicTokens
    Dashboard -->|Session mgmt| Sessions
    Dashboard -->|Identity links| Users

    %% Federation: Identity Linking
    Browser -.->|OAuth: Google| Cognito
    Browser -.->|OAuth: GitHub| Cognito
    Cognito -.->|Auto-link same domain| Users

    %% Ingestion Pipeline (5-minute schedule)
    EventBridge -->|rate(5 min)| Ingestion
    Tiingo ==>|GET /news| Ingestion
    Finnhub ==>|GET /news| Ingestion
    Ingestion -->|GetSecret| Secrets
    Ingestion ==>|Publish batch| SNS
    Ingestion -->|Store raw| Items

    %% Analysis Pipeline
    SNS ==>|Subscribe| Analysis
    Analysis -->|Load model| S3Model
    Analysis ==>|UpdateItem| Items
    Analysis -->|Fanout 8x| Timeseries
    Analysis -.->|Failed| DLQ

    %% API Layer
    APIGateway ==>|Invoke| Dashboard
    Dashboard ==>|Query| Items
    Dashboard -->|User data| Users
    Dashboard -->|OHLC| OHLC

    %% SSE Streaming
    SSE ==>|Poll every 5s| Items
    SSE -->|Timeseries| Timeseries
    SSE -.->|Stream events| Browser

    %% Notifications (hourly schedule for digests)
    EventBridge -->|cron(0 * * * ? *)| Notification
    Notification -->|Read configs| Users
    Notification -->|Send| SendGrid

    %% Metrics (1-minute schedule)
    EventBridge -->|rate(1 min)| Metrics
    Metrics -->|by_status GSI| Items
    Metrics -->|Emit| CloudWatch

    %% Logging (dotted = async)
    Ingestion -.->|Logs| CloudWatch
    Analysis -.->|Logs| CloudWatch
    Dashboard -.->|Logs| CloudWatch
    SSE -.->|Logs| CloudWatch
    Notification -.->|Logs| CloudWatch
    Metrics -.->|Logs| CloudWatch

    %% Styling - using existing color palette
    classDef external fill:#E3F2FD,stroke:#1565C0,stroke-width:3px
    classDef lambda fill:#E1BEE7,stroke:#7B1FA2,stroke-width:3px
    classDef messaging fill:#FCE4EC,stroke:#C2185B,stroke-width:3px
    classDef database fill:#C8E6C9,stroke:#388E3C,stroke-width:3px
    classDef support fill:#B2DFDB,stroke:#00796B,stroke-width:3px
    classDef cdn fill:#FFECB3,stroke:#F57C00,stroke-width:3px
    classDef auth fill:#F3E5F5,stroke:#6A1B9A,stroke-width:3px

    class Tiingo,Finnhub,SendGrid,Browser external
    class Ingestion,Analysis,Dashboard,SSE,Notification,Metrics lambda
    class EventBridge,APIGateway,SNS,DLQ messaging
    class Items,Users,Timeseries,OHLC,OAuthStates,MagicTokens,Sessions,S3Model database
    class CloudWatch support
    class Amplify cdn
    class Cognito,Secrets auth
