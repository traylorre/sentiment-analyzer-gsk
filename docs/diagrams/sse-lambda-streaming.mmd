%%{init: {'theme': 'base', 'themeVariables': { 'primaryColor': '#673AB7', 'secondaryColor': '#FF5722', 'tertiaryColor': '#4CAF50'}}}%%
sequenceDiagram
    autonumber
    participant Browser as Browser<br/>(EventSource API)
    participant LWA as Lambda Function URL<br/>(Custom Runtime)
    participant Handler as SSE Handler<br/>(sse_streaming)
    participant Pool as Connection Manager<br/>(Max 100)
    participant DDB as DynamoDB<br/>(sentiment-items)
    participant CW as CloudWatch<br/>(Metrics)

    Note over Browser,CW: SSE Connection Lifecycle

    %% Connection Establishment
    rect rgb(232, 245, 233)
        Note right of Browser: Phase 1: Connection Setup
        Browser->>+LWA: GET /api/v2/stream<br/>Accept: text/event-stream
        LWA->>LWA: Translate HTTP/1.1 â†’ Lambda<br/>RESPONSE_STREAM invoke mode
        LWA->>+Handler: HTTP Request
        Handler->>+Pool: acquire_connection(user_id)

        alt Connection Pool Full (100 max)
            Pool-->>Handler: ConnectionPoolExhausted
            Handler-->>LWA: 503 Service Unavailable<br/>Retry-After: 30
            LWA-->>Browser: 503 + Retry-After header
        else Connection Available
            Pool->>Pool: Create SSEConnection<br/>UUID, filters, timestamp
            Pool-->>Handler: connection_id
            Handler-->>LWA: 200 OK<br/>Content-Type: text/event-stream
            LWA-->>Browser: Connection established
        end
    end

    %% Streaming Phase
    rect rgb(227, 242, 253)
        Note right of Browser: Phase 2: Event Streaming
        loop Every 5 seconds (polling interval)
            Handler->>+DDB: Scan with filter<br/>timestamp > last_poll
            DDB-->>-Handler: New sentiment items

            alt New Items Found
                Handler->>Handler: Format SSE event<br/>event: sentiment_update<br/>id: uuid<br/>data: JSON
                Handler-->>LWA: yield event bytes
                LWA-->>Browser: SSE event
                Browser->>Browser: onmessage handler<br/>Update dashboard UI
            end
        end

        loop Every 30 seconds (heartbeat)
            Handler->>Handler: Generate heartbeat<br/>event: heartbeat<br/>id: uuid<br/>data: {}
            Handler-->>LWA: yield heartbeat bytes
            LWA-->>Browser: Heartbeat event
            Note over LWA: Lambda Function URL<br/>supports 15min timeout
        end

        Handler->>+CW: PutMetricData<br/>ConnectionCount, Latency
        CW-->>-Handler: OK
    end

    %% Disconnection
    rect rgb(255, 243, 224)
        Note right of Browser: Phase 3: Disconnect & Cleanup
        alt User Closes Tab
            Browser-xLWA: Connection closed
            LWA-xHandler: Request cancelled
        else Network Error
            LWA-xHandler: Timeout after 15min
            Handler->>Handler: Connection terminated
        else Client Reconnect
            Browser->>Browser: EventSource auto-reconnect<br/>with Last-Event-ID
        end

        Handler->>+Pool: release_connection(connection_id)
        Pool->>Pool: Remove from active set<br/>Decrement counter
        Pool-->>-Handler: Released
        Handler->>CW: PutMetricData<br/>ConnectionClosed
        deactivate Handler
        deactivate LWA
    end

    Note over Browser,CW: Config-Specific Streams

    %% Config Stream Variant
    rect rgb(243, 229, 245)
        Note right of Browser: Authenticated Config Stream
        Browser->>LWA: GET /api/v2/configurations/{id}/stream<br/>?user_token=xxx
        LWA->>Handler: Request with auth
        Handler->>+DDB: GetItem config<br/>Validate user access
        DDB-->>-Handler: Config with ticker_filters
        Handler->>Pool: acquire_connection<br/>with ticker_filters: [AAPL, MSFT]
        Pool-->>Handler: Filtered connection

        loop Polling with Filter
            Handler->>DDB: Scan with ticker filter
            DDB-->>Handler: Matching items only
            Handler-->>Browser: Filtered events
        end
    end
