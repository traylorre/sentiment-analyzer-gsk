%%{init: {"theme": "dark", "themeVariables": {"primaryColor": "#4A90A4", "secondaryColor": "#F5A623", "tertiaryColor": "#2d2d2d", "lineColor": "#88CCFF", "primaryTextColor": "#FFFFFF", "secondaryTextColor": "#FFFFFF", "tertiaryTextColor": "#FFFFFF", "nodeTextColor": "#FFFFFF", "edgeLabelBackground": "#333333", "clusterBkg": "#2d2d2d", "clusterBorder": "#555555"}, "flowchart": {"curve": "basis", "nodeSpacing": 60, "rankSpacing": 100}}}%%
flowchart TB
    subgraph External["External Services"]
        Tiingo["Tiingo API<br/>Financial News"]
        Finnhub["Finnhub API<br/>Market Data"]
        OAuthProviders["OAuth Providers<br/>Google, GitHub"]
    end

    subgraph EventBridge["Amazon EventBridge"]
        Schedule["Schedule Rule<br/>(5 min)"]
    end

    subgraph AmplifyFE["Amplify Frontend"]
        AmplifyApp["Amplify App<br/>Next.js SSR<br/>Auto-deploy from GitHub"]
    end

    subgraph APIGateway["API Gateway"]
        APIGW["REST API<br/>CORS: allow_credentials=true<br/>Routes to Lambda"]
    end

    subgraph Frontend["Static Frontend"]
        S3["S3 Bucket<br/>Interview Dashboard"]
    end

    subgraph Auth["Authentication (Cognito)"]
        Cognito["Cognito User Pool<br/>OAuth: Google, GitHub<br/>Magic Link<br/>JWT jti generation"]
    end

    subgraph Lambda["AWS Lambda Functions"]
        Ingestion["Ingestion Lambda<br/>512MB / 60s<br/>EventBridge trigger"]
        Analysis["Analysis Lambda<br/>1024MB / 30s<br/>SNS trigger"]
        Dashboard["Dashboard Lambda<br/>512MB / 60s<br/>REST API + Auth<br/>/api/v2/* routes<br/>PKCE, CSRF, Sessions"]
        SSE["SSE Lambda<br/>512MB / 60s<br/>RESPONSE_STREAM<br/>JWT validation"]
        Metrics["Metrics Lambda<br/>128MB / 30s<br/>EventBridge 1min<br/>StuckItems metric"]
        Notification["Notification Lambda<br/>256MB / 30s<br/>SNS + EventBridge<br/>SendGrid emails"]
    end

    subgraph Storage["Data Storage"]
        DynamoDB["DynamoDB<br/>sentiment-items"]
        AuthTables["DynamoDB Auth Tables<br/>• oauth_states (PKCE, 5m TTL)<br/>• magic_link_tokens (1h TTL)<br/>• sessions (7d TTL)"]
        Secrets["Secrets Manager<br/>API Keys<br/>JWT_SECRET"]
    end

    subgraph Messaging["Messaging"]
        SNS["SNS Topic<br/>analysis-requests"]
        DLQ["SQS DLQ<br/>Failed Messages"]
    end

    subgraph Monitoring["Monitoring & Alerts"]
        CloudWatch["CloudWatch<br/>Logs & Metrics"]
        Alarms["CloudWatch Alarms<br/>11 Configured"]
    end

    subgraph Users["Users"]
        Browser["Web Browser"]
    end

    %% User Request Flow (via Amplify + API Gateway)
    Browser -->|HTTPS| AmplifyApp
    AmplifyApp -->|Static assets| S3
    Browser -->|API calls| APIGW
    APIGW -->|"/api/v2/*"| Dashboard
    Browser -->|"/api/v2/stream*"| SSE

    %% Authentication Flow (handled by Dashboard Lambda)
    Dashboard -->|OAuth redirect| Cognito
    Cognito -->|OAuth callback| OAuthProviders
    OAuthProviders -->|tokens| Cognito
    Cognito -->|JWT with jti| Dashboard
    Dashboard -->|PKCE state| AuthTables
    Dashboard -->|Magic link tokens| AuthTables
    Dashboard -->|Sessions| AuthTables
    Dashboard -->|JWT_SECRET| Secrets
    Dashboard -.->|Set-Cookie: refresh_token<br/>HttpOnly, Secure, SameSite=None| Browser

    %% Data Ingestion Flow
    Schedule -->|Trigger| Ingestion
    Tiingo -->|Financial News| Ingestion
    Finnhub -->|Market Data| Ingestion
    Secrets -->|API Key| Ingestion
    Ingestion -->|Store Items| DynamoDB
    Ingestion -->|Publish| SNS

    %% Analysis Flow
    SNS -->|Trigger| Analysis
    SNS -->|Failed| DLQ
    Analysis -->|Update Items| DynamoDB
    Secrets -->|Model Config| Analysis

    %% API Flow
    Dashboard -->|Query| DynamoDB
    Secrets -->|API Key| Dashboard

    %% SSE Streaming Flow
    SSE -->|Poll/Scan| DynamoDB
    SSE -.->|Stream Events| Browser

    %% Metrics Lambda Flow
    Schedule -->|1min trigger| Metrics
    Metrics -->|Query by_status GSI| DynamoDB
    Metrics -->|StuckItems metric| CloudWatch

    %% Notification Lambda Flow
    SNS -->|Alert trigger| Notification
    Notification -->|User lookup| DynamoDB
    Notification -->|SendGrid API| External

    %% Monitoring
    Ingestion -->|Logs| CloudWatch
    Analysis -->|Logs| CloudWatch
    Dashboard -->|Logs| CloudWatch
    SSE -->|Logs| CloudWatch
    Metrics -->|Logs| CloudWatch
    Notification -->|Logs| CloudWatch
    CloudWatch -->|Triggers| Alarms

    %% Styling - Dark theme with white text
    classDef external fill:#8B6914,stroke:#F5A623,stroke-width:2px,color:#FFFFFF
    classDef lambda fill:#2B5F7C,stroke:#4A90A4,stroke-width:2px,color:#FFFFFF
    classDef storage fill:#3D6B3D,stroke:#7ED321,stroke-width:2px,color:#FFFFFF
    classDef messaging fill:#8B4513,stroke:#D0021B,stroke-width:2px,color:#FFFFFF
    classDef monitoring fill:#4B3D6B,stroke:#9013FE,stroke-width:2px,color:#FFFFFF
    classDef cdn fill:#6B3D5C,stroke:#E91E63,stroke-width:2px,color:#FFFFFF
    classDef frontend fill:#2B6B6B,stroke:#00BCD4,stroke-width:2px,color:#FFFFFF
    classDef auth fill:#8B3D3D,stroke:#FF5252,stroke-width:2px,color:#FFFFFF
    classDef gateway fill:#3D3D6B,stroke:#3F51B5,stroke-width:2px,color:#FFFFFF

    class Tiingo,Finnhub,OAuthProviders external
    class Ingestion,Analysis,Dashboard,SSE,Metrics,Notification lambda
    class DynamoDB,AuthTables,Secrets storage
    class SNS,DLQ messaging
    class CloudWatch,Alarms monitoring
    class S3 frontend
    class Cognito auth
    class APIGW gateway
