%%{init: {'theme': 'base', 'themeVariables': { 'primaryColor': '#4A90A4', 'secondaryColor': '#F5A623', 'tertiaryColor': '#7ED321'}}}%%
flowchart TB
    subgraph External["External Services"]
        NewsAPI["NewsAPI<br/>News Articles"]
        OAuthProviders["OAuth Providers<br/>Google, GitHub"]
    end

    subgraph EventBridge["Amazon EventBridge"]
        Schedule["Schedule Rule<br/>(5 min)"]
    end

    subgraph CDN["CloudFront CDN"]
        CF["CloudFront Distribution<br/>Multi-Origin Routing<br/>Forwards: Authorization, Cookies"]
    end

    subgraph APIGateway["API Gateway"]
        APIGW["REST API<br/>CORS: allow_credentials=true<br/>Routes to Lambda"]
    end

    subgraph Frontend["Static Frontend"]
        S3["S3 Bucket<br/>Interview Dashboard"]
    end

    subgraph Auth["Authentication (Cognito)"]
        Cognito["Cognito User Pool<br/>OAuth: Google, GitHub<br/>Magic Link<br/>JWT jti generation"]
    end

    subgraph Lambda["AWS Lambda Functions"]
        Ingestion["Ingestion Lambda<br/>512MB / 60s"]
        Analysis["Analysis Lambda<br/>1024MB / 30s"]
        AuthLambda["Auth Lambda<br/>512MB / 30s<br/>/api/v2/auth/*<br/>PKCE, CSRF, Sessions"]
        Dashboard["Dashboard Lambda<br/>512MB / 60s<br/>REST API<br/>@require_role decorator"]
        SSE["SSE Lambda<br/>512MB / 60s<br/>RESPONSE_STREAM<br/>JWT validation"]
    end

    subgraph Storage["Data Storage"]
        DynamoDB["DynamoDB<br/>sentiment-items"]
        AuthTables["DynamoDB Auth Tables<br/>• oauth_states (PKCE, 5m TTL)<br/>• magic_link_tokens (1h TTL)<br/>• sessions (7d TTL)"]
        Secrets["Secrets Manager<br/>API Keys<br/>JWT_SECRET"]
    end

    subgraph Messaging["Messaging"]
        SNS["SNS Topic<br/>analysis-requests"]
        DLQ["SQS DLQ<br/>Failed Messages"]
    end

    subgraph Monitoring["Monitoring & Alerts"]
        CloudWatch["CloudWatch<br/>Logs & Metrics"]
        Alarms["CloudWatch Alarms<br/>11 Configured"]
    end

    subgraph Users["Users"]
        Browser["Web Browser"]
    end

    %% User Request Flow (via CloudFront → API Gateway)
    Browser -->|HTTPS| CF
    CF -->|"/static/*"| S3
    CF -->|"/api/*"| APIGW
    APIGW -->|"/api/v2/auth/*"| AuthLambda
    APIGW -->|"/api/v2/*"| Dashboard
    CF -->|"/api/v2/stream*"| SSE

    %% Authentication Flow
    AuthLambda -->|OAuth redirect| Cognito
    Cognito -->|OAuth callback| OAuthProviders
    OAuthProviders -->|tokens| Cognito
    Cognito -->|JWT with jti| AuthLambda
    AuthLambda -->|PKCE state| AuthTables
    AuthLambda -->|Magic link tokens| AuthTables
    AuthLambda -->|Sessions| AuthTables
    AuthLambda -->|JWT_SECRET| Secrets
    AuthLambda -.->|Set-Cookie: refresh_token<br/>HttpOnly, Secure, SameSite=None| Browser

    %% Data Ingestion Flow
    Schedule -->|Trigger| Ingestion
    NewsAPI -->|Articles| Ingestion
    Secrets -->|API Key| Ingestion
    Ingestion -->|Store Items| DynamoDB
    Ingestion -->|Publish| SNS

    %% Analysis Flow
    SNS -->|Trigger| Analysis
    SNS -->|Failed| DLQ
    Analysis -->|Update Items| DynamoDB
    Secrets -->|Model Config| Analysis

    %% API Flow
    Dashboard -->|Query| DynamoDB
    Secrets -->|API Key| Dashboard

    %% SSE Streaming Flow
    SSE -->|Poll/Scan| DynamoDB
    SSE -.->|Stream Events| Browser

    %% Monitoring
    Ingestion -->|Logs| CloudWatch
    Analysis -->|Logs| CloudWatch
    Dashboard -->|Logs| CloudWatch
    SSE -->|Logs| CloudWatch
    CloudWatch -->|Triggers| Alarms

    %% Styling
    classDef external fill:#FFE4B5,stroke:#F5A623,stroke-width:2px
    classDef lambda fill:#D4E8F2,stroke:#4A90A4,stroke-width:2px
    classDef storage fill:#D4F2D4,stroke:#7ED321,stroke-width:2px
    classDef messaging fill:#F2E4D4,stroke:#D0021B,stroke-width:2px
    classDef monitoring fill:#E8E4F2,stroke:#9013FE,stroke-width:2px
    classDef cdn fill:#F2D4E8,stroke:#E91E63,stroke-width:2px
    classDef frontend fill:#D4F2F2,stroke:#00BCD4,stroke-width:2px
    classDef auth fill:#FFD4D4,stroke:#FF5252,stroke-width:2px
    classDef gateway fill:#D4D4FF,stroke:#3F51B5,stroke-width:2px

    class NewsAPI,OAuthProviders external
    class Ingestion,Analysis,AuthLambda,Dashboard,SSE lambda
    class DynamoDB,AuthTables,Secrets storage
    class SNS,DLQ messaging
    class CloudWatch,Alarms monitoring
    class CF cdn
    class S3 frontend
    class Cognito auth
    class APIGW gateway
