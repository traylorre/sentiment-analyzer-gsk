name: "[3/4] Preprod Integration Tests"

# Pipeline Stage 3: Run integration tests against preprod environment
#
# Triggers: Automatically when pipeline-2 (deploy preprod) completes successfully
#
# Flow:
#   pipeline-2 completes → Run integration tests → Tag artifact as validated
#
# For On-Call:
#   - If this fails, preprod has the deployment but it's not validated
#   - Failed tests prevent promotion to production
#   - Check test output for specific test failures
#   - Common issues: missing secrets, API rate limits, data inconsistencies

on:
  workflow_run:
    workflows: ["[2/4] Deploy to Preprod"]
    types: [completed]
    branches: [main]

  # Manual trigger for re-testing
  workflow_dispatch:
    inputs:
      skip_tests:
        description: 'Skip integration tests (use cautiously!)'
        required: false
        default: 'false'
        type: choice
        options:
          - 'false'
          - 'true'
      artifact_sha:
        description: 'Git SHA of artifact being tested (7 chars)'
        required: false
        type: string

permissions:
  contents: read
  actions: read    # For downloading artifacts

jobs:
  integration-tests:
    name: Preprod Integration Tests
    runs-on: ubuntu-latest
    # Only run if deploy succeeded or manual trigger
    if: ${{ github.event.workflow_run.conclusion == 'success' || github.event_name == 'workflow_dispatch' }}
    environment: preprod

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Determine Artifact SHA
        id: determine_sha
        run: |
          if [ "${{ github.event_name }}" == "workflow_dispatch" ] && [ -n "${{ github.event.inputs.artifact_sha }}" ]; then
            SHA="${{ github.event.inputs.artifact_sha }}"
          else
            # Get SHA from the deploy workflow that triggered us
            SHA="${{ github.event.workflow_run.head_sha }}"
            SHA="${SHA:0:7}"
          fi

          # Strip 'v' prefix if present (GitHub UI may add it)
          SHA="${SHA#v}"

          echo "sha=${SHA}" >> $GITHUB_OUTPUT

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -e .
          pip install -r requirements-dev.txt

      - name: Configure AWS Credentials (Preprod)
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.PREPROD_AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.PREPROD_AWS_SECRET_ACCESS_KEY }}
          aws-region: us-east-1

      - name: Get Preprod Infrastructure Outputs
        id: infra
        run: |
          # Get Terraform outputs from preprod environment
          cd infrastructure/terraform
          terraform init -backend-config=backend-preprod.hcl -reconfigure

          SNS_TOPIC_ARN=$(terraform output -raw sns_topic_arn 2>/dev/null || echo "")
          echo "sns_topic_arn=${SNS_TOPIC_ARN}" >> $GITHUB_OUTPUT

      - name: Run Preprod Integration Tests
        if: github.event.inputs.skip_tests != 'true'
        env:
          AWS_DEFAULT_REGION: us-east-1
          AWS_REGION: us-east-1
          ENVIRONMENT: preprod
          DYNAMODB_TABLE: preprod-sentiment-items
          SNS_TOPIC_ARN: ${{ steps.infra.outputs.sns_topic_arn }}
          NEWSAPI_SECRET_ARN: ${{ secrets.PREPROD_NEWSAPI_SECRET_ARN }}
          DASHBOARD_API_KEY: ${{ secrets.PREPROD_DASHBOARD_API_KEY }}
          WATCH_TAGS: AI,climate,economy
          MODEL_VERSION: v${{ steps.determine_sha.outputs.sha }}
        run: |
          # Run ONLY preprod integration tests (real AWS)
          pytest tests/integration/test_*_preprod.py \
            -v \
            --tb=short \
            --junitxml=preprod-test-results.xml

      - name: Upload Test Results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: preprod-test-results-${{ steps.determine_sha.outputs.sha }}
          path: preprod-test-results.xml
          retention-days: 30

      - name: Tag Artifact as Preprod-Validated
        if: success()
        run: |
          SHA="${{ steps.determine_sha.outputs.sha }}"
          echo "✅ Integration tests passed!"
          echo "Artifact lambda-packages-${SHA} is PREPROD-VALIDATED"
          echo "Ready for production deployment"

          # Create validation metadata
          cat > validated.json <<EOF
          {
            "artifact_name": "lambda-packages-${SHA}",
            "validation_timestamp": "$(date -u +%Y-%m-%dT%H:%M:%SZ)",
            "preprod_tests_passed": true,
            "validated_by_workflow": "${GITHUB_RUN_ID}",
            "git_sha": "${GITHUB_SHA}",
            "ready_for_production": true
          }
          EOF

          cat validated.json

      - name: Upload Validation Metadata
        if: success()
        uses: actions/upload-artifact@v4
        with:
          name: validation-${{ steps.determine_sha.outputs.sha }}
          path: validated.json
          retention-days: 90

      - name: Report Test Failure
        if: failure()
        run: |
          echo "::error title=[3/5] Tests Failed::❌ Preprod integration tests FAILED

          Stage: Preprod Integration Tests
          Failed at: ${{ github.job }}
          Artifact: lambda-packages-${{ steps.determine_sha.outputs.sha }}

          View logs: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}

          Recovery steps:
          1. Check test output for specific failures
          2. Verify preprod environment is healthy
          3. Check secret values (NewsAPI key, dashboard API key)
          4. Review recent code changes for bugs
          5. Re-run: gh run rerun ${{ github.run_id }} --repo ${{ github.repository }}

          Common issues:
          - Secret not found: Check PREPROD_NEWSAPI_SECRET_ARN
          - DynamoDB errors: Check table exists and has correct schema
          - API rate limits: Wait and retry
          - Network timeouts: Check Lambda timeout settings"
