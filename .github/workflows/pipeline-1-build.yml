name: "[1/5] Build Artifacts"

# Pipeline Stage 1: Build Lambda packages once, version with Git SHA
#
# Flow:
#   Merge to main â†’ Build ONCE â†’ Upload artifacts
#
# Key Innovation: Lambda packages built ONCE, tagged with Git SHA,
# then promoted through environments. Each environment deploys the EXACT
# same code, ensuring consistency.
#
# Artifact Lifecycle:
#   1. Build: packages/lambda-${SHA}.zip
#   2. Upload: GitHub Artifacts (90-day retention)
#   3. Used by: pipeline-2 (deploy preprod), pipeline-5 (deploy prod)
#
# For On-Call:
#   - If this fails, no environments are updated (safe)
#   - Build failures are typically dependency or packaging issues
#   - Check "Package Lambda Functions" step for errors

on:
  push:
    branches:
      - main
    paths:
      - 'src/**'
      - 'infrastructure/terraform/**'
      - 'tests/integration/test_*_preprod.py'
      - '.github/workflows/pipeline-*.yml'

  # Manual trigger for testing
  workflow_dispatch:

permissions:
  contents: read
  actions: write   # For artifact management

jobs:
  build:
    name: Build Lambda Packages
    runs-on: ubuntu-latest

    outputs:
      artifact-sha: ${{ steps.package.outputs.sha }}
      artifact-name: ${{ steps.package.outputs.name }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python 3.11
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: Package Lambda Functions
        id: package
        run: |
          # Use first 7 characters of Git SHA for package versioning
          SHA="${GITHUB_SHA:0:7}"
          echo "sha=${SHA}" >> $GITHUB_OUTPUT
          echo "name=lambda-packages-${SHA}" >> $GITHUB_OUTPUT

          echo "ğŸ“¦ Building Lambda packages for commit: ${SHA}"
          mkdir -p packages

          # Package Ingestion Lambda
          echo "Building ingestion Lambda..."
          cd src/lambdas/ingestion
          zip -r ../../../packages/ingestion-${SHA}.zip . \
            -x "*.pyc" \
            -x "__pycache__/*" \
            -x "*.pytest_cache/*" \
            -x "tests/*"
          cd ../../..

          # Package Analysis Lambda
          echo "Building analysis Lambda..."
          cd src/lambdas/analysis
          zip -r ../../../packages/analysis-${SHA}.zip . \
            -x "*.pyc" \
            -x "__pycache__/*" \
            -x "*.pytest_cache/*" \
            -x "tests/*"
          cd ../../..

          # Package Dashboard Lambda
          echo "Building dashboard Lambda..."
          cd src/lambdas/dashboard
          zip -r ../../../packages/dashboard-${SHA}.zip . \
            -x "*.pyc" \
            -x "__pycache__/*" \
            -x "*.pytest_cache/*" \
            -x "tests/*"
          cd ../../..

          # Verify packages created
          ls -lh packages/
          echo "âœ… Lambda packages built successfully"

      - name: Upload Lambda Packages as Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: ${{ steps.package.outputs.name }}
          path: packages/
          retention-days: 90  # Keep for 3 months (rollback window)
          if-no-files-found: error

      - name: Create Build Manifest
        run: |
          SHA="${GITHUB_SHA:0:7}"
          cat > packages/build-manifest.json <<EOF
          {
            "git_sha": "${GITHUB_SHA}",
            "git_sha_short": "${SHA}",
            "git_ref": "${GITHUB_REF}",
            "build_timestamp": "$(date -u +%Y-%m-%dT%H:%M:%SZ)",
            "actor": "${GITHUB_ACTOR}",
            "workflow_run_id": "${GITHUB_RUN_ID}",
            "workflow_run_number": "${GITHUB_RUN_NUMBER}"
          }
          EOF

          echo "ğŸ“‹ Build Manifest:"
          cat packages/build-manifest.json

      - name: Upload Build Manifest
        uses: actions/upload-artifact@v4
        with:
          name: build-manifest-${{ steps.package.outputs.sha }}
          path: packages/build-manifest.json
          retention-days: 90

      - name: Report Build Failure
        if: failure()
        run: |
          echo "::error title=[1/5] Build Failed::âŒ Lambda package build FAILED

          Stage: Build Artifacts
          Failed at: ${{ github.job }}

          View logs: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}

          Recovery steps:
          1. Check dependency installation errors
          2. Verify Lambda source code compiles
          3. Re-run: gh run rerun ${{ github.run_id }} --repo ${{ github.repository }}"
