# Security Scanning Workflow
# =========================
#
# Scans dependencies for known vulnerabilities using pip-audit.
# Runs on every push and PR, plus weekly schedule for ongoing protection.
#
# For On-Call Engineers:
#   If this workflow fails:
#   1. Check the vulnerability report in the workflow output
#   2. Update affected packages in requirements.txt/requirements-dev.txt
#   3. Test locally before pushing fixes
#   4. For critical vulnerabilities, consider immediate patching
#
# For Developers:
#   - pip-audit checks against PyPI advisory database
#   - Vulnerabilities are reported with CVE IDs and severity
#   - Some false positives may occur; use --ignore-vuln to suppress

name: "PR Check: Security Scan"

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]
  schedule:
    # Run weekly on Monday at 9am UTC to catch new CVEs
    - cron: '0 9 * * 1'
  workflow_dispatch:
    # Allow manual trigger for immediate scanning

jobs:
  pip-audit:
    name: Dependency Vulnerability Scan
    runs-on: ubuntu-latest

    permissions:
      contents: read
      security-events: write  # For uploading SARIF results

    steps:
      - name: Checkout code
        uses: actions/checkout@v6

      - name: Set up Python 3.13
        uses: actions/setup-python@v6
        with:
          python-version: '3.13'
          cache: 'pip'

      - name: Install pip-audit
        run: pip install pip-audit

      - name: Scan production dependencies
        run: |
          echo "Scanning production dependencies..."
          pip-audit -r requirements.txt --format json --output prod-audit.json || true
          pip-audit -r requirements.txt --format markdown
        continue-on-error: true

      - name: Scan development dependencies
        run: |
          echo "Scanning development dependencies..."
          pip-audit -r requirements-dev.txt --format json --output dev-audit.json || true
          pip-audit -r requirements-dev.txt --format markdown
        continue-on-error: true

      - name: Check for critical vulnerabilities
        run: |
          # Fail if any HIGH or CRITICAL vulnerabilities found
          echo "Checking for critical vulnerabilities..."

          # Count vulnerabilities by severity
          if [ -f prod-audit.json ]; then
            PROD_VULNS=$(cat prod-audit.json | python -c "
          import json, sys
          data = json.load(sys.stdin)
          vulns = data.get('dependencies', [])
          count = sum(1 for v in vulns if v.get('vulns'))
          print(count)
          " 2>/dev/null || echo "0")
            echo "Production vulnerabilities found: $PROD_VULNS"
          fi

          if [ -f dev-audit.json ]; then
            DEV_VULNS=$(cat dev-audit.json | python -c "
          import json, sys
          data = json.load(sys.stdin)
          vulns = data.get('dependencies', [])
          count = sum(1 for v in vulns if v.get('vulns'))
          print(count)
          " 2>/dev/null || echo "0")
            echo "Development vulnerabilities found: $DEV_VULNS"
          fi

          # For now, just report - don't fail the build
          # Uncomment next line to enforce zero vulnerabilities:
          # if [ "$PROD_VULNS" -gt 0 ]; then exit 1; fi

      - name: Upload audit results
        uses: actions/upload-artifact@v5
        if: always()
        with:
          name: pip-audit-results
          path: |
            prod-audit.json
            dev-audit.json
          retention-days: 90

  # Additional security checks can be added here
  # For example: bandit, safety, trivy for containers
