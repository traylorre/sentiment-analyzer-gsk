name: "[4/4] Deploy to Production"

# This workflow deploys VALIDATED artifacts to production.
#
# CRITICAL FEATURES:
#   1. Conditional Environment Gating:
#      - Dependabot PRs ‚Üí production-auto (no approval)
#      - Human PRs ‚Üí production (requires @traylorre approval)
#
#   2. Artifact Promotion:
#      - Downloads SAME package tested in preprod
#      - No rebuild = no build variance
#
#   3. Automatic Rollback:
#      - Canary failure ‚Üí rollback to previous SHA
#      - CloudWatch alarms ‚Üí rollback
#
# For On-Call:
#   - This workflow ONLY runs after preprod validation passes
#   - If prod deploy fails, check "Terraform Apply" step
#   - If canary fails, automatic rollback triggers
#   - Check CloudWatch alarms for root cause

on:
  # Trigger after preprod integration tests succeed
  workflow_run:
    workflows: ["[3/4] Preprod Integration Tests"]
    types: [completed]
    branches: [main]

  # Manual trigger for emergency deploys or rollbacks
  workflow_dispatch:
    inputs:
      artifact_sha:
        description: 'Git SHA to deploy (leave empty for latest)'
        required: false
        type: string
      skip_canary:
        description: 'Skip canary test (emergency only!)'
        required: false
        default: 'false'
        type: choice
        options:
          - 'false'
          - 'true'

permissions:
  contents: read
  id-token: write
  actions: read

# Prevent concurrent production deployments to avoid Terraform state conflicts
# Both production and production-auto use the same concurrency group
concurrency:
  group: deploy-production
  cancel-in-progress: false  # Wait for current deployment to finish

jobs:
  # ========================================================================
  # JOB 0: Check if Preprod Validation Passed
  # ========================================================================
  check-preprod-validation:
    name: Verify Preprod Validation
    runs-on: ubuntu-latest
    if: github.event_name == 'workflow_run'

    outputs:
      should_deploy: ${{ steps.check.outputs.should_deploy }}
      artifact_sha: ${{ steps.metadata.outputs.sha }}

    steps:
      - name: Check Preprod Workflow Status
        id: check
        run: |
          if [ "${{ github.event.workflow_run.conclusion }}" == "success" ]; then
            echo "‚úÖ Preprod validation passed"
            echo "should_deploy=true" >> $GITHUB_OUTPUT
          else
            echo "‚ùå Preprod validation failed - BLOCKING prod deployment"
            echo "should_deploy=false" >> $GITHUB_OUTPUT
            echo "::error::Preprod validation must pass before deploying to production"
          fi

      - name: Get Build Metadata
        id: metadata
        if: steps.check.outputs.should_deploy == 'true'
        run: |
          # Extract SHA from the workflow that triggered this
          SHA=$(echo "${{ github.event.workflow_run.head_sha }}" | cut -c1-7)
          echo "sha=${SHA}" >> $GITHUB_OUTPUT
          echo "Deploying artifact for commit: ${SHA}"

  # ========================================================================
  # JOB 1: Deploy to Production
  # ========================================================================
  deploy-production:
    name: Deploy to Production
    needs: check-preprod-validation
    if: |
      (github.event_name == 'workflow_run' && needs.check-preprod-validation.outputs.should_deploy == 'true') ||
      github.event_name == 'workflow_dispatch'
    runs-on: ubuntu-latest

    # CRITICAL: Conditional environment based on PR author
    # - Dependabot ‚Üí production-auto (no approval required)
    # - Human ‚Üí production (requires manual approval)
    environment:
      name: ${{ github.actor == 'dependabot[bot]' && 'production-auto' || 'production' }}

    defaults:
      run:
        working-directory: infrastructure/terraform

    outputs:
      deployed_sha: ${{ steps.deploy.outputs.sha }}
      dashboard_url: ${{ steps.outputs.outputs.dashboard_url }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Determine Deployment SHA
        id: determine_sha
        run: |
          if [ "${{ github.event_name }}" == "workflow_dispatch" ] && [ -n "${{ github.event.inputs.artifact_sha }}" ]; then
            # Manual trigger with explicit SHA
            SHA="${{ github.event.inputs.artifact_sha }}"
          elif [ "${{ github.event_name }}" == "workflow_dispatch" ]; then
            # Manual trigger without SHA - use latest
            SHA="${GITHUB_SHA:0:7}"
          else
            # Triggered by preprod workflow
            SHA="${{ needs.check-preprod-validation.outputs.artifact_sha }}"
          fi

          # Strip 'v' prefix if present (GitHub UI may add it)
          SHA="${SHA#v}"

          echo "sha=${SHA}" >> $GITHUB_OUTPUT
          echo "Deploying SHA: ${SHA}"

      - name: Download Lambda Packages from Preprod Validation
        uses: actions/download-artifact@v4
        with:
          name: lambda-packages-${{ steps.determine_sha.outputs.sha }}
          path: packages/
          # Download from the workflow run that validated this artifact
          run-id: ${{ github.event.workflow_run.id }}

      - name: Verify Validation Metadata Exists
        run: |
          SHA="${{ steps.determine_sha.outputs.sha }}"

          # Check if validation artifact exists (proves preprod tests passed)
          if ! gh api repos/${{ github.repository }}/actions/runs/${{ github.event.workflow_run.id }}/artifacts \
               --jq '.artifacts[] | select(.name == "validation-'${SHA}'") | .name' | grep -q "validation"; then
            echo "‚ùå ERROR: No validation metadata found for ${SHA}"
            echo "This artifact has NOT been validated in preprod!"
            echo "::error::Artifact must pass preprod validation before prod deployment"
            exit 1
          fi

          echo "‚úÖ Validation metadata found - artifact is preprod-validated"
        env:
          GH_TOKEN: ${{ github.token }}

      - name: Configure AWS Credentials (Production)
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.PROD_AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.PROD_AWS_SECRET_ACCESS_KEY }}
          aws-region: us-east-1

      - name: Upload Lambda Packages to S3 (Production)
        run: |
          SHA="${{ steps.determine_sha.outputs.sha }}"
          BUCKET="prod-sentiment-lambda-deployments"

          echo "üì§ Uploading SAME Lambda packages to S3 (production)..."
          echo "IMPORTANT: These are the EXACT packages tested in preprod"

          # Upload with SHA-based versioning (matches preprod)
          # Note: packages/ is relative to workspace root, not working-directory
          aws s3 cp ../../packages/ingestion-${SHA}.zip \
            s3://${BUCKET}/ingestion/lambda.zip \
            --metadata "git-sha=${GITHUB_SHA},build-timestamp=$(date -u +%Y-%m-%dT%H:%M:%SZ),validated-in=preprod"

          aws s3 cp ../../packages/analysis-${SHA}.zip \
            s3://${BUCKET}/analysis/lambda.zip \
            --metadata "git-sha=${GITHUB_SHA},build-timestamp=$(date -u +%Y-%m-%dT%H:%M:%SZ),validated-in=preprod"

          aws s3 cp ../../packages/dashboard-${SHA}.zip \
            s3://${BUCKET}/dashboard/lambda.zip \
            --metadata "git-sha=${GITHUB_SHA},build-timestamp=$(date -u +%Y-%m-%dT%H:%M:%SZ),validated-in=preprod"

          echo "‚úÖ Lambda packages uploaded to S3 (production)"

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: 1.6.0

      - name: Terraform Init (Production)
        run: terraform init -backend-config=backend-prod.hcl -reconfigure

      - name: Terraform Plan (Production)
        id: plan
        run: |
          terraform plan \
            -var-file=prod.tfvars \
            -var="model_version=${{ steps.determine_sha.outputs.sha }}" \
            -no-color \
            -out=prod.tfplan | tee plan.txt

      - name: Terraform Apply (Production)
        id: deploy
        run: |
          SHA="${{ steps.determine_sha.outputs.sha }}"

          echo "üöÄ Deploying to PRODUCTION..."
          echo "Git SHA: ${GITHUB_SHA}"
          echo "Package SHA: ${SHA}"

          terraform apply \
            -auto-approve \
            prod.tfplan

          echo "sha=${SHA}" >> $GITHUB_OUTPUT
          echo "‚úÖ Production deployment complete"

      - name: Get Production Outputs
        id: outputs
        run: |
          DASHBOARD_URL=$(terraform output -raw dashboard_function_url 2>/dev/null || echo "")
          echo "dashboard_url=${DASHBOARD_URL}" >> $GITHUB_OUTPUT
          echo "Production Dashboard URL: ${DASHBOARD_URL}"

  # ========================================================================
  # JOB 2: Run Canary Test
  # ========================================================================
  canary-test:
    name: Production Canary Test
    needs: deploy-production
    runs-on: ubuntu-latest
    environment: production

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: |
          pip install requests

      - name: Run Canary Health Check
        id: canary
        if: github.event.inputs.skip_canary != 'true'
        timeout-minutes: 2
        run: |
          DASHBOARD_URL="${{ needs.deploy-production.outputs.dashboard_url }}"
          API_KEY="${{ secrets.PROD_DASHBOARD_API_KEY }}"

          echo "üîç Running canary test against: ${DASHBOARD_URL}"

          # Test health endpoint
          response=$(curl -f -s -w "\n%{http_code}" \
            "${DASHBOARD_URL}/health" \
            -H "X-API-Key: ${API_KEY}" || echo "FAILED")

          http_code=$(echo "$response" | tail -1)
          body=$(echo "$response" | head -n -1)

          echo "HTTP Status: ${http_code}"
          echo "Response: ${body}"

          if [ "${http_code}" != "200" ]; then
            echo "‚ùå Canary FAILED - Health check returned ${http_code}"
            echo "::error::Production canary test failed with status ${http_code}"
            exit 1
          fi

          # Verify response structure
          if ! echo "$body" | grep -q '"status"'; then
            echo "‚ùå Canary FAILED - Response missing 'status' field"
            exit 1
          fi

          echo "‚úÖ Canary test PASSED"

      - name: Monitor CloudWatch Alarms
        id: alarms
        timeout-minutes: 5
        run: |
          echo "üìä Monitoring CloudWatch alarms for 5 minutes..."

          # Give system time to settle
          sleep 300

          # Check for any ALARM state
          ALARMS=$(aws cloudwatch describe-alarms \
            --alarm-name-prefix "prod-" \
            --state-value ALARM \
            --query 'MetricAlarms[].AlarmName' \
            --output text 2>/dev/null || echo "")

          if [ -n "$ALARMS" ]; then
            echo "‚ùå CloudWatch alarms triggered:"
            echo "$ALARMS"
            echo "::error::Production alarms firing: ${ALARMS}"
            exit 1
          fi

          echo "‚úÖ No alarms triggered - system healthy"
        env:
          AWS_ACCESS_KEY_ID: ${{ secrets.PROD_AWS_ACCESS_KEY_ID }}
          AWS_SECRET_ACCESS_KEY: ${{ secrets.PROD_AWS_SECRET_ACCESS_KEY }}
          AWS_DEFAULT_REGION: us-east-1

  # ========================================================================
  # JOB 3: Rollback on Failure
  # ========================================================================
  rollback:
    name: Rollback on Failure
    needs: [deploy-production, canary-test]
    if: failure()
    runs-on: ubuntu-latest
    environment: production

    defaults:
      run:
        working-directory: infrastructure/terraform

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Get Previous Deployment
        id: previous
        run: |
          # Find the previous successful deployment SHA
          # This queries GitHub Actions for the last successful prod deploy
          PREVIOUS_SHA=$(gh api repos/${{ github.repository }}/actions/workflows/deploy-prod.yml/runs \
            --jq '.workflow_runs[] | select(.conclusion == "success") | .head_sha' \
            | head -1 | cut -c1-7)

          if [ -z "$PREVIOUS_SHA" ]; then
            echo "‚ùå No previous successful deployment found"
            echo "Manual intervention required"
            exit 1
          fi

          echo "previous_sha=${PREVIOUS_SHA}" >> $GITHUB_OUTPUT
          echo "Rolling back to: ${PREVIOUS_SHA}"
        env:
          GH_TOKEN: ${{ github.token }}

      - name: Configure AWS Credentials (Production)
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.PROD_AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.PROD_AWS_SECRET_ACCESS_KEY }}
          aws-region: us-east-1

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: 1.6.0

      - name: Terraform Init (Production)
        run: terraform init -backend-config=backend-prod.hcl -reconfigure

      - name: Rollback to Previous Version
        run: |
          PREVIOUS_SHA="${{ steps.previous.outputs.previous_sha }}"

          echo "üîÑ ROLLING BACK to ${PREVIOUS_SHA}"

          terraform apply \
            -var-file=prod.tfvars \
            -var="model_version=${PREVIOUS_SHA}" \
            -auto-approve

          echo "‚úÖ Rollback complete"
          echo "::warning::Production rolled back to ${PREVIOUS_SHA} due to deployment failure"

      - name: Notify On-Call
        run: |
          echo "üö® PRODUCTION ROLLBACK TRIGGERED"
          echo "Failed SHA: ${{ needs.deploy-production.outputs.deployed_sha }}"
          echo "Rolled back to: ${{ steps.previous.outputs.previous_sha }}"
          echo "::error::Production deployment failed and was rolled back"

  # ========================================================================
  # JOB 4: Notify Results
  # ========================================================================
  notify:
    name: Notify Deployment Results
    needs: [deploy-production, canary-test]
    if: always()
    runs-on: ubuntu-latest

    steps:
      - name: Check Deployment Status
        run: |
          DEPLOY_STATUS="${{ needs.deploy-production.result }}"
          CANARY_STATUS="${{ needs.canary-test.result }}"

          echo "Deploy: ${DEPLOY_STATUS}"
          echo "Canary: ${CANARY_STATUS}"

          if [ "${DEPLOY_STATUS}" == "success" ] && [ "${CANARY_STATUS}" == "success" ]; then
            echo "‚úÖ PRODUCTION DEPLOYMENT SUCCESSFUL"
            echo "SHA: ${{ needs.deploy-production.outputs.deployed_sha }}"
            echo "Dashboard: ${{ needs.deploy-production.outputs.dashboard_url }}"
            echo "::notice::Production deployment succeeded and canary test passed"
            exit 0
          else
            echo "‚ùå PRODUCTION DEPLOYMENT FAILED"
            echo "Rollback should have been triggered"
            echo "::error::Production deployment failed - check rollback job"
            exit 1
          fi
