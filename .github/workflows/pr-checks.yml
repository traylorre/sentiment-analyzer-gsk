# Consolidated PR Checks Workflow
# ================================
#
# Runs all PR quality checks in parallel for faster feedback.
# Consolidates: pr-check-lint.yml, pr-check-test.yml, pr-check-security.yml, pr-check-codeql.yml
#
# For On-Call Engineers:
#   - All jobs run in parallel for fast feedback
#   - Check individual job for failure details
#   - Coverage must be >80% or test job fails
#
# For Developers:
#   - Run locally: make validate && make test-unit
#   - Fix lint: ruff format src/ tests/ && ruff check src/ tests/ --fix

name: PR Checks

on:
  workflow_dispatch:
  push:
    branches: [main]
  pull_request:
    branches: [main]
  schedule:
    # Run weekly on Monday at 9am UTC for security scans
    - cron: '0 9 * * 1'

env:
  PYTHON_VERSION: '3.13'

jobs:
  # ========================================================================
  # JOB 1: Lint (ruff format + ruff check)
  # ========================================================================
  lint:
    name: Lint
    runs-on: ubuntu-latest

    permissions:
      contents: read

    steps:
      - name: Checkout code
        uses: actions/checkout@v6

      - name: Set up Python ${{ env.PYTHON_VERSION }}
        uses: actions/setup-python@v6
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: 'pip'

      - name: Install linting tools
        run: |
          python -m pip install --upgrade pip
          pip install ruff==0.8.4

      - name: Check formatting with ruff
        # Note: Black removed in feat(057) - Ruff formatter preserves pragma comments
        run: ruff format --check --diff src/ tests/

      - name: Check linting with ruff
        run: ruff check src/ tests/

      - name: Check for security issues
        run: ruff check src/ --select S --output-format=github

  # ========================================================================
  # JOB 2: Test (pytest + coverage)
  # ========================================================================
  test:
    name: Run Tests
    runs-on: ubuntu-latest

    permissions:
      contents: read
      checks: write

    steps:
      - name: Checkout code
        uses: actions/checkout@v6

      - name: Set up Python ${{ env.PYTHON_VERSION }}
        uses: actions/setup-python@v6
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: 'pip'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          # Use CI-specific requirements (excludes 2GB+ torch/transformers - tests mock them)
          pip install -r requirements-ci.txt
          pip install -e .

      - name: Run tests with coverage
        run: |
          pytest --ignore=tests/integration/test_analysis_preprod.py \
            --ignore=tests/integration/test_dashboard_preprod.py \
            --ignore=tests/integration/test_canary_preprod.py \
            --ignore=tests/integration/test_ingestion_preprod.py \
            --ignore=tests/integration/test_e2e_lambda_invocation_preprod.py \
            --ignore=tests/integration/test_observability_preprod.py \
            --ignore=tests/e2e \
            --cov=src --cov-report=term-missing --cov-report=xml --junitxml=test-results.xml
        env:
          AWS_REGION: us-east-1
          AWS_ACCESS_KEY_ID: testing
          AWS_SECRET_ACCESS_KEY: testing  # pragma: allowlist secret

      - name: Check coverage threshold
        run: coverage report --fail-under=80

      - name: Upload coverage report
        uses: actions/upload-artifact@v5
        if: always()
        with:
          name: coverage-report
          path: |
            coverage.xml
            test-results.xml
          retention-days: 30

      - name: Comment coverage on PR
        uses: py-cov-action/python-coverage-comment-action@v3
        if: github.event_name == 'pull_request'
        continue-on-error: true
        with:
          GITHUB_TOKEN: ${{ github.token }}
          MINIMUM_GREEN: 80
          MINIMUM_ORANGE: 60

  # ========================================================================
  # JOB 3: Security (pip-audit)
  # ========================================================================
  security:
    name: Dependency Vulnerability Scan
    runs-on: ubuntu-latest

    permissions:
      contents: read
      security-events: write

    steps:
      - name: Checkout code
        uses: actions/checkout@v6

      - name: Set up Python ${{ env.PYTHON_VERSION }}
        uses: actions/setup-python@v6
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: 'pip'

      - name: Install pip-audit
        run: pip install pip-audit

      - name: Scan production dependencies
        run: |
          pip-audit -r requirements.txt --format json --output prod-audit.json || true
          pip-audit -r requirements.txt --format markdown
        continue-on-error: true

      - name: Scan development dependencies
        run: |
          pip-audit -r requirements-dev.txt --format json --output dev-audit.json || true
          pip-audit -r requirements-dev.txt --format markdown
        continue-on-error: true

      - name: Upload audit results
        uses: actions/upload-artifact@v5
        if: always()
        with:
          name: pip-audit-results
          path: |
            prod-audit.json
            dev-audit.json
          retention-days: 90

  # ========================================================================
  # JOB 4: CodeQL Analysis
  # ========================================================================
  codeql:
    name: Analyze
    runs-on: ubuntu-latest

    permissions:
      actions: read
      contents: read
      security-events: write

    strategy:
      fail-fast: false
      matrix:
        language: ['python']

    steps:
      - name: Checkout repository
        uses: actions/checkout@v6

      - name: Initialize CodeQL
        uses: github/codeql-action/init@v4
        with:
          languages: ${{ matrix.language }}
          queries: security-extended
          config-file: ./.github/codeql/codeql-config.yml

      - name: Autobuild
        uses: github/codeql-action/autobuild@v4

      - name: Perform CodeQL Analysis
        uses: github/codeql-action/analyze@v4
        with:
          category: "/language:${{matrix.language}}"

  # ========================================================================
  # JOB 5: Secrets Scan (Gitleaks)
  # ========================================================================
  secrets-scan:
    name: Secrets Scan
    runs-on: ubuntu-latest

    permissions:
      contents: read
      pull-requests: read

    steps:
      - name: Checkout code
        uses: actions/checkout@v6
        with:
          fetch-depth: 0

      - name: Run Gitleaks
        uses: gitleaks/gitleaks-action@v2
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  # ========================================================================
  # JOB 6: Cost Analysis (Infracost - PR only)
  # ========================================================================
  cost:
    name: Cost
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request'

    permissions:
      contents: read
      pull-requests: write

    steps:
      - name: Checkout code
        uses: actions/checkout@v6

      - name: Setup Infracost
        uses: infracost/actions/setup@v3
        with:
          api-key: ${{ secrets.INFRACOST_API_KEY }}

      - name: Checkout base branch
        uses: actions/checkout@v6
        with:
          ref: ${{ github.event.pull_request.base.ref }}
          path: base

      - name: Generate Infracost diff
        run: |
          infracost breakdown --path infrastructure/terraform --format json --out-file /tmp/infracost-base.json || true
          cd ${{ github.workspace }}
          infracost breakdown --path infrastructure/terraform --format json --out-file /tmp/infracost-pr.json || true
          infracost diff --path /tmp/infracost-pr.json --compare-to /tmp/infracost-base.json --format json --out-file /tmp/infracost-diff.json || true
        continue-on-error: true

      - name: Post Infracost comment
        run: |
          infracost comment github \
            --path /tmp/infracost-diff.json \
            --repo $GITHUB_REPOSITORY \
            --github-token ${{ github.token }} \
            --pull-request ${{ github.event.pull_request.number }} \
            --behavior update
        continue-on-error: true
