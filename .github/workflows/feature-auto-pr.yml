# Auto-Create PR Workflow
# ========================
#
# Automatically creates a PR when a feature branch is pushed.
# Makes the development workflow fully continuous.
#
# Flow:
#   1. Push to feature branch (feat/*, fix/*, docs/*)
#   2. Auto-create PR (this workflow)
#   3. Auto-enable auto-merge (pr-auto-merge-enable.yml)
#   4. Run PR checks (lint, test, security, CodeQL)
#   5. Auto-rebase if behind main (pr-auto-rebase.yml)
#   6. Auto-merge when checks pass
#   7. Deploy pipeline runs on main
#
# For On-Call Engineers:
#   - PRs are created automatically on feature branch push
#   - PR title uses conventional commit format from branch name
#   - PR body includes changeset summary
#   - Auto-merge is enabled automatically
#
# For Developers:
#   - Push to feat/*, fix/*, docs/* branch
#   - PR is created automatically
#   - PR will merge when checks pass
#   - To prevent auto-merge: gh pr merge --disable-auto <PR_NUMBER>

name: Auto-Create PR

on:
  push:
    branches:
      - 'feat/**'
      - 'fix/**'
      - 'docs/**'
      - 'refactor/**'
      - 'test/**'
      - 'chore/**'

permissions:
  contents: read
  pull-requests: write

jobs:
  auto-create-pr:
    name: Create PR
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Check if PR already exists
        id: check_pr
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          BRANCH="${{ github.ref_name }}"
          PR_EXISTS=$(gh pr list --head "$BRANCH" --json number --jq '.[0].number // empty')

          if [ -n "$PR_EXISTS" ]; then
            echo "exists=true" >> $GITHUB_OUTPUT
            echo "pr_number=$PR_EXISTS" >> $GITHUB_OUTPUT
            echo "PR #$PR_EXISTS already exists for branch $BRANCH"
          else
            echo "exists=false" >> $GITHUB_OUTPUT
            echo "No PR exists for branch $BRANCH"
          fi

      - name: Generate PR title from branch name
        if: steps.check_pr.outputs.exists == 'false'
        id: pr_title
        run: |
          BRANCH="${{ github.ref_name }}"

          # Extract prefix and description from branch name
          # Examples: feat/add-feature -> feat: Add feature
          #           fix/bug-123 -> fix: Bug 123

          PREFIX=$(echo "$BRANCH" | cut -d'/' -f1)
          DESCRIPTION=$(echo "$BRANCH" | cut -d'/' -f2- | sed 's/-/ /g' | sed 's/\b\(.\)/\u\1/g')

          TITLE="${PREFIX}: ${DESCRIPTION}"
          echo "title=$TITLE" >> $GITHUB_OUTPUT
          echo "Generated PR title: $TITLE"

      - name: Generate PR body
        if: steps.check_pr.outputs.exists == 'false'
        id: pr_body
        run: |
          BRANCH="${{ github.ref_name }}"

          # Get commit messages since divergence from main
          COMMITS=$(git log origin/main..HEAD --pretty=format:"- %s" | head -20)

          # Get changed files
          CHANGED_FILES=$(git diff --name-only origin/main...HEAD | head -20)

          # Create PR body
          cat > /tmp/pr_body.md <<EOF
          ## Summary

          Automated PR created from branch: \`$BRANCH\`

          ## Changes

          ### Commits
          $COMMITS

          ### Files Changed
          \`\`\`
          $CHANGED_FILES
          \`\`\`

          ## Test Plan
          - [ ] All CI checks pass (lint, test, security, CodeQL)
          - [ ] Manual testing completed (if required)

          ---

          ðŸ¤– Auto-created by [Auto-Create PR workflow](.github/workflows/feature-auto-pr.yml)

          This PR will auto-merge once all checks pass.
          To disable auto-merge: \`gh pr merge --disable-auto ${{ github.ref_name }}\`
          EOF

          echo "PR body generated"

      - name: Create Pull Request
        if: steps.check_pr.outputs.exists == 'false'
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          TITLE="${{ steps.pr_title.outputs.title }}"

          gh pr create \
            --title "$TITLE" \
            --body-file /tmp/pr_body.md \
            --base main \
            --head "${{ github.ref_name }}"

          echo "âœ… PR created successfully"

      - name: PR Summary
        run: |
          if [ "${{ steps.check_pr.outputs.exists }}" == "true" ]; then
            echo "âœ“ PR #${{ steps.check_pr.outputs.pr_number }} already exists"
            echo "  View PR: https://github.com/${{ github.repository }}/pull/${{ steps.check_pr.outputs.pr_number }}"
          else
            echo "âœ“ New PR created"
            echo "  Branch: ${{ github.ref_name }}"
            echo "  Title: ${{ steps.pr_title.outputs.title }}"
          fi
