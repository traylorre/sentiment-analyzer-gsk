# PR Approval Enforcement Workflow
#
# Purpose: Enforce that ALL pull requests are approved by @traylorre before merge
# Security: Prevents contributors from merging unapproved changes
# Trigger: Runs on every PR and PR review event
#
# This workflow complements GitHub branch protection rules to ensure:
# 1. @traylorre approval is present
# 2. All automated checks pass
# 3. No bypassing of review requirements

name: PR Approval Enforcement

on:
  pull_request:
    types: [opened, synchronize, reopened, edited]
  pull_request_review:
    types: [submitted, dismissed]

permissions:
  contents: read
  pull-requests: read
  checks: write

jobs:
  enforce-approval:
    name: Require @traylorre Approval
    runs-on: ubuntu-latest

    steps:
      - name: Check for required approval
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            // Get PR details
            const pr = context.payload.pull_request;
            const prNumber = pr ? pr.number : context.payload.pull_request_review.pull_request.number;
            const prAuthor = pr ? pr.user.login : context.payload.pull_request_review.pull_request.user.login;

            // Allow Dependabot PRs to skip manual approval (for unattended operation)
            // These are auto-merged only after all CI checks pass
            if (prAuthor === 'dependabot[bot]') {
              core.info('✅ Dependabot PR - manual approval not required (CI checks still required)');
              return;
            }

            // Allow repo owner's PRs to skip manual approval (solo project)
            if (prAuthor === 'traylorre') {
              core.info('✅ Repo owner PR - manual approval not required (CI checks still required)');
              return;
            }

            // Get reviews for external contributors
            const { data: reviews } = await github.rest.pulls.listReviews({
              owner: context.repo.owner,
              repo: context.repo.repo,
              pull_request_number: prNumber
            });

            // Check if @traylorre has approved
            const requiredReviewer = 'traylorre';
            const hasApproval = reviews.some(review =>
              review.user.login === requiredReviewer &&
              review.state === 'APPROVED'
            );

            if (!hasApproval) {
              core.setFailed(
                `❌ Pull request requires approval from @${requiredReviewer} before merge.\n\n` +
                `This is a security requirement - see CONTRIBUTING.md for details.`
              );
            } else {
              core.info(`✅ Required approval from @${requiredReviewer} is present.`);
            }

  verify-codeowners:
    name: Verify CODEOWNERS Assignment
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v6

      - name: Verify CODEOWNERS file exists
        run: |
          if [ ! -f .github/CODEOWNERS ]; then
            echo "❌ CODEOWNERS file is missing! This is a security violation."
            exit 1
          fi
          echo "✅ CODEOWNERS file exists"

      - name: Verify @traylorre is owner
        run: |
          if ! grep -q "@traylorre" .github/CODEOWNERS; then
            echo "❌ @traylorre is not listed in CODEOWNERS! This is a security violation."
            exit 1
          fi
          echo "✅ @traylorre is listed as code owner"

  check-merge-permissions:
    name: Verify Merge Restrictions
    runs-on: ubuntu-latest

    steps:
      - name: Check PR author cannot merge
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const pr = context.payload.pull_request;
            const prNumber = pr ? pr.number : context.payload.pull_request_review.pull_request.number;
            const prAuthor = pr ? pr.user.login : context.payload.pull_request_review.pull_request.user.login;

            // Get repository permissions for PR author
            try {
              const { data: permission } = await github.rest.repos.getCollaboratorPermissionLevel({
                owner: context.repo.owner,
                repo: context.repo.repo,
                username: prAuthor
              });

              // Only admin (@traylorre) should have write/admin permissions
              if (prAuthor !== 'traylorre' && (permission.permission === 'admin' || permission.permission === 'write')) {
                core.setFailed(
                  `❌ Security violation: Non-admin user ${prAuthor} has write/admin permissions.\n` +
                  `Only @traylorre should have merge permissions.`
                );
              } else {
                core.info(`✅ User ${prAuthor} has appropriate permissions: ${permission.permission}`);
              }
            } catch (error) {
              core.info(`ℹ️ Could not check permissions for ${prAuthor}: ${error.message}`);
            }
