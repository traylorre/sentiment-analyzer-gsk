name: "[2/4] Deploy to Preprod"

# Pipeline Stage 2: Deploy built artifacts to preprod environment
#
# Triggers: Automatically when pipeline-1 (build) completes successfully
#
# Flow:
#   pipeline-1 completes ‚Üí Download artifacts ‚Üí Upload to S3 ‚Üí Terraform deploy
#
# For On-Call:
#   - If this fails, preprod is NOT updated (safe)
#   - Preprod failures do NOT affect prod
#   - Check "Terraform Apply" step for infrastructure errors
#   - Check "Upload to S3" step for deployment errors

on:
  workflow_run:
    workflows: ["[1/4] Build Artifacts"]
    types: [completed]
    branches: [main]

  # Manual trigger for testing/rollback
  workflow_dispatch:
    inputs:
      artifact_sha:
        description: 'Git SHA of artifact to deploy (7 chars)'
        required: true
        type: string

permissions:
  contents: read
  id-token: write  # For OIDC if configured
  actions: read    # For downloading artifacts from workflow_run

# Prevent concurrent preprod deployments to avoid Terraform state conflicts
concurrency:
  group: deploy-preprod
  cancel-in-progress: false  # Wait for current deployment to finish

jobs:
  deploy-preprod:
    name: Deploy to Preprod
    runs-on: ubuntu-latest
    # Only run if build succeeded or manual trigger
    if: ${{ github.event.workflow_run.conclusion == 'success' || github.event_name == 'workflow_dispatch' }}
    environment: preprod  # Uses preprod GitHub Environment secrets

    outputs:
      sns_topic_arn: ${{ steps.outputs.outputs.sns_topic_arn }}
      dashboard_url: ${{ steps.outputs.outputs.dashboard_url }}
      artifact_sha: ${{ steps.determine_sha.outputs.sha }}

    defaults:
      run:
        working-directory: infrastructure/terraform

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Determine Artifact SHA
        id: determine_sha
        run: |
          if [ "${{ github.event_name }}" == "workflow_dispatch" ]; then
            SHA="${{ github.event.inputs.artifact_sha }}"
          else
            # Get SHA from the build workflow that triggered us
            SHA="${{ github.event.workflow_run.head_sha }}"
            SHA="${SHA:0:7}"
          fi

          # Strip 'v' prefix if present (GitHub UI may add it)
          SHA="${SHA#v}"

          echo "sha=${SHA}" >> $GITHUB_OUTPUT
          echo "artifact_name=lambda-packages-${SHA}" >> $GITHUB_OUTPUT

      - name: Find Artifact Run ID
        id: find_artifact
        if: github.event_name == 'workflow_dispatch'
        run: |
          # For manual triggers, we need to find which build run created the artifact
          ARTIFACT_NAME="${{ steps.determine_sha.outputs.artifact_name }}"

          # Query GitHub API for artifact details
          ARTIFACT_INFO=$(gh api repos/${{ github.repository }}/actions/artifacts \
            --jq ".artifacts[] | select(.name == \"${ARTIFACT_NAME}\") | {workflow_run_id: .workflow_run.id, expired}")

          if [ -z "$ARTIFACT_INFO" ]; then
            echo "::error::Artifact ${ARTIFACT_NAME} not found"
            exit 1
          fi

          RUN_ID=$(echo "$ARTIFACT_INFO" | jq -r '.workflow_run_id')
          EXPIRED=$(echo "$ARTIFACT_INFO" | jq -r '.expired')

          if [ "$EXPIRED" == "true" ]; then
            echo "::error::Artifact ${ARTIFACT_NAME} has expired"
            exit 1
          fi

          echo "run_id=${RUN_ID}" >> $GITHUB_OUTPUT
          echo "Found artifact ${ARTIFACT_NAME} from run ${RUN_ID}"
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Download Lambda Packages
        uses: actions/download-artifact@v4
        with:
          name: ${{ steps.determine_sha.outputs.artifact_name }}
          path: packages/
          # For workflow_run, use triggering run ID; for manual, use discovered run ID
          run-id: ${{ github.event.workflow_run.id || steps.find_artifact.outputs.run_id }}
          github-token: ${{ secrets.GITHUB_TOKEN }}

      - name: Configure AWS Credentials (Preprod)
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.PREPROD_AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.PREPROD_AWS_SECRET_ACCESS_KEY }}
          aws-region: us-east-1

      - name: Upload Lambda Packages to S3 (Preprod)
        run: |
          SHA="${{ steps.determine_sha.outputs.sha }}"
          BUCKET="preprod-sentiment-lambda-deployments"

          echo "üì§ Uploading Lambda packages to S3 (preprod)..."

          # Upload with SHA-based versioning
          # Note: packages/ is relative to workspace root, not working-directory
          aws s3 cp ../../packages/ingestion-${SHA}.zip \
            s3://${BUCKET}/ingestion/lambda.zip \
            --metadata "git-sha=${GITHUB_SHA},build-timestamp=$(date -u +%Y-%m-%dT%H:%M:%SZ)"

          aws s3 cp ../../packages/analysis-${SHA}.zip \
            s3://${BUCKET}/analysis/lambda.zip \
            --metadata "git-sha=${GITHUB_SHA},build-timestamp=$(date -u +%Y-%m-%dT%H:%M:%SZ)"

          aws s3 cp ../../packages/dashboard-${SHA}.zip \
            s3://${BUCKET}/dashboard/lambda.zip \
            --metadata "git-sha=${GITHUB_SHA},build-timestamp=$(date -u +%Y-%m-%dT%H:%M:%SZ)"

          echo "‚úÖ Lambda packages uploaded to S3"

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: 1.6.0

      - name: Terraform Init (Preprod)
        run: terraform init -backend-config=backend-preprod.hcl -reconfigure

      - name: Terraform Plan (Preprod)
        id: plan
        run: |
          terraform plan \
            -var-file=preprod.tfvars \
            -var="model_version=${{ steps.determine_sha.outputs.sha }}" \
            -no-color \
            -out=preprod.tfplan | tee plan.txt

          # Check if plan has changes
          if grep -q "No changes" plan.txt; then
            echo "has_changes=false" >> $GITHUB_OUTPUT
          else
            echo "has_changes=true" >> $GITHUB_OUTPUT
          fi

      - name: Terraform Apply (Preprod)
        if: steps.plan.outputs.has_changes == 'true'
        run: |
          terraform apply \
            -auto-approve \
            preprod.tfplan

          echo "‚úÖ Preprod infrastructure deployed"

      - name: Get Preprod Outputs
        id: outputs
        run: |
          # Capture Terraform outputs for integration tests
          DASHBOARD_URL=$(terraform output -raw dashboard_function_url 2>/dev/null || echo "")
          SNS_TOPIC_ARN=$(terraform output -raw sns_topic_arn 2>/dev/null || echo "")

          echo "dashboard_url=${DASHBOARD_URL}" >> $GITHUB_OUTPUT
          echo "sns_topic_arn=${SNS_TOPIC_ARN}" >> $GITHUB_OUTPUT

      - name: Report Deploy Failure
        if: failure()
        run: |
          echo "::error title=[2/5] Deploy Failed::‚ùå Preprod deployment FAILED

          Stage: Deploy to Preprod
          Failed at: ${{ github.job }}
          Artifact: ${{ steps.determine_sha.outputs.artifact_name }}

          View logs: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}

          Recovery steps:
          1. Check Terraform plan/apply errors
          2. Verify AWS credentials and permissions
          3. Check S3 bucket access
          4. Re-run: gh run rerun ${{ github.run_id }} --repo ${{ github.repository }}"
