# Auto-Enable Auto-Merge Workflow
# =================================
#
# Automatically enables auto-merge on all PRs when they are opened.
# PRs will auto-merge once all required status checks pass.
#
# For On-Call Engineers:
#   This workflow enables auto-merge so PRs don't require manual merging.
#   PRs still require:
#   - All status checks to pass (tests, lint, security, CodeQL)
#   - Branch to be up to date with main
#   - All conversations resolved
#
# For Developers:
#   - Auto-merge is enabled automatically on PR creation
#   - PR will merge automatically once all checks pass
#   - Uses squash merge for clean git history
#   - To disable auto-merge: gh pr merge --disable-auto <PR_NUMBER>
#
# IMPORTANT: Workflow Trigger Token
#   This workflow uses REPO_PAT (Personal Access Token) instead of GITHUB_TOKEN.
#   When GITHUB_TOKEN merges a PR, the resulting push to main does NOT trigger
#   other workflows (GitHub security feature to prevent infinite loops).
#   Using a PAT ensures the Deploy Pipeline triggers on merge.
#
#   To set up REPO_PAT:
#   1. Create a PAT at https://github.com/settings/tokens with 'repo' scope
#   2. Add it as a repository secret named REPO_PAT
#   3. If REPO_PAT is not set, falls back to GITHUB_TOKEN (deploy won't auto-trigger)
#
# Security Notes:
#   - All branch protection rules still apply
#   - Status checks must pass before merge
#   - PAT should have minimal required permissions (repo scope only)

name: Enable Auto-Merge

on:
  pull_request_target:
    types: [opened, reopened, ready_for_review]

permissions:
  contents: write
  pull-requests: write

jobs:
  enable-auto-merge:
    runs-on: ubuntu-latest
    # Skip for Dependabot PRs (handled by dependabot-auto-merge.yml)
    if: github.actor != 'dependabot[bot]'

    steps:
      - name: Enable auto-merge
        run: gh pr merge --auto --squash "$PR_URL"
        env:
          PR_URL: ${{ github.event.pull_request.html_url }}
          # Use REPO_PAT to trigger Deploy Pipeline on merge, fallback to GITHUB_TOKEN
          GH_TOKEN: ${{ secrets.REPO_PAT || secrets.GITHUB_TOKEN }}

      - name: Comment on PR
        run: |
          if [ -n "${{ secrets.REPO_PAT }}" ]; then
            DEPLOY_MSG="Deploy Pipeline will trigger automatically on merge."
          else
            DEPLOY_MSG="‚ö†Ô∏è REPO_PAT not configured - Deploy Pipeline will NOT auto-trigger. Run manually after merge."
          fi

          gh pr comment "$PR_URL" --body "ü§ñ Auto-merge enabled. This PR will automatically merge once all required checks pass:
          - ‚úÖ Run Tests
          - ‚úÖ Code Quality
          - ‚úÖ Dependency Vulnerability Scan
          - ‚úÖ Analyze (CodeQL)

          ${DEPLOY_MSG}

          To disable auto-merge: \`gh pr merge --disable-auto ${{ github.event.pull_request.number }}\`"
        env:
          PR_URL: ${{ github.event.pull_request.html_url }}
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
