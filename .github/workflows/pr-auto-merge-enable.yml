# Auto-Enable Auto-Merge Workflow
# =================================
#
# Automatically enables auto-merge on all PRs when they are opened.
# PRs will auto-merge once all required status checks pass.
#
# For On-Call Engineers:
#   This workflow enables auto-merge so PRs don't require manual merging.
#   PRs still require:
#   - All status checks to pass (tests, lint, security, CodeQL)
#   - Branch to be up to date with main
#   - All conversations resolved
#
# For Developers:
#   - Auto-merge is enabled automatically on PR creation
#   - PR will merge automatically once all checks pass
#   - Uses squash merge for clean git history
#   - To disable auto-merge: gh pr merge --disable-auto <PR_NUMBER>
#
# IMPORTANT: Workflow Trigger Token
#   This workflow uses REPO_PAT (fine-grained Personal Access Token) to enable
#   auto-merge. When GITHUB_TOKEN merges a PR, the resulting push to main does
#   NOT trigger other workflows (GitHub security feature to prevent infinite loops).
#   Using a PAT ensures the Deploy Pipeline triggers on merge.
#
#   To set up REPO_PAT (fine-grained token):
#   1. Go to https://github.com/settings/personal-access-tokens/new
#   2. Select repository: sentiment-analyzer-gsk
#   3. Permissions needed:
#      - Contents: Read and write
#      - Pull requests: Read and write
#   4. Add as repository secret named REPO_PAT
#
# Security Notes:
#   - All branch protection rules still apply
#   - Status checks must pass before merge
#   - Uses peter-evans/enable-pull-request-automerge action for fine-grained PAT support

name: Enable Auto-Merge

on:
  pull_request_target:
    types: [opened, reopened, ready_for_review]

permissions:
  contents: write
  pull-requests: write

jobs:
  enable-auto-merge:
    runs-on: ubuntu-latest
    # Skip for Dependabot PRs (handled by dependabot-auto-merge.yml)
    if: github.actor != 'dependabot[bot]'

    steps:
      - name: Enable auto-merge
        uses: peter-evans/enable-pull-request-automerge@v3
        with:
          token: ${{ secrets.REPO_PAT }}
          pull-request-number: ${{ github.event.pull_request.number }}
          merge-method: squash

      - name: Comment on PR
        run: |
          gh pr comment "$PR_URL" --body "ðŸ¤– Auto-merge enabled. This PR will automatically merge once all required checks pass:
          - âœ… Run Tests
          - âœ… Code Quality
          - âœ… Dependency Vulnerability Scan
          - âœ… Analyze (CodeQL)

          Deploy Pipeline will trigger automatically on merge.

          To disable auto-merge: \`gh pr merge --disable-auto ${{ github.event.pull_request.number }}\`"
        env:
          PR_URL: ${{ github.event.pull_request.html_url }}
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
