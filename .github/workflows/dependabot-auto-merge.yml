# Dependabot Auto-Merge Workflow
# ================================
#
# Automatically merges Dependabot PRs that pass all checks.
# Essential for 1-year unattended operation.
#
# For On-Call Engineers:
#   This workflow auto-merges dependency updates when:
#   1. PR is created by Dependabot
#   2. All CI checks pass (tests, lint, security)
#   3. Update is minor/patch version (not major)
#
#   If a PR is NOT auto-merged, it means:
#   - Tests failed (investigate)
#   - Security scan failed (CVE in new version)
#   - Major version bump (needs manual review)
#
# For Developers:
#   - Uses GitHub's auto-merge feature
#   - Requires branch protection with status checks
#   - Major version updates require manual approval
#   - Security updates are expedited (merged immediately)
#
# Security Notes:
#   - Only Dependabot PRs are auto-merged
#   - All status checks must pass
#   - GITHUB_TOKEN has limited permissions

name: Dependabot Auto-Merge

on:
  pull_request_target:
    types: [opened, synchronize, reopened]

permissions:
  contents: write
  pull-requests: write

jobs:
  dependabot-auto-merge:
    runs-on: ubuntu-latest
    if: github.actor == 'dependabot[bot]'

    steps:
      - name: Fetch Dependabot metadata
        id: metadata
        uses: dependabot/fetch-metadata@v2
        with:
          github-token: "${{ secrets.GITHUB_TOKEN }}"

      - name: Auto-merge patch and minor updates
        if: steps.metadata.outputs.update-type == 'version-update:semver-patch' || steps.metadata.outputs.update-type == 'version-update:semver-minor'
        run: gh pr merge --auto --squash "$PR_URL"
        env:
          PR_URL: ${{ github.event.pull_request.html_url }}
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Auto-merge security updates (any version)
        if: steps.metadata.outputs.dependency-type == 'direct:production' && contains(github.event.pull_request.title, 'security')
        run: gh pr merge --auto --squash "$PR_URL"
        env:
          PR_URL: ${{ github.event.pull_request.html_url }}
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Approve PR
        if: steps.metadata.outputs.update-type == 'version-update:semver-patch' || steps.metadata.outputs.update-type == 'version-update:semver-minor'
        run: gh pr review --approve "$PR_URL"
        env:
          PR_URL: ${{ github.event.pull_request.html_url }}
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Comment on major version updates
        if: steps.metadata.outputs.update-type == 'version-update:semver-major'
        run: |
          gh pr comment "$PR_URL" --body "⚠️ **Major version update detected**

          This PR updates \`${{ steps.metadata.outputs.dependency-names }}\` to a new major version.

          Major updates may contain breaking changes and require manual review:
          1. Check the changelog for breaking changes
          2. Review test results
          3. Test locally if needed
          4. Merge manually when ready

          This PR will NOT be auto-merged."
        env:
          PR_URL: ${{ github.event.pull_request.html_url }}
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
