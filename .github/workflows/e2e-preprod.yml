# E2E Tests (Preprod) Workflow
# =============================
#
# Runs end-to-end tests against the preprod AWS environment.
#
# IMPORTANT: This workflow uses REAL AWS resources in preprod.
# - Purpose: Validate complete system integration before production
# - Tests: Full E2E flows with real DynamoDB, Lambda, SNS, etc.
# - Cost: Incurs AWS API costs (test data cleanup minimizes impact)
#
# For On-Call Engineers:
# - If tests fail, check "Run E2E Tests" step for details
# - Test reports are uploaded as artifacts for detailed analysis
# - Failures here indicate potential issues before they hit production
#
# For Developers:
# - Do NOT run preprod tests locally (use moto-based tests instead)
# - Manual trigger available for on-demand validation
# - Tests run automatically on push to main branch

name: E2E Tests (Preprod)

on:
  push:
    branches: [main]
    paths:
      - 'src/**'
      - 'tests/e2e/**'
      - 'infrastructure/terraform/**'
      - '.github/workflows/e2e-preprod.yml'
  workflow_dispatch:
    inputs:
      test_markers:
        description: 'Pytest markers to filter tests (e.g., "us1 or us2")'
        required: false
        default: ''
      verbose:
        description: 'Enable verbose output'
        required: false
        type: boolean
        default: false

env:
  AWS_REGION: us-east-1
  ENVIRONMENT: preprod
  PYTHON_VERSION: '3.13'

jobs:
  e2e:
    name: E2E Tests
    runs-on: ubuntu-latest
    environment: preprod
    timeout-minutes: 30

    permissions:
      contents: read
      checks: write

    steps:
      - name: Checkout code
        uses: actions/checkout@v6

      - name: Set up Python ${{ env.PYTHON_VERSION }}
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: 'pip'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements-dev.txt
          # Install package in editable mode for src imports
          pip install -e .

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v5
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Create reports directory
        run: mkdir -p reports

      - name: Run E2E Tests
        id: e2e_tests
        run: |
          PYTEST_ARGS="tests/e2e/ \
            --junitxml=reports/e2e-results.xml \
            -v \
            --tb=short \
            -m preprod"

          # Add marker filter if provided
          if [ -n "${{ github.event.inputs.test_markers }}" ]; then
            PYTEST_ARGS="$PYTEST_ARGS -m '${{ github.event.inputs.test_markers }}'"
          fi

          # Add verbose flag if requested
          if [ "${{ github.event.inputs.verbose }}" = "true" ]; then
            PYTEST_ARGS="$PYTEST_ARGS -vv"
          fi

          pytest $PYTEST_ARGS
        env:
          PREPROD_API_URL: ${{ secrets.PREPROD_API_URL }}
          PREPROD_DYNAMODB_TABLE: ${{ secrets.PREPROD_DYNAMODB_TABLE }}
          TEST_EMAIL_DOMAIN: ${{ secrets.TEST_EMAIL_DOMAIN }}

      - name: Upload test results
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: e2e-test-results
          path: |
            reports/e2e-results.xml
          retention-days: 30

      - name: Publish test results
        uses: dorny/test-reporter@v2
        if: always()
        with:
          name: E2E Test Results
          path: reports/e2e-results.xml
          reporter: java-junit
          fail-on-error: true

      - name: Cleanup test data
        if: always()
        run: |
          # Run cleanup to remove test data created during this run
          python -c "
          import asyncio
          import os
          import boto3

          async def cleanup():
              # Cleanup is handled by test fixtures, but we can add
              # additional cleanup here if needed
              print('Test cleanup completed')

          asyncio.run(cleanup())
          "
        continue-on-error: true

  notify:
    name: Notify on Failure
    runs-on: ubuntu-latest
    needs: e2e
    if: failure()

    steps:
      - name: Send failure notification
        run: |
          echo "E2E tests failed - check the workflow run for details"
          echo "Run ID: ${{ github.run_id }}"
          echo "Triggered by: ${{ github.actor }}"
          # Add Slack/email notification here if configured
