<!DOCTYPE html>
<html lang="en" class="h-full">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Chaos Testing - Sentiment Analyzer</title>

    <!-- HTMX - Self-hosted (14KB) -->
    <script src="/static/vendor/htmx.min.js"></script>

    <!-- Alpine.js - Self-hosted (44KB) -->
    <script defer src="/static/vendor/alpine.min.js"></script>

    <!-- Tailwind CSS + DaisyUI -->
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdn.jsdelivr.net/npm/daisyui@4.12.14/dist/full.min.css" rel="stylesheet">

    <style>
        .pulse-dot {
            animation: pulse 2s cubic-bezier(0.4, 0, 0.6, 1) infinite;
        }
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }
    </style>
</head>
<body class="h-full bg-base-200" x-data="chaosApp()">
    <!-- Navigation Bar -->
    <div class="navbar bg-primary text-primary-content shadow-lg">
        <div class="flex-1">
            <a href="/" class="btn btn-ghost normal-case text-xl">Sentiment Analyzer</a>
            <span class="ml-4 text-sm opacity-75">Chaos Testing</span>
        </div>
        <div class="flex-none gap-2">
            <!-- Environment Badge -->
            <div class="badge badge-warning gap-2">
                <span>PREPROD</span>
            </div>
            <!-- Back to Dashboard -->
            <a href="/" class="btn btn-ghost btn-sm">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 12l2-2m0 0l7-7 7 7M5 10v10a1 1 0 001 1h3m10-11l2 2m-2-2v10a1 1 0 01-1 1h-3m-6 0a1 1 0 001-1v-4a1 1 0 011-1h2a1 1 0 011 1v4a1 1 0 001 1m-6 0h6" />
                </svg>
                Dashboard
            </a>
        </div>
    </div>

    <div class="container mx-auto p-4 max-w-7xl">
        <!-- Alert Banner -->
        <div class="alert alert-warning shadow-lg mb-6">
            <svg xmlns="http://www.w3.org/2000/svg" class="stroke-current flex-shrink-0 h-6 w-6" fill="none" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z" />
            </svg>
            <div>
                <h3 class="font-bold">Chaos Testing Environment</h3>
                <div class="text-sm">Experiments only run in preprod/dev/test. Safety mechanisms: time limits, blast radius controls, alarm kill switches.</div>
            </div>
        </div>

        <!-- Scenario Library -->
        <section class="mb-8">
            <h2 class="text-2xl font-bold mb-4">Chaos Scenarios</h2>
            <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                <!-- DynamoDB Throttle -->
                <div class="card bg-base-100 shadow-xl hover:shadow-2xl transition-shadow cursor-pointer"
                     @click="selectScenario('dynamodb_throttle')">
                    <div class="card-body">
                        <h3 class="card-title text-error">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 7v10c0 2.21 3.582 4 8 4s8-1.79 8-4V7M4 7c0 2.21 3.582 4 8 4s8-1.79 8-4M4 7c0-2.21 3.582-4 8-4s8 1.79 8 4" />
                            </svg>
                            DynamoDB Throttle
                        </h3>
                        <p class="text-sm opacity-75">Inject write throttling to test backpressure handling</p>
                        <div class="card-actions justify-end mt-2">
                            <div class="badge badge-outline">Phase 2</div>
                            <div class="badge badge-error badge-outline">AWS FIS</div>
                        </div>
                    </div>
                </div>

                <!-- NewsAPI Failure -->
                <div class="card bg-base-100 shadow-xl hover:shadow-2xl transition-shadow cursor-pointer"
                     @click="selectScenario('newsapi_failure')">
                    <div class="card-body">
                        <h3 class="card-title text-warning">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
                            </svg>
                            NewsAPI Failure
                        </h3>
                        <p class="text-sm opacity-75">Simulate external API unavailability</p>
                        <div class="card-actions justify-end mt-2">
                            <div class="badge badge-outline">Phase 3</div>
                            <div class="badge badge-warning badge-outline">Custom</div>
                        </div>
                    </div>
                </div>

                <!-- Lambda Cold Start -->
                <div class="card bg-base-100 shadow-xl hover:shadow-2xl transition-shadow cursor-pointer"
                     @click="selectScenario('lambda_cold_start')">
                    <div class="card-body">
                        <h3 class="card-title text-info">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z" />
                            </svg>
                            Lambda Delay
                        </h3>
                        <p class="text-sm opacity-75">Inject artificial latency to test timeout handling</p>
                        <div class="card-actions justify-end mt-2">
                            <div class="badge badge-outline">Phase 4</div>
                            <div class="badge badge-info badge-outline">Injection</div>
                        </div>
                    </div>
                </div>
            </div>
        </section>

        <!-- Start Experiment Form -->
        <section class="mb-8" x-show="selectedScenario" x-transition>
            <div class="card bg-base-100 shadow-xl">
                <div class="card-body">
                    <h2 class="card-title">Start Chaos Experiment</h2>

                    <form @submit.prevent="startExperiment">
                        <!-- Scenario Display -->
                        <div class="form-control mb-4">
                            <label class="label">
                                <span class="label-text font-bold">Scenario</span>
                            </label>
                            <div class="badge badge-lg" x-text="scenarioNames[selectedScenario]"></div>
                        </div>

                        <!-- Blast Radius Slider -->
                        <div class="form-control mb-4">
                            <label class="label">
                                <span class="label-text font-bold">Blast Radius</span>
                                <span class="label-text-alt" x-text="blastRadius + '%'"></span>
                            </label>
                            <input type="range" min="10" max="100" x-model="blastRadius" class="range range-error" step="10">
                            <div class="w-full flex justify-between text-xs px-2 mt-2">
                                <span>10%</span>
                                <span>25%</span>
                                <span>50%</span>
                                <span>75%</span>
                                <span>100%</span>
                            </div>
                            <p class="text-sm opacity-75 mt-2">Percentage of requests affected by the fault injection</p>
                        </div>

                        <!-- Duration Input -->
                        <div class="form-control mb-4">
                            <label class="label">
                                <span class="label-text font-bold">Duration (seconds)</span>
                            </label>
                            <input type="number" min="5" max="300" x-model="duration" class="input input-bordered w-full" placeholder="60">
                            <label class="label">
                                <span class="label-text-alt">Min: 5s, Max: 300s (5 minutes)</span>
                            </label>
                        </div>

                        <!-- Action Buttons -->
                        <div class="card-actions justify-end">
                            <button type="button" class="btn btn-ghost" @click="selectedScenario = null">Cancel</button>
                            <button type="submit" class="btn btn-error" :disabled="loading">
                                <span x-show="!loading">Start Experiment</span>
                                <span x-show="loading" class="loading loading-spinner"></span>
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </section>

        <!-- Active Experiments -->
        <section class="mb-8" x-show="activeExperiments.length > 0">
            <h2 class="text-2xl font-bold mb-4">Active Experiments</h2>
            <div class="space-y-4">
                <template x-for="exp in activeExperiments" :key="exp.experiment_id">
                    <div class="card bg-base-100 shadow-xl">
                        <div class="card-body">
                            <div class="flex justify-between items-start">
                                <div class="flex-1">
                                    <h3 class="card-title" x-text="scenarioNames[exp.scenario_type]"></h3>
                                    <p class="text-sm opacity-75">
                                        Started: <span x-text="formatTime(exp.created_at)"></span>
                                    </p>
                                    <div class="flex gap-2 mt-2">
                                        <div class="badge badge-error">
                                            <span x-text="exp.blast_radius + '% blast radius'"></span>
                                        </div>
                                        <div class="badge badge-outline">
                                            <span x-text="exp.duration_seconds + 's duration'"></span>
                                        </div>
                                    </div>
                                    <!-- FIS Status (Phase 2.2) -->
                                    <div x-show="exp.fis_status" class="mt-3 p-2 bg-base-300 rounded">
                                        <div class="text-xs font-semibold opacity-75 mb-1">FIS Experiment Status</div>
                                        <div class="flex gap-2 items-center text-sm">
                                            <div class="badge badge-xs" :class="{
                                                'badge-success': exp.fis_status?.state === 'running',
                                                'badge-warning': exp.fis_status?.state === 'initiating',
                                                'badge-error': exp.fis_status?.state === 'failed',
                                                'badge-info': exp.fis_status?.state === 'completed'
                                            }" x-text="exp.fis_status?.state"></div>
                                            <span class="opacity-75" x-show="exp.fis_status?.reason" x-text="exp.fis_status?.reason"></span>
                                        </div>
                                        <div class="text-xs opacity-60 mt-1" x-show="exp.fis_status?.id">
                                            FIS ID: <span x-text="exp.fis_status?.id"></span>
                                        </div>
                                    </div>
                                </div>
                                <div class="flex flex-col items-end gap-2">
                                    <div class="badge badge-success gap-2">
                                        <span class="w-2 h-2 bg-white rounded-full pulse-dot"></span>
                                        <span x-text="exp.status"></span>
                                    </div>
                                    <button class="btn btn-sm btn-error"
                                            @click="stopExperiment(exp.experiment_id)"
                                            :disabled="stoppingExperimentId === exp.experiment_id">
                                        <span x-show="stoppingExperimentId !== exp.experiment_id">Stop</span>
                                        <span x-show="stoppingExperimentId === exp.experiment_id" class="loading loading-spinner loading-xs"></span>
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </template>
            </div>
        </section>

        <!-- Experiment History -->
        <section>
            <h2 class="text-2xl font-bold mb-4">Experiment History</h2>
            <div class="overflow-x-auto">
                <table class="table table-zebra w-full">
                    <thead>
                        <tr>
                            <th>Time</th>
                            <th>Scenario</th>
                            <th>Status</th>
                            <th>Blast Radius</th>
                            <th>Duration</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        <!-- Loading skeleton -->
                        <template x-if="loadingExperiments">
                            <tr>
                                <td colspan="6" class="text-center py-8">
                                    <span class="loading loading-spinner loading-lg"></span>
                                    <p class="mt-2 opacity-75">Loading experiments...</p>
                                </td>
                            </tr>
                        </template>

                        <!-- Experiment list -->
                        <template x-if="!loadingExperiments">
                            <template>
                                <template x-for="exp in historyExperiments" :key="exp.experiment_id">
                                    <tr>
                                        <td x-text="formatTime(exp.created_at)"></td>
                                        <td x-text="scenarioNames[exp.scenario_type]"></td>
                                        <td>
                                            <div class="badge" :class="{
                                                'badge-success': exp.status === 'completed',
                                                'badge-error': exp.status === 'failed',
                                                'badge-warning': exp.status === 'stopped'
                                            }" x-text="exp.status"></div>
                                        </td>
                                        <td x-text="exp.blast_radius + '%'"></td>
                                        <td x-text="exp.duration_seconds + 's'"></td>
                                        <td>
                                            <button class="btn btn-ghost btn-xs" @click="viewExperiment(exp.experiment_id)">
                                                Details
                                            </button>
                                        </td>
                                    </tr>
                                </template>
                                <tr x-show="historyExperiments.length === 0">
                                    <td colspan="6" class="text-center opacity-75">No experiments yet. Start your first chaos test above!</td>
                                </tr>
                            </template>
                        </template>
                    </tbody>
                </table>
            </div>
        </section>
    </div>

    <!-- Alpine.js App Logic -->
    <script>
        function chaosApp() {
            return {
                // State
                selectedScenario: null,
                blastRadius: 25,
                duration: 60,
                loading: false,
                loadingExperiments: true,
                stoppingExperimentId: null,
                experiments: [],

                // Computed
                get activeExperiments() {
                    return this.experiments.filter(e => e.status === 'running' || e.status === 'pending');
                },
                get historyExperiments() {
                    return this.experiments.filter(e => e.status === 'completed' || e.status === 'failed' || e.status === 'stopped');
                },

                // Constants
                scenarioNames: {
                    'dynamodb_throttle': 'DynamoDB Throttle',
                    'newsapi_failure': 'NewsAPI Failure',
                    'lambda_cold_start': 'Lambda Cold Start'
                },

                // Initialization
                async init() {
                    await this.loadExperiments();
                    // Auto-refresh every 10 seconds
                    setInterval(() => this.loadExperiments(), 10000);
                },

                // Methods
                selectScenario(scenario) {
                    this.selectedScenario = scenario;
                },

                async startExperiment() {
                    this.loading = true;
                    try {
                        const response = await fetch('/chaos/experiments', {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                                'X-API-Key': this.getApiKey()
                            },
                            body: JSON.stringify({
                                scenario_type: this.selectedScenario,
                                blast_radius: parseInt(this.blastRadius),
                                duration_seconds: parseInt(this.duration)
                            })
                        });

                        if (!response.ok) {
                            const error = await response.json();
                            throw new Error(error.detail || 'Failed to create experiment');
                        }

                        const experiment = await response.json();

                        // Start the experiment
                        const startResponse = await fetch(`/chaos/experiments/${experiment.experiment_id}/start`, {
                            method: 'POST',
                            headers: {
                                'X-API-Key': this.getApiKey()
                            }
                        });

                        if (!startResponse.ok) {
                            throw new Error('Failed to start experiment');
                        }

                        // Reset form
                        this.selectedScenario = null;
                        this.blastRadius = 25;
                        this.duration = 60;

                        // Reload experiments
                        await this.loadExperiments();

                        alert('Chaos experiment started successfully!');
                    } catch (error) {
                        alert('Error: ' + error.message);
                    } finally {
                        this.loading = false;
                    }
                },

                async stopExperiment(experimentId) {
                    if (!confirm('Are you sure you want to stop this experiment?')) {
                        return;
                    }

                    this.stoppingExperimentId = experimentId;
                    try {
                        const response = await fetch(`/chaos/experiments/${experimentId}/stop`, {
                            method: 'POST',
                            headers: {
                                'X-API-Key': this.getApiKey()
                            }
                        });

                        if (!response.ok) {
                            throw new Error('Failed to stop experiment');
                        }

                        await this.loadExperiments();
                        alert('Experiment stopped successfully');
                    } catch (error) {
                        alert('Error: ' + error.message);
                    } finally {
                        this.stoppingExperimentId = null;
                    }
                },

                async loadExperiments() {
                    this.loadingExperiments = true;
                    try {
                        const response = await fetch('/chaos/experiments?limit=50', {
                            headers: {
                                'X-API-Key': this.getApiKey()
                            }
                        });

                        if (response.ok) {
                            const experiments = await response.json();

                            // Phase 2.2: Enrich running experiments with detailed status (includes FIS)
                            for (let exp of experiments) {
                                if (exp.status === 'running') {
                                    try {
                                        const detailResponse = await fetch(`/chaos/experiments/${exp.experiment_id}`, {
                                            headers: {
                                                'X-API-Key': this.getApiKey()
                                            }
                                        });

                                        if (detailResponse.ok) {
                                            const detailedExp = await detailResponse.json();
                                            // Merge FIS status into experiment
                                            exp.fis_status = detailedExp.fis_status;
                                        }
                                    } catch (err) {
                                        console.error(`Failed to fetch details for experiment ${exp.experiment_id}:`, err);
                                    }
                                }
                            }

                            this.experiments = experiments;
                        }
                    } catch (error) {
                        console.error('Failed to load experiments:', error);
                    } finally {
                        this.loadingExperiments = false;
                    }
                },

                viewExperiment(experimentId) {
                    // TODO: Implement experiment details modal
                    alert('Experiment details coming in Phase 2! ID: ' + experimentId);
                },

                formatTime(isoString) {
                    return new Date(isoString).toLocaleString();
                },

                getApiKey() {
                    // API key is injected by config.js
                    return window.API_KEY || '';
                }
            }
        }
    </script>
</body>
</html>
