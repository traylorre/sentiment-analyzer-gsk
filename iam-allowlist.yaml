# IAM Allowlist for Sentiment Analyzer GSK
# Follows 034-allowlist-architecture pattern from template methodology
#
# Classification:
#   - runtime: Active exemption, synced to validators
#   - documentation: Reference only, not synced to runtime validators
#
# Context requirements can make exemptions conditional on policy context

version: "1.0"
last_updated: "2025-12-08"

patterns:
  # CI/CD Lambda deployment - requires CreateFunction + PassRole
  # PassRole is scoped to specific role patterns, mitigating privilege escalation
  - id: lambda-cicd-deployment
    pattern: "lambda:CreateFunction.*iam:PassRole"
    classification: runtime
    finding_ids:
      - LAMBDA-007
    justification: >
      CI/CD pipelines legitimately require lambda:CreateFunction + iam:PassRole for Lambda deployments.
      Privilege escalation risk is mitigated by PassRole resource constraint limited to:
      arn:aws:iam::*:role/{env}-* (environment-prefixed roles only).
      This follows AWS CI/CD best practices for automated deployments.
    canonical_source: "https://docs.aws.amazon.com/prescriptive-guidance/latest/strategy-cicd-litmus/cicd-best-practices.html"
    context_required:
      passrole_scoped: true

  # CI/CD Event Source Mapping - requires CreateEventSourceMapping + PassRole
  - id: lambda-event-source-mapping
    pattern: "lambda:CreateEventSourceMapping.*iam:PassRole"
    classification: runtime
    finding_ids:
      - LAMBDA-011
    justification: >
      Event-driven architectures require lambda:CreateEventSourceMapping + iam:PassRole for
      connecting Lambda functions to SQS/DynamoDB/Kinesis triggers. PassRole scope is restricted
      to arn:aws:iam::*:role/{env}-* (environment-prefixed roles only).
    canonical_source: "https://docs.aws.amazon.com/lambda/latest/dg/access-control-resource-based.html"
    context_required:
      passrole_scoped: true

  # Dev/Preprod sqs:DeleteQueue - required for terraform destroy testing
  - id: dev-preprod-sqs-delete
    pattern: "sqs:DeleteQueue"
    classification: runtime
    finding_ids:
      - SQS-009
    justification: >
      Dev and preprod CI deployers require sqs:DeleteQueue for terraform destroy operations
      during infrastructure testing. Per AWS CI/CD and OWASP best practices, non-prod
      environments have broader permissions for testing while prod has restrictive permissions.
      Prod CI deployer does NOT have this permission - prod destroy requires break-glass.
    canonical_source: "https://cheatsheetseries.owasp.org/cheatsheets/CI_CD_Security_Cheat_Sheet.html"
    context_required:
      environment:
        - dev
        - preprod

  # CI User Policy sqs:DeleteQueue - CI/CD policies manage multiple environments
  - id: ci-user-sqs-delete
    pattern: "sqs:DeleteQueue"
    classification: runtime
    finding_ids:
      - SQS-009
    justification: >
      CI/CD user policies (ci-user-policy.tf) require sqs:DeleteQueue for terraform destroy
      operations across dev and preprod environments. The permission is scoped to *-sentiment-*
      queue patterns, preventing accidental deletion of production queues.
      Prod destroy requires separate break-glass access.
    canonical_source: "https://cheatsheetseries.owasp.org/cheatsheets/CI_CD_Security_Cheat_Sheet.html"
    context_required:
      ci_policy: true

  # CloudFront cache policy read operations - AWS service limitation
  # These actions do NOT support resource-level permissions per AWS Service Authorization Reference
  - id: cloudfront-cache-policy-read
    pattern: "cloudfront:(GetCachePolicy|GetOriginRequestPolicy|ListCachePolicies|ListOriginRequestPolicies)"
    classification: runtime
    finding_ids:
      - IAM-002
    justification: >
      CloudFront GetCachePolicy, GetOriginRequestPolicy, ListCachePolicies, and
      ListOriginRequestPolicies do NOT support resource-level permissions per AWS
      Service Authorization Reference. Wildcard Resource "*" is required.
    canonical_source: "https://docs.aws.amazon.com/service-authorization/latest/reference/list_amazoncloudfront.html"
    context_required:
      aws_limitation: true

paths:
  # Test fixtures may contain intentional policy violations
  - pattern: "tests/fixtures/.*"
    justification: "Test fixtures may contain intentional policy violations for testing"

  # Terraform provider cache
  - pattern: "\\.terraform/.*"
    justification: "Terraform provider cache - auto-generated, not user code"
